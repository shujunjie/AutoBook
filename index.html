<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>AI éšæ‰‹è®°</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        art: {
                            bg: '#000000',      // çº¯é»‘èƒŒæ™¯
                            card: '#121212',    // ææ·±ç°å¡ç‰‡
                            cardLight: '#1E1E1E',
                            accent: '#4ADE80',  // ç»¿è‰²/é’è‰²ç‚¹ç¼€ (æ”¯å‡ºé€šå¸¸ç”¨çº¢/ç»¿ï¼Œè¿™é‡Œæ¨¡ä»¿æˆªå›¾çš„å†·è‰²è°ƒ)
                            textMain: '#FFFFFF',
                            textSub: '#8E8E93',
                            border: '#2C2C2E',
                        }
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>

    <style>
        ::-webkit-scrollbar { display: none; }
        
        body {
            background-color: #000000;
            color: #FFFFFF;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 44px); }
        input:focus, textarea:focus { outline: none; }

        .ios-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .page-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            background-color: #000000;
            z-index: 50;
            -webkit-overflow-scrolling: touch;
        }
        .page-enter { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { 
            Home, PieChart, Plus, X, Loader2, Save, Trash2, 
            CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Search, 
            Utensils, Car, ShoppingBag, Gamepad2, Home as HomeIcon, 
            HeartPulse, Banknote, FileText, TrendingUp, Calendar, 
            LayoutGrid, ArrowLeft, Video, MessageCircle, Wallet, ChevronDown, Layers,
            Users, Settings // Added missing imports
        } from 'lucide-react';
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, isSameDay, format } from 'date-fns';

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatMoney = (amount) => Math.abs(Number(amount)).toFixed(2);
        
        const haptic = (type = 'light') => {
            if (window.navigator && window.navigator.vibrate) {
                if (type === 'light') window.navigator.vibrate(10);
                else window.navigator.vibrate(20);
            }
        };

        const getCategoryIcon = (category) => {
            const size = 18;
            switch (category) {
                case 'é¤é¥®': return <Utensils size={size} />;
                case 'äº¤é€š': return <Car size={size} />;
                case 'è´­ç‰©': return <ShoppingBag size={size} />;
                case 'å¨±ä¹': return <Gamepad2 size={size} />;
                case 'å±…ä½': return <HomeIcon size={size} />;
                case 'åŒ»ç–—': return <HeartPulse size={size} />;
                case 'å·¥èµ„': return <Banknote size={size} />;
                default: return <FileText size={size} />;
            }
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case 'é¤é¥®': return { bg: 'bg-[#FF9F0A]/20', text: 'text-[#FF9F0A]' }; 
                case 'äº¤é€š': return { bg: 'bg-[#0A84FF]/20', text: 'text-[#0A84FF]' }; 
                case 'è´­ç‰©': return { bg: 'bg-[#FF375F]/20', text: 'text-[#FF375F]' }; 
                case 'å¨±ä¹': return { bg: 'bg-[#BF5AF2]/20', text: 'text-[#BF5AF2]' }; 
                case 'å±…ä½': return { bg: 'bg-[#64D2FF]/20', text: 'text-[#64D2FF]' }; 
                case 'åŒ»ç–—': return { bg: 'bg-[#FF453A]/20', text: 'text-[#FF453A]' }; 
                case 'å·¥èµ„': return { bg: 'bg-[#30D158]/20', text: 'text-[#30D158]' }; 
                default: return { bg: 'bg-[#8E8E93]/20', text: 'text-[#8E8E93]' };    
            }
        };

        const Toast = ({ message }) => {
            if (!message) return null;
            return (
                <div className="fixed top-safe left-1/2 -translate-x-1/2 z-[100] mt-4 animate-fade-in pointer-events-none">
                    <div className="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#333] shadow-xl border border-white/10">
                        <CheckCircle size={16} className="text-[#30D158]" />
                        <span className="text-[13px] font-medium text-white">{message}</span>
                    </div>
                </div>
            );
        };

        // --- ğŸ“Š Mini Line Chart (For Dashboard) ---
        const MiniLineChart = ({ data }) => {
            const maxVal = Math.max(...data.map(d => d.value), 100);
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - (d.value / maxVal) * 80; // Keep in bottom area
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-full relative">
                    <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                        <defs>
                            <linearGradient id="miniGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#2E5CFF" stopOpacity="0.3" />
                                <stop offset="100%" stopColor="#2E5CFF" stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        <path d={`M 0,100 L ${points.split(' ').map(p => `L ${p.replace(',', ' ')}`).join(' ')} L 100,100 Z`} fill="url(#miniGradient)" />
                        <polyline points={points} fill="none" stroke="#2E5CFF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke"/>
                        <line x1="0" y1="50" x2="100" y2="50" stroke="rgba(255,255,255,0.1)" strokeWidth="0.5" strokeDasharray="3 3" vectorEffect="non-scaling-stroke" />
                    </svg>
                </div>
            );
        };

        // --- Pages ---

        // 1. Period Detail Page (Refined Header)
        const PeriodPage = ({ title, type, total, allTransactions, onClose }) => {
            const list = useMemo(() => {
                const now = new Date();
                let range;
                if (type === 'today') range = { start: new Date(now.setHours(0,0,0,0)), end: new Date(now.setHours(23,59,59,999)) };
                else if (type === 'week') range = { start: startOfWeek(new Date(), { weekStartsOn: 1 }), end: endOfWeek(new Date(), { weekStartsOn: 1 }) };
                else if (type === 'year') range = { start: startOfYear(new Date()), end: endOfYear(new Date()) };
                else return [];

                return allTransactions.filter(t => { 
                    const d = new Date(t.date); 
                    return d >= range.start && d <= range.end; 
                }).sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [type, allTransactions]);

            const grouped = useMemo(() => {
                const g = {};
                list.forEach(t => {
                    const d = new Date(t.date).toLocaleDateString();
                    if(!g[d]) g[d] = [];
                    g[d].push(t);
                });
                return g;
            }, [list]);

            return (
                <div className="page-container page-enter pb-safe flex flex-col z-[100] bg-[#000000]">
                    {/* Artistic Header Image */}
                    <div className="relative h-[280px] w-full overflow-hidden shrink-0">
                        <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-[#000000]"></div>
                        
                        {/* NavBar inside Header (Unified) */}
                        <div className="absolute top-0 left-0 right-0 pt-safe px-4 h-[100px] flex items-start justify-between z-20">
                            <button onClick={onClose} className="p-2 -ml-2 text-white flex items-center gap-1 active:opacity-60 transition-opacity">
                                <ArrowLeft size={24} /> 
                                {/* é¡¶éƒ¨æ ‡é¢˜ç›´æ¥å¸¦ä¸Šæ—¥æœŸ */}
                                <span className="text-[18px] font-medium tracking-wide">{title}</span>
                            </button>
                            <button onClick={() => {}} className="p-2 text-white/90 active:opacity-60"><Plus size={26} /></button>
                        </div>

                        {/* Summary Data */}
                        <div className="absolute bottom-6 left-6 z-20">
                            {/* Main Amount */}
                            <div className="text-[48px] font-bold text-white font-mono tracking-tighter leading-none -ml-1 mb-2">-{formatMoney(total)}</div>
                            
                            {/* Stats Row (Income | Expense) */}
                            <div className="flex items-center gap-4 text-[13px] text-white/80 font-medium bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-lg border border-white/10 w-fit">
                                <span>ç»“ä½™ -{formatMoney(total)}</span>
                                <div className="w-[1px] h-3 bg-white/30"></div>
                                <span className="opacity-70">æ”¶å…¥ 0.00</span>
                                <div className="w-[1px] h-3 bg-white/30"></div>
                                <span className="opacity-70">æ”¯å‡º {formatMoney(total)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Content Body */}
                    <div className="flex-1 px-4 -mt-4 relative z-30">
                        <div className="bg-[#121212] rounded-t-[24px] min-h-full border-t border-[#2C2C2E] p-4 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                            <div className="flex justify-between items-center mb-5 px-1 pt-1">
                                <span className="text-[13px] text-art-textSub font-medium">å·²ç­›é€‰ï¼Œå½“å‰åªå±•ç¤ºéƒ¨åˆ†æµæ°´</span>
                                <span className="text-[13px] text-art-accent flex items-center gap-1">æŸ¥çœ‹å…¨éƒ¨ <ChevronRight size={14}/></span>
                            </div>

                            {/* List */}
                            <div className="space-y-6">
                                {Object.entries(grouped).length === 0 ? (
                                    <div className="text-center py-20 text-art-textSub opacity-50 flex flex-col items-center">
                                        <div className="text-4xl mb-3">ğŸƒ</div>
                                        <div className="text-[15px]">æš‚æ— è®°å½•</div>
                                    </div>
                                ) : (
                                    Object.entries(grouped).map(([date, items]) => (
                                        <div key={date}>
                                            <div className="text-[13px] text-art-textSub font-bold mb-3 ml-1 uppercase tracking-wide">{date}</div>
                                            <div className="space-y-3">
                                                {items.map((t, idx) => (
                                                    <div key={t.id} className="flex items-start gap-4 p-2 rounded-xl active:bg-white/5 transition-colors -mx-2">
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 mt-0.5 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text}`}>
                                                            {getCategoryIcon(t.category)}
                                                        </div>
                                                        <div className="flex-1 border-b border-[#2C2C2E] pb-3.5">
                                                            <div className="flex justify-between items-start mb-1">
                                                                <span className="text-[16px] font-medium text-white">{t.merchant || t.category}</span>
                                                                <span className="text-[17px] font-bold font-mono text-art-accent">-{formatMoney(t.amount)}</span>
                                                            </div>
                                                            <div className="text-[12px] text-art-textSub flex items-center gap-2">
                                                                <span className="px-1.5 py-0.5 rounded-md bg-white/5">{t.category}</span>
                                                                <span>{t.date.split('T')[1].substring(0,5)}</span>
                                                                {t.note && <span>Â· {t.note}</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EditorPage = ({ transaction, onClose, onSave, onDelete }) => {
            const [form, setForm] = useState({ 
                amount: transaction ? Math.abs(transaction.amount) : '', 
                merchant: transaction ? transaction.merchant : '', 
                category: transaction ? transaction.category : 'é¤é¥®', 
                date: transaction ? transaction.date.split('T')[0] : new Date().toISOString().split('T')[0], 
                note: transaction ? (transaction.note || '') : '' 
            });
            const [loading, setLoading] = useState(false);
            const categories = ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹', 'å±…ä½', 'åŒ»ç–—', 'å·¥èµ„', 'å…¶ä»–'];

            const handleSave = async () => {
                if (!form.amount) return;
                setLoading(true);
                await onSave(form, transaction?.id);
                setLoading(false);
            };

            return (
                <div className="page-container page-enter pb-safe flex flex-col z-[100] bg-art-bg ios-scroll">
                    <div className="glass-nav pt-safe flex justify-between items-center px-4 h-[44px]">
                        <button onClick={onClose} className="text-art-textSub text-[15px]">å–æ¶ˆ</button>
                        <h3 className="font-bold text-[17px] text-white">{transaction ? 'ç¼–è¾‘' : 'è®°ä¸€ç¬”'}</h3>
                        <button onClick={handleSave} className="text-art-accent font-bold text-[15px]">ä¿å­˜</button>
                    </div>
                    
                    <div className="p-4 flex-1 overflow-y-auto ios-scroll">
                         <div className="bg-art-card rounded-[20px] px-5 py-4 flex items-center mt-2 border border-art-border focus-within:ring-2 focus-within:ring-art-accent/20 transition-all shadow-sm mb-6">
                            <span className="text-[24px] text-art-textSub mr-2 font-light">Â¥</span>
                            <input type="number" value={form.amount} onChange={(e) => setForm({...form, amount: e.target.value})} placeholder="0.00" className="w-full bg-transparent text-[32px] font-bold text-white placeholder-gray-600 h-[40px] font-mono" autoFocus={!transaction} />
                        </div>

                        <h4 className="text-[13px] text-art-textSub font-medium mb-3 ml-1 uppercase">åˆ†ç±»</h4>
                        <div className="grid grid-cols-4 gap-3 mb-6">
                            {categories.map(cat => {
                                const color = getCategoryColor(cat);
                                const isSelected = form.category === cat;
                                return (
                                    <button key={cat} onClick={() => {setForm({...form, category: cat}); haptic('light');}} className={`flex flex-col items-center justify-center py-3 rounded-[18px] transition-all active:scale-95 duration-200 border ${isSelected ? `bg-white text-black shadow-lg` : 'bg-art-card border-art-border hover:opacity-80'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center mb-1.5 ${isSelected ? 'text-art-accent bg-black' : color.text}`}>
                                            {getCategoryIcon(cat)}
                                        </div>
                                        <span className={`text-[11px] font-bold ${isSelected ? 'text-black' : 'text-art-textSub'}`}>{cat}</span>
                                    </button>
                                );
                            })}
                        </div>

                        <h4 className="text-[13px] text-art-textSub font-medium mb-3 ml-1 uppercase">è¯¦æƒ…</h4>
                        <div className="bg-art-card rounded-2xl border border-art-border overflow-hidden mb-6">
                            <div className="flex items-center px-4 py-3 border-b border-art-border">
                                <span className="w-16 text-[15px] text-art-textSub">å•†æˆ·</span>
                                <input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} placeholder="é€‰å¡«" className="flex-1 bg-transparent text-[15px] text-white focus:outline-none" />
                            </div>
                            <div className="flex items-center px-4 py-3 border-b border-art-border">
                                <span className="w-16 text-[15px] text-art-textSub">æ—¥æœŸ</span>
                                <input type="date" value={form.date} onChange={(e) => setForm({...form, date: e.target.value})} className="flex-1 bg-transparent text-[15px] text-white focus:outline-none" />
                            </div>
                            <div className="flex items-center px-4 py-3">
                                <span className="w-16 text-[15px] text-art-textSub">å¤‡æ³¨</span>
                                <input type="text" value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} placeholder="é€‰å¡«" className="flex-1 bg-transparent text-[15px] text-white focus:outline-none" />
                            </div>
                        </div>

                        {transaction && (
                            <button onClick={() => onDelete(transaction.id)} className="w-full py-3.5 rounded-xl text-red-500 bg-art-cardLight font-medium text-[15px] mb-8">
                                åˆ é™¤è®°å½•
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App ---

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [currentTransaction, setCurrentTransaction] = useState(null); 
            const [toast, setToast] = useState(null);
            
            const [view, setView] = useState({ name: 'main' }); // Router
            
            const [pullY, setPullY] = useState(0);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const startY = useRef(0);
            
            const [form, setForm] = useState({ amount: '', merchant: '', category: 'é¤é¥®', date: new Date().toISOString().split('T')[0], note: '' });
            const categories = ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹', 'å±…ä½', 'åŒ»ç–—', 'å·¥èµ„', 'å…¶ä»–'];

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2000); };

            useEffect(() => {
                fetchTransactions();
                const sub = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, fetchTransactions).subscribe();
                return () => supabase.removeChannel(sub);
            }, [currentDate]);

            const fetchTransactions = async () => {
                if (!isRefreshing) setLoading(true);
                const start = startOfYear(currentDate);
                const end = endOfYear(currentDate);
                const { data, error } = await supabase.from('transactions').select('*').gte('date', start.toISOString()).lte('date', end.toISOString()).order('date', { ascending: false });
                if (!error) setTransactions(data || []);
                setLoading(false);
            };

            const handleTouchStart = (e) => { if (window.scrollY === 0) startY.current = e.touches[0].clientY; };
            const handleTouchMove = (e) => {
                const delta = e.touches[0].clientY - startY.current;
                if (window.scrollY === 0 && delta > 0) setPullY(delta * 0.4);
            };
            const handleTouchEnd = async () => {
                if (pullY > 60) {
                    setIsRefreshing(true); setPullY(60); haptic();
                    await fetchTransactions(); haptic(); setIsRefreshing(false); setPullY(0);
                } else setPullY(0);
            };

            const handleSave = async (isEdit = false) => {
                if (!form.amount) return;
                setLoading(true);
                const payload = { amount: parseFloat(form.amount), merchant: form.merchant || (form.category), category: form.category, date: new Date(form.date).toISOString(), note: form.note };
                if (isEdit) await supabase.from('transactions').update(payload).eq('id', currentTransaction.id);
                else await supabase.from('transactions').insert([payload]);
                showToast(isEdit ? "å·²æ›´æ–°" : "è®°è´¦æˆåŠŸ");
                setIsAddModalOpen(false); setIsEditModalOpen(false);
                if (!isEdit) setForm({ ...form, amount: '', merchant: '', note: '' });
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                await supabase.from('transactions').delete().eq('id', id);
                showToast("å·²åˆ é™¤");
                setTransactions(p => p.filter(t => t.id !== id));
            };

            const stats = useMemo(() => {
                const now = new Date();
                const dayRange = { start: new Date(now.setHours(0,0,0,0)), end: new Date(now.setHours(23,59,59,999)) };
                const weekRange = { start: startOfWeek(new Date(), { weekStartsOn: 1 }), end: endOfWeek(new Date(), { weekStartsOn: 1 }) };
                const monthRange = { start: startOfMonth(currentDate), end: endOfMonth(currentDate) };
                const yearRange = { start: startOfYear(currentDate), end: endOfYear(currentDate) };
                const calc = (range) => transactions.filter(t => new Date(t.date) >= range.start && new Date(t.date) <= range.end).reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);
                const monthTotal = calc(monthRange);
                const todayTotal = calc(dayRange);
                const weekTotal = calc(weekRange);
                const yearTotal = calc(yearRange);
                
                const trend = [];
                const daysInMonth = monthRange.end.getDate();
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    const dayVal = transactions.filter(t => isSameDay(new Date(t.date), d)).reduce((s,t) => s + Math.abs(Number(t.amount)), 0);
                    trend.push({ value: dayVal, date: d });
                }
                return { monthTotal, todayTotal, weekTotal, yearTotal, trend };
            }, [transactions, currentDate]);

            // Grouped list for Flow view
            const groupedTransactions = useMemo(() => {
                const groups = {};
                transactions.forEach(t => {
                    const date = new Date(t.date);
                    const today = new Date();
                    let header = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                    if (date.toDateString() === today.toDateString()) header = "ä»Šå¤©";
                    else if (date.toDateString() === new Date(today.setDate(today.getDate()-1)).toDateString()) header = "æ˜¨å¤©";
                    const weekDay = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][date.getDay()];
                    if (header !== "ä»Šå¤©" && header !== "æ˜¨å¤©") header += ` ${weekDay}`;
                    if (!groups[header]) groups[header] = { total: 0, items: [] };
                    groups[header].items.push(t);
                    groups[header].total += Math.abs(Number(t.amount));
                });
                return groups;
            }, [transactions]);

            if (view.name === 'editor') return <EditorPage transaction={view.transaction} onClose={()=>setView({name:'main'})} onSave={handleSave} onDelete={handleDelete} />;
            // ğŸ†• Updated Period Page with Dynamic Title (Date Range)
            if (view.name === 'period') return <PeriodPage title={view.title} type={view.type} total={view.total} allTransactions={transactions} onClose={()=>setView({name:'main'})} />;

            return (
                <div className="min-h-full bg-art-bg text-art-textMain font-sans pb-safe selection:bg-art-accent selection:text-black" 
                     onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <Toast message={toast} />
                    <div className="fixed top-[60px] left-0 w-full flex justify-center pointer-events-none z-[100] transition-opacity duration-300" style={{ transform: `translateY(${pullY * 0.5}px)`, opacity: pullY > 20 ? 1 : 0 }}>
                        <div className="bg-[#2C2C2E] p-2.5 rounded-full shadow-lg border border-white/10"><Loader2 className={`text-white ${isRefreshing ? 'animate-spin' : ''}`} size={20} style={{ transform: `rotate(${pullY * 2}deg)` }} /></div>
                    </div>

                    <main className="transition-transform duration-300 ease-out" style={{ transform: `translateY(${pullY}px)` }}>
                        {activeTab === 'home' && (
                            <div className="animate-fade-in">
                                <div className="pt-safe px-5 h-[50px] flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2"><span className="text-[18px] font-bold text-white">æ ‡å‡†è´¦æœ¬</span><ChevronDown size={16} className="text-art-textSub" /></div>
                                    <div className="w-8 h-8 rounded-full bg-art-cardLight flex items-center justify-center"><img src="https://ui-avatars.com/api/?name=User&background=random" className="w-8 h-8 rounded-full opacity-80" /></div>
                                </div>

                                <div className="mx-4 h-[220px] rounded-[32px] relative overflow-hidden shadow-2xl mb-6 group">
                                    <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" />
                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/80"></div>
                                    <div className="absolute top-6 left-6 z-10">
                                        <div className="text-[14px] text-white/70 font-medium mb-1">æœ¬æœˆæ”¶æ”¯ç»Ÿè®¡</div>
                                        <div className="text-[12px] text-white/50">æ€»æ”¯å‡º</div>
                                        <div className="text-[42px] font-bold text-white font-mono tracking-tight -mt-1">{formatMoney(stats.monthTotal)}</div>
                                        <div className="flex items-center gap-4 mt-2 text-[12px] text-white/60"><span>æ€»æ”¶å…¥ 0.00</span><span>|</span><span>ç»“ä½™ -{formatMoney(stats.monthTotal)}</span></div>
                                    </div>
                                </div>

                                <div className="mx-4 space-y-3 mb-6">
                                    {/* ğŸ†• Clickable Summary Rows with Generated Titles */}
                                    <div onClick={() => setView({ name: 'period', title: `ä»Šå¤© ${format(new Date(), 'Mæœˆdæ—¥')}`, type: 'today', total: stats.todayTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-green-500 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.5)]"></div><div><div className="text-[15px] font-bold text-white">ä»Šå¤©</div><div className="text-[12px] text-art-textSub">{new Date().getMonth()+1}æœˆ{new Date().getDate()}æ—¥</div></div></div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">æ€»æ”¯å‡º</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.todayTotal)}</div></div>
                                    </div>

                                    <div onClick={() => {
                                        const start = startOfWeek(new Date(), { weekStartsOn: 1 });
                                        const end = endOfWeek(new Date(), { weekStartsOn: 1 });
                                        setView({ name: 'period', title: `æœ¬å‘¨ ${format(start, 'M.d')}-${format(end, 'M.d')}`, type: 'week', total: stats.weekTotal });
                                    }} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div><div><div className="text-[15px] font-bold text-white">æœ¬å‘¨</div><div className="text-[12px] text-art-textSub">12æœˆ08æ—¥ - 12æœˆ14æ—¥</div></div></div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">æ€»æ”¯å‡º</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.weekTotal)}</div></div>
                                    </div>

                                    <div onClick={() => setView({ name: 'period', title: `æœ¬å¹´ ${new Date().getFullYear()}`, type: 'year', total: stats.yearTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-yellow-500 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div><div><div className="text-[15px] font-bold text-white">æœ¬å¹´</div><div className="text-[12px] text-art-textSub">2025å¹´</div></div></div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">æ€»æ”¯å‡º</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.yearTotal)}</div></div>
                                    </div>
                                </div>

                                <div className="mx-4 mb-24 bg-art-card rounded-[24px] p-5 border border-white/5">
                                    <div className="flex justify-between items-center mb-4"><div className="text-[14px] font-bold text-white">æœ¬æœˆæ¯æ—¥æ”¯å‡ºç»Ÿè®¡</div><div className="text-[12px] text-art-textSub flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-art-accent"></div> æ”¯å‡º {formatMoney(stats.monthTotal)}</div></div>
                                    <div className="h-[100px] w-full relative"><MiniLineChart data={stats.trend} /><div className="absolute bottom-0 left-0 right-0 flex justify-between text-[10px] text-art-textSub mt-2 pt-2 border-t border-white/5"><span>01</span><span>10</span><span>20</span><span>30</span></div></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'flow' && (
                            <div className="pt-safe px-4 pb-24 animate-fade-in">
                                <h2 className="text-[24px] font-bold text-white mb-6 mt-2">è´¦å•æµæ°´</h2>
                                <div className="space-y-4">
                                    {Object.entries(groupedTransactions).map(([header, group]) => (
                                        <div key={header}>
                                            <div className="flex justify-between items-end px-2 mb-2"><h3 className="text-[13px] font-bold text-art-textSub">{header}</h3><span className="text-[12px] text-art-textSub">æ”¯ {formatMoney(group.total)}</span></div>
                                            <div className="bg-art-card rounded-[18px] overflow-hidden border border-white/5">
                                                {group.items.map((t, idx) => (
                                                    <div key={t.id} onClick={() => setView({ name: 'editor', transaction: t })} className="relative group active:bg-white/5 transition-colors cursor-pointer">
                                                        <div className="flex items-center px-4 py-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center mr-4 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text}`}>{getCategoryIcon(t.category)}</div><div className="flex-1 min-w-0 mr-4"><p className="text-[15px] font-medium text-white truncate mb-0.5">{t.merchant || t.category}</p><p className="text-[12px] text-art-textSub truncate">{t.date.split('T')[1].substring(0,5)} Â· {t.note || t.category}</p></div><div className="text-right"><p className="text-[16px] font-bold text-art-textMain font-mono">{formatMoney(t.amount)}</p></div></div>
                                                        {idx !== group.items.length - 1 && <div className="absolute bottom-0 left-[70px] right-0 h-[1px] bg-[#2C2C2E]"></div>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-[30px] left-1/2 -translate-x-1/2 z-50">
                        <button onClick={() => { setIsAddModalOpen(true); haptic('light'); }} className="w-[56px] h-[56px] bg-[#E9E9EB] rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(255,255,255,0.2)] active:scale-90 transition-transform text-black border-4 border-[#121212]"><Plus size={28} strokeWidth={2.5} /></button>
                    </div>

                    <nav className="fixed bottom-0 w-full bg-[#121212]/95 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 z-40">
                        <div className="grid grid-cols-3 h-[50px] relative text-[10px] font-medium text-art-textSub">
                            <button onClick={() => setActiveTab('flow')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='flow' ? 'text-white' : ''}`}><FileText size={22} strokeWidth={activeTab==='flow'?2.5:2} /> æµæ°´</button>
                            <div className="flex flex-col items-center justify-end pb-1 opacity-50"><span>è®°ä¸€ç¬”</span></div>
                            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='home' ? 'text-white' : ''}`}><Layers size={22} strokeWidth={activeTab==='home'?2.5:2} /> æŠ¥è¡¨</button>
                        </div>
                    </nav>

                    {isAddModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end justify-center">
                             <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsAddModalOpen(false)}></div>
                             <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10">
                                <h3 className="text-white text-lg font-bold mb-4">è®°ä¸€ç¬”</h3>
                                <div className="space-y-4">
                                    <div className="bg-[#2C2C2E] p-4 rounded-2xl flex items-center"><span className="text-2xl mr-3 text-white/50">Â¥</span><input autoFocus type="number" className="bg-transparent text-3xl font-bold text-white w-full outline-none" placeholder="0.00" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} /></div>
                                    <div className="grid grid-cols-4 gap-3">
                                        {categories.map(c => (
                                            <button key={c} onClick={() => setForm({...form, category: c})} className={`py-2 rounded-xl text-xs ${form.category === c ? 'bg-white text-black' : 'bg-[#2C2C2E] text-gray-400'}`}>{c}</button>
                                        ))}
                                    </div>
                                    <button onClick={() => handleSave(false)} className="w-full py-4 bg-white text-black rounded-2xl font-bold mt-2 flex items-center justify-center gap-2">{loading && <Loader2 className="animate-spin" />} ç¡®è®¤</button>
                                </div>
                             </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
