<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI ÈöèÊâãËÆ∞">
    <meta name="theme-color" content="#000000">
    <title>AI ÈöèÊâãËÆ∞</title>
    
    <!-- üé® Âä®ÊÄÅÁîüÊàêÈ´òÁ∫ßÂõæÊ†áËÑöÊú¨ -->
    <script>
        (function() {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#18181B'; 
            ctx.fillRect(0, 0, size, size);
            const glow = ctx.createRadialGradient(size/2, size/2, size/4, size/2, size/2, size);
            glow.addColorStop(0, 'rgba(45, 212, 191, 0.1)'); 
            glow.addColorStop(1, 'rgba(24, 24, 27, 0)');
            ctx.fillStyle = glow;
            ctx.fillRect(0, 0, size, size);
            const gradient = ctx.createLinearGradient(100, 100, 400, 400);
            gradient.addColorStop(0, '#2DD4BF'); 
            gradient.addColorStop(1, '#40C4FF'); 
            ctx.translate(size/2, size/2);
            ctx.fillStyle = gradient;
            function roundRect(x, y, w, h, r) {
                ctx.beginPath(); ctx.moveTo(x+r, y); ctx.arcTo(x+w, y, x+w, y+h, r); ctx.arcTo(x+w, y+h, x, y+h, r); ctx.arcTo(x, y+h, x, y, r); ctx.arcTo(x, y, x+w, y, r); ctx.closePath(); ctx.fill();
            }
            roundRect(-140, -100, 280, 200, 40);
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.moveTo(-140, -40); ctx.lineTo(140, -40); ctx.lineTo(140, 100); ctx.lineTo(-140, 100); ctx.fill();
            ctx.fillStyle = '#18181B'; ctx.beginPath(); ctx.arc(60, 0, 35, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#FFFFFF'; ctx.beginPath(); ctx.arc(60, 0, 12, 0, Math.PI*2); ctx.fill();
            const url = canvas.toDataURL('image/png');
            const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.href = url; document.head.appendChild(linkIcon);
            const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = url; document.head.appendChild(linkApple);
        })();
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        art: {
                            bg: '#000000',      // Á∫ØÈªëËÉåÊôØÊõ¥ÊòæÈ´òÁ∫ß
                            card: '#1C1C1E',    // iOS System Gray 6
                            cardLight: '#2C2C2E', // iOS System Gray 5
                            accent: '#34C759',  // iOS Green
                            cyan: '#30B0C7',    // iOS Teal
                            blue: '#0A84FF',    // iOS Blue
                            textMain: '#FFFFFF',
                            textSub: '#8E8E93', // iOS Gray
                            border: '#38383A',
                        }
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'slide-up-stagger': 'slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s infinite linear',
                        'scale-x': 'scaleX 0.8s ease-out forwards'
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        slideUpFade: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(300%)' }
                        },
                        scaleX: {
                            '0%': { transform: 'scaleX(0)', opacity: '0' },
                            '100%': { transform: 'scaleX(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>

    <style>
        html, body, #root {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            background-color: #000000;
        }

        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        body {
            color: #FFFFFF;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 44px); }
        input:focus, textarea:focus { outline: none; }
        
        .page-container {
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; 
            background-color: #000000; /* ÂÖ®Â±ÄÁ∫ØÈªëËÉåÊôØ */
            z-index: 50;
            -webkit-overflow-scrolling: touch;
        }

        .page-enter-active {
            animation: slideInRight 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { 
            Home, PieChart, Plus, X, Loader2, Save, Trash2, 
            CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Search, 
            Utensils, Car, ShoppingBag, Gamepad2, Home as HomeIcon, 
            HeartPulse, Banknote, FileText, TrendingUp, Calendar, 
            LayoutGrid, ArrowLeft, Video, MessageCircle, Wallet, ChevronDown, Layers,
            Users, Settings, Clock, Filter, Check, Trophy, Sparkles, Tag, PenLine, CalendarDays, Camera
        } from 'lucide-react';
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, isSameDay, format, parseISO, getDaysInMonth, getISOWeek, addMonths, subMonths, setMonth, setYear } from 'date-fns';

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatMoney = (amount) => Math.abs(Number(amount)).toFixed(2);
        
        const haptic = (type = 'light') => {
            if (window.navigator && window.navigator.vibrate) {
                if (type === 'light') window.navigator.vibrate(10);
                else window.navigator.vibrate(20);
                if (type === 'error') window.navigator.vibrate([50, 50, 50]);
            }
        };

        const getBeijingTime = () => {
            const d = new Date();
            const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
            const beijingTime = new Date(utc + (3600000 * 8));
            const h = String(beijingTime.getHours()).padStart(2, '0');
            const m = String(beijingTime.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        };

        // üåü ÂçáÁ∫ßÁâà iOS Swipe Back Hook
        const useSwipeBack = (onClose) => {
            const [offset, setOffset] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const [isAnimatingOut, setIsAnimatingOut] = useState(false); 
            const startX = useRef(0);
            const screenWidth = typeof window !== 'undefined' ? window.innerWidth : 375;

            const handleTouchStart = (e) => {
                if (isAnimatingOut) return;
                if (e.touches[0].clientX < 50) {
                    startX.current = e.touches[0].clientX;
                    setIsDragging(true);
                } else {
                    setIsDragging(false);
                }
            };

            const handleTouchMove = (e) => {
                if (!isDragging || isAnimatingOut) return;
                const currentX = e.touches[0].clientX;
                const delta = currentX - startX.current;
                if (delta > 0) {
                    setOffset(delta); 
                }
            };

            const handleTouchEnd = () => {
                if (!isDragging || isAnimatingOut) return;
                setIsDragging(false);
                if (offset > 100) {
                    triggerClose();
                } else {
                    setOffset(0);
                }
            };

            const triggerClose = () => {
                if (isAnimatingOut) return;
                setIsAnimatingOut(true);
                setOffset(screenWidth); 
                haptic('light');
                setTimeout(() => {
                    onClose();
                }, 300);
            };

            return {
                bind: {
                    onTouchStart: handleTouchStart,
                    onTouchMove: handleTouchMove,
                    onTouchEnd: handleTouchEnd
                },
                style: {
                    transform: `translateX(${offset}px)`,
                    transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)', 
                    zIndex: 200,
                    boxShadow: '-10px 0 30px rgba(0,0,0,0.5)'
                },
                triggerClose
            };
        };

        const getCategoryIcon = (category) => {
            const size = 18;
            switch (category) {
                case 'È§êÈ•Æ': return <Utensils size={size} />;
                case '‰∫§ÈÄö': return <Car size={size} />;
                case 'Ë¥≠Áâ©': return <ShoppingBag size={size} />;
                case 'Â®±‰πê': return <Gamepad2 size={size} />;
                case 'Â±Ö‰Ωè': return <HomeIcon size={size} />;
                case 'ÂåªÁñó': return <HeartPulse size={size} />;
                case 'Â∑•ËµÑ': return <Banknote size={size} />;
                default: return <FileText size={size} />;
            }
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case 'È§êÈ•Æ': return { bg: 'bg-[#FF453A]/20', text: 'text-[#FF453A]', gradient: 'from-[#FF453A]/80 to-[#FF453A]/10' }; 
                case '‰∫§ÈÄö': return { bg: 'bg-[#0A84FF]/20', text: 'text-[#0A84FF]', gradient: 'from-[#0A84FF]/80 to-[#0A84FF]/10' }; 
                case 'Ë¥≠Áâ©': return { bg: 'bg-[#FFD60A]/20', text: 'text-[#FFD60A]', gradient: 'from-[#FFD60A]/80 to-[#FFD60A]/10' }; 
                case 'Â®±‰πê': return { bg: 'bg-[#BF5AF2]/20', text: 'text-[#BF5AF2]', gradient: 'from-[#BF5AF2]/80 to-[#BF5AF2]/10' }; 
                case 'Â±Ö‰Ωè': return { bg: 'bg-[#64D2FF]/20', text: 'text-[#64D2FF]', gradient: 'from-[#64D2FF]/80 to-[#64D2FF]/10' }; 
                case 'ÂåªÁñó': return { bg: 'bg-[#FF375F]/20', text: 'text-[#FF375F]', gradient: 'from-[#FF375F]/80 to-[#FF375F]/10' }; 
                case 'Â∑•ËµÑ': return { bg: 'bg-[#30D158]/20', text: 'text-[#30D158]', gradient: 'from-[#30D158]/80 to-[#30D158]/10' }; 
                default: return { bg: 'bg-[#8E8E93]/20', text: 'text-[#8E8E93]', gradient: 'from-[#8E8E93]/80 to-[#8E8E93]/10' };    
            }
        };
        const categoriesList = ['È§êÈ•Æ', '‰∫§ÈÄö', 'Ë¥≠Áâ©', 'Â®±‰πê', 'Â±Ö‰Ωè', 'ÂåªÁñó', 'Â∑•ËµÑ', 'ÂÖ∂‰ªñ'];

        const getRawDateStr = (isoString) => {
            if (!isoString) return '';
            try { return isoString.split('T')[0]; } catch (e) { return ''; }
        };
        const getRawTimeStr = (isoString) => {
            if (!isoString) return '00:00';
            try { return isoString.split('T')[1].substring(0, 5); } catch (e) { return '00:00'; }
        };

        const Toast = ({ message, type = 'success' }) => {
            if (!message) return null;
            return (
                <div className="fixed top-safe left-1/2 -translate-x-1/2 z-[200] mt-4 animate-fade-in pointer-events-none">
                    <div className={`flex items-center gap-2 px-4 py-2.5 rounded-full shadow-xl border ${type === 'error' ? 'bg-[#27272A] border-red-500/30' : 'bg-[#27272A] border-white/10'}`}>
                        {type === 'error' ? <AlertCircle size={16} className="text-red-500" /> : <CheckCircle size={16} className="text-[#30D158]" />}
                        <span className="text-[13px] font-medium text-white">{message}</span>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, onCancel, onConfirm, title = "Á°ÆËÆ§", message = "Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[999] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity animate-fade-in" onClick={onCancel}></div>
                    <div className="relative bg-[#1C1C1E] rounded-2xl w-full max-w-[280px] overflow-hidden shadow-2xl animate-fade-in transform transition-all scale-100">
                        <div className="p-6 text-center">
                            <h3 className="text-white font-bold text-[17px] mb-2">{title}</h3>
                            <p className="text-white/60 text-[13px] leading-relaxed">{message}</p>
                        </div>
                        <div className="grid grid-cols-2 border-t border-white/10">
                            <button onClick={onCancel} className="py-3.5 text-[17px] text-white/90 font-medium active:bg-white/10 border-r border-white/10 transition-colors">ÂèñÊ∂à</button>
                            <button onClick={onConfirm} className="py-3.5 text-[17px] text-[#FF453A] font-bold active:bg-white/10 transition-colors">Âà†Èô§</button>
                        </div>
                    </div>
                </div>
            );
        };

        // üåü Êñ∞Â¢ûÔºöÂàÜÁ±ªÈÄâÊã©ÂºπÁ™ó
        const CategoryPickerSheet = ({ isOpen, onClose, selected, onSelect }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©ÂàÜÁ±ª</h3>
                            <button onClick={onClose} className="p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button>
                        </div>
                        <div className="grid grid-cols-4 gap-4">
                            {categoriesList.map(cat => {
                                const color = getCategoryColor(cat);
                                const isSelected = selected === cat;
                                return (
                                    <button 
                                        key={cat} 
                                        onClick={() => { onSelect(cat); onClose(); }} 
                                        className={`flex flex-col items-center justify-center gap-2 py-2 rounded-2xl transition-all active:scale-95 border ${isSelected ? `bg-white/10 border-white/20` : 'border-transparent hover:bg-white/5'}`}
                                    >
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center ${isSelected ? 'bg-white text-black' : `${color.bg} ${color.text}`}`}>
                                            {React.cloneElement(getCategoryIcon(cat), { size: 24 })}
                                        </div>
                                        <span className={`text-[12px] font-medium ${isSelected ? 'text-white' : 'text-art-textSub'}`}>{cat}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const CustomDatePickerSheet = ({ isOpen, onClose, currentDateStr, onSelect }) => {
            if (!isOpen) return null;
            const [viewDate, setViewDate] = useState(() => currentDateStr ? new Date(currentDateStr) : new Date());
            useEffect(() => { if (isOpen) setViewDate(currentDateStr ? new Date(currentDateStr) : new Date()); }, [isOpen, currentDateStr]);
            const daysInMonth = getDaysInMonth(viewDate);
            const startDay = startOfMonth(viewDate).getDay(); 
            const weeks = [];
            let day = 1; let currentWeek = [];
            for (let i = 0; i < startDay; i++) currentWeek.push(null);
            while (day <= daysInMonth) {
                currentWeek.push(day);
                if (currentWeek.length === 7) { weeks.push(currentWeek); currentWeek = []; }
                day++;
            }
            if (currentWeek.length > 0) { while (currentWeek.length < 7) currentWeek.push(null); weeks.push(currentWeek); }
            const changeMonth = (delta) => { setViewDate(prev => { const newD = new Date(prev); newD.setMonth(newD.getMonth() + delta); return newD; }); haptic('light'); };

            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©Êó•Êúü</h3>
                            <button onClick={onClose} className="p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button>
                        </div>
                        <div className="flex items-center justify-between mb-4 bg-[#2C2C2E] rounded-xl p-2">
                            <button onClick={() => changeMonth(-1)} className="p-2 text-white/70 active:text-white"><ChevronLeft size={20} /></button>
                            <span className="text-[15px] font-bold text-white font-mono">{format(viewDate, 'yyyyÂπ¥ MMÊúà')}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 text-white/70 active:text-white"><ChevronRight size={20} /></button>
                        </div>
                        <div className="grid grid-cols-7 mb-2 text-center">
                            {['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'].map(d => (<div key={d} className="text-[12px] text-art-textSub py-2">{d}</div>))}
                        </div>
                        <div className="space-y-1">
                            {weeks.map((week, wIdx) => (
                                <div key={wIdx} className="grid grid-cols-7 text-center">
                                    {week.map((d, dIdx) => {
                                        if (!d) return <div key={dIdx} />;
                                        const isSelected = currentDateStr && format(new Date(currentDateStr), 'yyyy-MM') === format(viewDate, 'yyyy-MM') && parseInt(currentDateStr.split('-')[2]) === d;
                                        const isToday = isSameDay(new Date(viewDate.getFullYear(), viewDate.getMonth(), d), new Date());
                                        return (
                                            <div key={dIdx} className="flex items-center justify-center py-1">
                                                <button onClick={() => {onSelect(format(new Date(viewDate.setDate(d)), 'yyyy-MM-dd')); onClose();}} className={`w-9 h-9 rounded-full text-[14px] font-medium flex items-center justify-center transition-all active:scale-90 ${isSelected ? 'bg-white text-black font-bold shadow-lg' : isToday ? 'text-art-accent border border-art-accent/50' : 'text-white hover:bg-white/10'}`}>{d}</button>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CustomTimePickerSheet = ({ isOpen, onClose, currentTimeStr, onSelect }) => {
            if (!isOpen) return null;
            const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
            const minutes = Array.from({ length: 60 }, (_, i) => String(i).padStart(2, '0'));
            const [selectedHour, setSelectedHour] = useState(currentTimeStr ? currentTimeStr.split(':')[0] : '00');
            const [selectedMinute, setSelectedMinute] = useState(currentTimeStr ? currentTimeStr.split(':')[1] : '00');
            const hourRef = useRef(null);
            const minuteRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    const timeToUse = currentTimeStr || getBeijingTime();
                    const [h, m] = timeToUse.split(':');
                    setSelectedHour(h);
                    setSelectedMinute(m);
                    setTimeout(() => {
                        if (hourRef.current) hourRef.current.scrollTop = parseInt(h) * 40;
                        if (minuteRef.current) minuteRef.current.scrollTop = parseInt(m) * 40;
                    }, 10);
                }
            }, [isOpen, currentTimeStr]);

            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] pb-safe animate-slide-up border-t border-white/10 shadow-2xl flex flex-col h-[320px]">
                        <div className="flex justify-between items-center p-4 border-b border-white/10">
                            <button onClick={onClose} className="text-art-textSub text-[15px]">ÂèñÊ∂à</button>
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©Êó∂Èó¥</h3>
                            <button onClick={() => {onSelect(`${selectedHour}:${selectedMinute}`); onClose();}} className="text-art-accent font-bold text-[15px]">Á°ÆÂÆö</button>
                        </div>
                        <div className="flex-1 flex relative overflow-hidden">
                            <div className="absolute top-1/2 left-0 right-0 h-[40px] -mt-[20px] bg-white/10 pointer-events-none z-0"></div>
                            <div ref={hourRef} onScroll={(e) => { const idx = Math.round(e.target.scrollTop/40); if(hours[idx]) setSelectedHour(hours[idx]); }} className="flex-1 overflow-y-auto no-scrollbar py-[110px] text-center snap-y snap-mandatory relative z-10">
                                {hours.map(h => (<div key={h} onClick={() => { setSelectedHour(h); if(hourRef.current) hourRef.current.scrollTop = parseInt(h)*40; haptic('light'); }} className={`h-[40px] flex items-center justify-center snap-center transition-all ${h === selectedHour ? 'text-white font-bold text-[20px]' : 'text-white/30 text-[16px]'}`}>{h}</div>))}
                            </div>
                            <div className="flex items-center justify-center text-white/30 font-bold">:</div>
                            <div ref={minuteRef} onScroll={(e) => { const idx = Math.round(e.target.scrollTop/40); if(minutes[idx]) setSelectedMinute(minutes[idx]); }} className="flex-1 overflow-y-auto no-scrollbar py-[110px] text-center snap-y snap-mandatory relative z-10">
                                {minutes.map(m => (<div key={m} onClick={() => { setSelectedMinute(m); if(minuteRef.current) minuteRef.current.scrollTop = parseInt(m)*40; haptic('light'); }} className={`h-[40px] flex items-center justify-center snap-center transition-all ${m === selectedMinute ? 'text-white font-bold text-[20px]' : 'text-white/30 text-[16px]'}`}>{m}</div>))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const Skeleton = () => (
            <div className="animate-pulse space-y-5 px-1 mt-2">
                {[1, 2, 3, 4, 5, 6].map(i => (
                    <div key={i} className="flex items-center justify-between py-2">
                        <div className="flex items-center gap-4 w-full"><div className="w-10 h-10 rounded-full bg-white/5"></div><div className="space-y-2 flex-1"><div className="h-4 w-1/3 bg-white/5 rounded"></div><div className="h-3 w-1/4 bg-white/5 rounded"></div></div><div className="h-5 w-16 bg-white/5 rounded"></div></div>
                    </div>
                ))}
            </div>
        );

        const MonthlyStats = ({ transactions, currentDate, onCategoryClick }) => {
            const [selectedIndex, setSelectedIndex] = useState(null); 
            const chartRef = useRef(null);
            const { chartData, categoryData, totalMonthExpense, totalCount } = useMemo(() => {
                const daysInM = endOfMonth(currentDate).getDate();
                const monthStr = format(currentDate, 'yyyy-MM');
                const monthTrans = transactions.filter(t => getRawDateStr(t.date).startsWith(monthStr));
                const totalMonthExpense = monthTrans.reduce((sum, t) => sum + Math.abs(Number(t.amount || 0)), 0);
                const data = new Array(daysInM).fill(0).map((_, i) => ({ day: i + 1, amount: 0, dateStr: format(new Date(currentDate.getFullYear(), currentDate.getMonth(), i + 1), 'MM.dd') }));
                monthTrans.forEach(t => { const dateStr = getRawDateStr(t.date); if (dateStr) { const d = new Date(dateStr).getDate(); if (data[d-1]) data[d-1].amount += Math.abs(Number(t.amount || 0)); } });
                const catStats = {};
                monthTrans.forEach(t => { const amt = Math.abs(Number(t.amount || 0)); const cat = t.category || 'ÂÖ∂‰ªñ'; if (!catStats[cat]) catStats[cat] = { count: 0, amount: 0 }; catStats[cat].count += 1; catStats[cat].amount += amt; });
                const categories = Object.entries(catStats).map(([name, val]) => ({ name, ...val, percent: totalMonthExpense ? (val.amount / totalMonthExpense) * 100 : 0 })).sort((a, b) => b.amount - a.amount);
                return { chartData: data, categoryData: categories, totalMonthExpense, totalCount: monthTrans.length };
            }, [transactions, currentDate]);

            useEffect(() => {
                const today = new Date();
                if (isSameDay(today, currentDate) || (today.getMonth() === currentDate.getMonth() && today.getFullYear() === currentDate.getFullYear())) {
                    setSelectedIndex(today.getDate() - 1);
                } else {
                    setSelectedIndex(0);
                }
            }, [currentDate]);

            const handleTouch = (e) => {
                if (!chartRef.current) return;
                const touch = e.touches[0];
                const rect = chartRef.current.getBoundingClientRect();
                const totalBars = chartData.length;
                let newIndex = Math.floor(((touch.clientX - rect.left) / rect.width) * totalBars);
                if (newIndex < 0) newIndex = 0; if (newIndex >= totalBars) newIndex = totalBars - 1;
                if (newIndex !== selectedIndex) { setSelectedIndex(newIndex); haptic('light'); }
            };

            const maxAmount = Math.max(...chartData.map(d => d.amount), 10); 
            const yAxisMax = Math.ceil(maxAmount / 10) * 10;
            const selectedData = chartData[selectedIndex] || { amount: 0, day: 1 };
            const getPoints = () => chartData.map((d, i) => `${(i / (chartData.length - 1)) * 100},${100 - (d.amount / yAxisMax) * 80}`).join(' ');

            return (
                <div className="mx-4 mb-24 bg-[#1C1C1E] rounded-[24px] p-5 border border-white/5 shadow-2xl relative overflow-visible">
                    <div className="text-[15px] font-bold text-white/90 mb-8">Êú¨ÊúàÊØèÊó•ÊîØÂá∫ÁªüËÆ°</div>
                    <div ref={chartRef} className="h-[180px] w-full relative mb-6 select-none touch-none" onTouchStart={handleTouch} onTouchMove={handleTouch}>
                        {selectedIndex !== null && (
                            <div className={`absolute -top-8 z-30 transition-all duration-75 pointer-events-none ${selectedIndex === 0 ? "origin-bottom-left" : selectedIndex === chartData.length - 1 ? "origin-bottom-right" : "origin-bottom"}`} style={selectedIndex === 0 ? { left: '0%' } : selectedIndex === chartData.length - 1 ? { right: '0%', left: 'auto' } : { left: `${(selectedIndex / (chartData.length - 1)) * 100}%`, transform: 'translateX(-50%)' }}>
                                <div className="bg-[#121212] px-2.5 py-1.5 rounded-lg border border-white/10 flex items-center gap-1.5 shadow-xl whitespace-nowrap">
                                    <div className="w-2 h-2 rounded-full bg-art-cyan"></div><span className="text-[12px] font-medium text-white">ÊîØÂá∫ {formatMoney(selectedData.amount)}</span>
                                </div>
                            </div>
                        )}
                        <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-30">
                            {[1, 0.5, 0].map(r => <div key={r} className="relative w-full border-t border-dashed border-white/10"><span className="absolute -left-0 -top-2.5 text-[10px] text-art-textSub">{r * yAxisMax}</span></div>)}
                        </div>
                        <div className="absolute inset-0 left-0 right-0 top-3 bottom-0 z-10 px-[2px] pointer-events-none">
                             <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                                <defs><linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#2DD4BF" stopOpacity="0.3" /><stop offset="100%" stopColor="#2DD4BF" stopOpacity="0" /></linearGradient></defs>
                                <path d={`M 0,100 L ${getPoints().split(' ').map(p => `L ${p.replace(',', ' ')}`).join(' ')} L 100,100 Z`} fill="url(#chartGradient)" />
                                <polyline points={getPoints()} fill="none" stroke="#2DD4BF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />
                            </svg>
                        </div>
                         {selectedIndex !== null && (
                            <div className="absolute top-3 bottom-0 w-[1.5px] bg-[#2DD4BF] z-0 transition-all duration-75 pointer-events-none" style={{ left: `${(selectedIndex / (chartData.length - 1)) * 100}%` }}>
                                <div className="absolute -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#1C1C1E] border-[2.5px] border-[#2DD4BF] rounded-full" style={{ top: `${100 - (selectedData.amount / yAxisMax) * 80}%` }}></div>
                            </div>
                        )}
                        <div className="absolute top-0 left-0 w-full h-full z-20 flex items-end pointer-events-none">
                             {chartData.map((d, i) => {
                                 const showLabel = i === 0 || i === chartData.length - 1 || (i + 1) % 5 === 0;
                                 return (<div key={i} className={`flex-1 h-full flex items-end ${i === 0 ? 'justify-start' : (i === chartData.length - 1 ? 'justify-end' : 'justify-center')} pb-[-20px]`}>{(showLabel || selectedIndex === i) && (<div className={`text-[9px] mb-[-24px] px-0.5 py-0.5 rounded-md ${selectedIndex === i ? 'bg-black text-white font-bold z-30 shadow-lg scale-110 px-1.5' : 'text-art-textSub'}`}>{d.dateStr}</div>)}</div>);
                             })}
                        </div>
                    </div>
                    <div className="flex justify-between items-center mb-4 pt-6 border-t border-white/5">
                        <div className="text-[14px] font-bold text-white/90">Êú¨ÊúàÂàÜÁ±ªÊîØÂá∫</div>
                        <div className="text-[11px] text-art-textSub">ËÆ∞Ë¥¶Á¨îÊï∞ <span className="text-white font-mono">{totalCount}</span> <span className="mx-2"></span> ÊÄªÊîØÂá∫ <span className="text-art-cyan font-mono">{formatMoney(totalMonthExpense)}</span></div>
                    </div>
                    <div className="space-y-6">
                        {categoryData.length === 0 ? <div className="text-center text-art-textSub text-[12px] py-4">ÊöÇÊó†ÂàÜÁ±ªÊï∞ÊçÆ</div> : categoryData.map((cat, idx) => (
                            <div key={cat.name} className="group active:opacity-60 transition-opacity cursor-pointer" onClick={() => onCategoryClick(cat.name)}>
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-3">
                                        <div className="text-[12px] font-bold text-art-textSub w-4 text-center font-mono">{idx + 1}</div>
                                        <div className="flex items-center gap-2"><div className={`w-6 h-6 rounded-full flex items-center justify-center ${getCategoryColor(cat.name).bg} ${getCategoryColor(cat.name).text}`}>{React.cloneElement(getCategoryIcon(cat.name), { size: 12 })}</div><span className="text-[13px] text-white font-medium">{cat.name}</span></div>
                                    </div>
                                    <div className="text-right"><div className="text-[11px] text-white font-mono">{cat.percent.toFixed(2)}% <span className="text-art-textSub mx-1">‚Ä¢</span> {formatMoney(cat.amount)}</div></div>
                                </div>
                                <div className="flex items-center gap-3 pl-9"><div className="flex-1 h-1.5 bg-[#2C2C2E] rounded-full overflow-hidden"><div className="h-full bg-art-cyan rounded-full" style={{ width: `${cat.percent}%` }}></div></div></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const FilterSidebar = ({ isOpen, onClose, currentFilters, onApply }) => {
            const [localFilters, setLocalFilters] = useState(currentFilters);
            useEffect(() => { if (isOpen) setLocalFilters(currentFilters); }, [isOpen, currentFilters]);
            const handleApply = () => { onApply(localFilters); onClose(); };
            return (
                <>
                    <div className={`fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] transition-opacity duration-300 ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={onClose} />
                    <div className={`fixed inset-y-0 right-0 w-[85%] max-w-[320px] bg-[#1C1C1E] z-[230] transform transition-transform duration-300 ease-out shadow-2xl flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="flex items-center justify-between p-4 border-b border-white/10 pt-safe">
                            <button onClick={onClose} className="text-art-textSub">ÂèñÊ∂à</button>
                            <h3 className="text-[17px] font-bold text-white">Á≠õÈÄâ</h3>
                            <button onClick={handleApply} className="text-art-accent font-bold">ÂÆåÊàê</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            <div><div className="text-[13px] text-art-textSub mb-2 ml-1">Êó∂Èó¥ËåÉÂõ¥</div><div className="bg-[#2C2C2E] rounded-xl p-3 flex items-center justify-between gap-2"><input type="date" className="bg-transparent text-white text-[14px] outline-none w-full text-center" value={localFilters.startDate || ''} onChange={(e) => setLocalFilters({...localFilters, startDate: e.target.value})} /><span className="text-art-textSub">-</span><input type="date" className="bg-transparent text-white text-[14px] outline-none w-full text-center" value={localFilters.endDate || ''} onChange={(e) => setLocalFilters({...localFilters, endDate: e.target.value})} /></div></div>
                            <div><div className="text-[13px] text-art-textSub mb-2 ml-1">ÂàÜÁ±ª</div><div className="flex flex-wrap gap-2"><button onClick={() => setLocalFilters({...localFilters, category: 'all'})} className={`px-3 py-1.5 rounded-lg text-[13px] border ${localFilters.category === 'all' ? 'bg-white text-black border-white' : 'bg-[#2C2C2E] text-white border-transparent'}`}>ÂÖ®ÈÉ®</button>{categoriesList.map(cat => (<button key={cat} onClick={() => setLocalFilters({...localFilters, category: cat})} className={`px-3 py-1.5 rounded-lg text-[13px] border ${localFilters.category === cat ? 'bg-art-accent text-black border-art-accent' : 'bg-[#2C2C2E] text-white border-transparent'}`}>{cat}</button>))}</div></div>
                            <div><div className="text-[13px] text-art-textSub mb-2 ml-1">ÈáëÈ¢ùÂå∫Èó¥</div><div className="flex items-center gap-3"><div className="bg-[#2C2C2E] rounded-xl flex-1 px-3 py-2.5"><input type="number" placeholder="ÊúÄ‰Ωé" className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.minAmount || ''} onChange={(e) => setLocalFilters({...localFilters, minAmount: e.target.value})} /></div><div className="w-2 h-[1px] bg-art-textSub"></div><div className="bg-[#2C2C2E] rounded-xl flex-1 px-3 py-2.5"><input type="number" placeholder="ÊúÄÈ´ò" className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.maxAmount || ''} onChange={(e) => setLocalFilters({...localFilters, maxAmount: e.target.value})} /></div></div></div>
                            <div><div className="text-[13px] text-art-textSub mb-2 ml-1">Â§áÊ≥®ÂÖ≥ÈîÆËØç</div><div className="bg-[#2C2C2E] rounded-xl px-3 py-2.5 flex items-center"><Search size={16} className="text-art-textSub mr-2" /><input type="text" placeholder="ÊêúÁ¥¢Â§áÊ≥®..." className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.keyword || ''} onChange={(e) => setLocalFilters({...localFilters, keyword: e.target.value})} /></div></div>
                        </div>
                    </div>
                </>
            );
        };
        const FilterSheet = ({ isOpen, onClose, dateRange, onModify }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-center items-center mb-8 relative"><h3 className="text-[17px] font-bold text-white">Á≠õÈÄâÊù°‰ª∂</h3><button onClick={onClose} className="absolute right-0 p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button></div>
                        <div className="flex items-center gap-3 mb-10 pl-1"><div className="text-white"><Clock size={20} /></div><span className="text-[15px] font-medium text-white/90">ÂΩìÂâçËåÉÂõ¥</span><span className="text-[15px] text-white/90 font-mono ml-auto tracking-wide">{dateRange}</span></div>
                        <div className="flex gap-3"><button onClick={() => { onClose(); onModify('viewAll'); }} className="flex-1 py-3.5 bg-white text-black rounded-full font-bold text-[15px] active:scale-95 transition-transform shadow-lg">Êü•ÁúãÂÖ®ÈÉ®ÊµÅÊ∞¥</button><button onClick={() => { onClose(); onModify('openSidebar'); }} className="flex-1 py-3.5 bg-[#FF9F0A] text-white rounded-full font-bold text-[15px] active:scale-95 transition-transform shadow-lg">‰øÆÊîπÁ≠õÈÄâÊù°‰ª∂</button></div>
                    </div>
                </div>
            );
        };

        // üåü Êñ∞Â¢ûÔºöÊó∂Èó¥Áª¥Â∫¶ÈÄâÊã©ÂºπÁ™ó (ÊåâÊó•, ÊåâÂë®, ÊåâÊúà, ÊåâÂπ¥)
        const TimeDimensionSheet = ({ isOpen, onClose, selected, onSelect }) => {
            if (!isOpen) return null;
            const options = [
                { label: 'ÊåâÊó•', value: 'day' },
                { label: 'ÊåâÂë®', value: 'week' },
                { label: 'ÊåâÊúà', value: 'month' },
                { label: 'ÊåâÂπ¥', value: 'year' }
            ];
            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©Êó∂Èó¥Áª¥Â∫¶</h3>
                            <button onClick={onClose} className="p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button>
                        </div>
                        <div className="space-y-2">
                            {options.map(opt => (
                                <button 
                                    key={opt.value}
                                    onClick={() => { onSelect(opt.value); onClose(); }}
                                    className={`w-full py-4 rounded-xl text-[15px] font-medium flex items-center justify-between px-4 transition-colors ${selected === opt.value ? 'bg-white text-black' : 'bg-[#2C2C2E] text-white'}`}
                                >
                                    {opt.label}
                                    {selected === opt.value && <Check size={18} />}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TransactionGroup = ({ label, total, transactions, groupByDay, groupType, onViewEditor }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const daysMap = useMemo(() => {
                if (groupType === 'category') return null; // ÂàÜÁ±ªÊ®°Âºè‰∏ã‰∏çÈúÄË¶ÅÂÜçÊåâÊó•ÊúüÂàÜÁªÑ
                if (!groupByDay) return null; 
                const groups = {}; 
                transactions.forEach(t => { 
                    const dateStr = getRawDateStr(t.date); 
                    if (!dateStr) return; 
                    if (!groups[dateStr]) groups[dateStr] = []; 
                    groups[dateStr].push(t); 
                }); 
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions, groupByDay, groupType]);
            
            // ËÆ°ÁÆóÂàÜÁ±ªÊ®°Âºè‰∏ãÁöÑÂõæÊ†á
            const categoryIcon = groupType === 'category' ? getCategoryIcon(label) : null;
            const categoryColor = groupType === 'category' ? getCategoryColor(label) : null;

            return (
                <div className="animate-slide-up-stagger" style={{ animationDelay: '0.1s' }}>
                    <div className="sticky top-0 z-20 flex justify-between items-center py-3 px-5 bg-[#121212]/95 backdrop-blur-xl border-b border-white/5 cursor-pointer" onClick={() => { setIsExpanded(!isExpanded); haptic('light'); }}>
                        <div className="flex items-center gap-3">
                            {groupType === 'category' && (
                                <div className={`w-7 h-7 rounded-full flex items-center justify-center ${categoryColor?.bg} ${categoryColor?.text}`}>
                                    {React.cloneElement(categoryIcon, { size: 14 })}
                                </div>
                            )}
                            <div className="flex flex-col"><span className="text-[16px] font-bold text-white">{label}</span></div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-right">
                                <div className="text-[11px] text-art-textSub opacity-60 mb-0.5">ÊÄªÊîØÂá∫</div>
                                <div className="text-[14px] text-white font-medium">{formatMoney(total)}</div>
                            </div>
                            <div className={`transition-transform duration-200 text-art-textSub ${isExpanded ? 'rotate-180' : ''}`}><ChevronDown size={18} /></div>
                        </div>
                    </div>
                    
                    {isExpanded && (
                        <div className="bg-[#09090B]">
                            {/* ÊåâÊó∂Èó¥ÂàÜÁªÑ‰∏îÈúÄË¶ÅÂÜçÁªÜÂàÜÊó•ÊúüÁöÑÊÉÖÂÜµ (daysMapÂ≠òÂú®) */}
                            {daysMap && daysMap.map(([dateStr, items]) => { 
                                const dObj = new Date(dateStr); 
                                const weekDay = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'][dObj.getDay()]; 
                                return (
                                    <div key={dateStr}>
                                        <div className="flex justify-between items-center px-5 py-1.5 bg-[#27272A] border-b border-white/5">
                                            <div className="text-[12px] text-art-textSub font-medium">{format(dObj, 'MMÊúàddÊó•')} {weekDay}</div>
                                        </div>
                                        <div className="bg-[#1C1C1E]">
                                            {items.map(t => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}
                                        </div>
                                    </div>
                                ); 
                            })}
                            
                            {/* ÊåâÂàÜÁ±ªÂàÜÁªÑ Êàñ ÊåâÊó∂Èó¥ÂàÜÁªÑ‰ΩÜ‰∏çÈúÄË¶ÅÁªÜÂàÜÊó•Êúü (daysMap‰∏çÂ≠òÂú®) */}
                            {!daysMap && (
                                <div className="bg-[#1C1C1E] animate-fade-in">
                                    {transactions.map(t => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const TransactionItem = ({ t, onClick }) => (
            <div onClick={onClick} className="flex items-center justify-between py-3 px-5 active:bg-white/5 bg-[#1C1C1E] border-b border-white/5 last:border-b-0 transition-colors cursor-pointer">
                <div className="flex items-center gap-4 overflow-hidden"><div className={`w-9 h-9 rounded-full flex items-center justify-center shrink-0 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text}`}>{React.cloneElement(getCategoryIcon(t.category), { size: 18 })}</div><div className="flex flex-col min-w-0"><div className="text-[15px] text-white font-bold truncate mb-1">{t.merchant || t.category}</div><div className="text-[12px] text-[#666] font-normal truncate flex items-center gap-1.5"><span>{getRawTimeStr(t.date)}</span><span>¬∑</span><span>{t.note || t.category}</span></div></div></div><div className="text-[17px] text-art-blue font-bold shrink-0 ml-3 font-mono tracking-tight">{formatMoney(t.amount)}</div>
            </div>
        );

        const MonthGroup = ({ year, month, totalExpense, days, onViewEditor }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            return (
                <div className="animate-slide-up-stagger" style={{ animationDelay: '0.1s' }}>
                    <div className="sticky top-0 z-20 flex justify-between items-center py-2.5 px-5 bg-[#121212]/95 backdrop-blur-xl border-b border-white/5 cursor-pointer" onClick={() => { setIsExpanded(!isExpanded); haptic('light'); }}>
                        <div className="flex items-baseline gap-1.5"><span className="text-[20px] font-bold text-white">{month}Êúà</span><span className="text-[13px] text-art-textSub">{year}</span></div>
                        <div className="flex items-center gap-3"><div className="text-right"><div className="text-[11px] text-art-textSub opacity-60 mb-0.5">ÊÄªÊîØÂá∫</div><div className="text-[14px] text-white font-medium">{formatMoney(totalExpense)}</div></div><div className={`transition-transform duration-200 text-art-textSub ${isExpanded ? 'rotate-180' : ''}`}><ChevronDown size={18} /></div></div>
                    </div>
                    {isExpanded && (
                        <div className="animate-fade-in bg-[#09090B]">
                            {days.map(([dateStr, items], index) => { 
                                const dObj = new Date(dateStr); 
                                const weekDay = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'][dObj.getDay()]; 
                                const isToday = isSameDay(dObj, new Date());
                                return (
                                    <div key={dateStr}>
                                        <div className="flex justify-between items-center px-5 py-1 bg-[#27272A] border-b border-white/5">
                                            <div className={`text-[12px] font-medium ${isToday ? 'text-art-accent' : 'text-art-textSub'}`}>{format(dObj, 'MMÊúàddÊó•')} {weekDay}</div>
                                        </div>
                                        <div className="bg-[#1C1C1E]">
                                            {items.map((t) => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}
                                        </div>
                                    </div>
                                ); 
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const PeriodPage = ({ title, type, total, allTransactions, onClose, initialCategory, onViewEditor, headerImage, onUpload }) => {
            const [isFilterSheetOpen, setIsFilterSheetOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isTimeDimensionSheetOpen, setIsTimeDimensionSheetOpen] = useState(false); 
            const [isLoading, setIsLoading] = useState(true);
            const [grouping, setGrouping] = useState('date'); 
            
            // üåü ‰øÆÂ§çÔºöÈªòËÆ§Êó∂Èó¥Áª¥Â∫¶ÈÄªËæë
            const [timeDimension, setTimeDimension] = useState(() => {
                if (type === 'today') return 'day';
                if (type === 'week') return 'day';   // Êú¨Âë® -> ÊåâÊó•Â±ïÁ§∫
                if (type === 'month') return 'day';  // Êú¨Êúà -> ÊåâÊó•Â±ïÁ§∫
                if (type === 'year') return 'month'; // Êú¨Âπ¥ -> ÊåâÊúàÂ±ïÁ§∫
                return 'day'; 
            });

            const swipeBack = useSwipeBack(onClose);

            useEffect(() => { const timer = setTimeout(() => setIsLoading(false), 500); return () => clearTimeout(timer); }, []);

            const getInitialFilters = () => {
                const now = new Date();
                let startDate = '', endDate = '';
                let cat = initialCategory || 'all'; 
                // Á≠õÈÄâËåÉÂõ¥ÂßãÁªàÂü∫‰∫é typeÔºå‰∏çÂèó timeDimension ÂΩ±Âìç
                if (type === 'today') { startDate = endDate = format(now, 'yyyy-MM-dd'); } 
                else if (type === 'week') { startDate = format(startOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd'); endDate = format(endOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd'); } 
                else if (type === 'year') { startDate = format(startOfYear(now), 'yyyy-MM-dd'); endDate = format(endOfYear(now), 'yyyy-MM-dd'); } 
                else if (type === 'month') { startDate = format(startOfMonth(now), 'yyyy-MM-dd'); endDate = format(endOfMonth(now), 'yyyy-MM-dd'); }
                return { startDate, endDate, category: cat, minAmount: '', maxAmount: '', keyword: '' };
            };
            
            // ÂàùÂßãÂåñ activeFiltersÔºåÂè™Âú® mount Êó∂ÊâßË°å‰∏ÄÊ¨°
            const [activeFilters, setActiveFilters] = useState(getInitialFilters);

            const handleSheetAction = (action) => { if (action === 'viewAll') { setActiveFilters({ startDate: '', endDate: '', category: 'all', minAmount: '', maxAmount: '', keyword: '' }); haptic(); } else if (action === 'openSidebar') { setIsSidebarOpen(true); haptic(); } };

            // ÂàáÊç¢Êó∂Èó¥Áª¥Â∫¶ÔºöÂè™ÊîπÂèòÂàÜÁªÑÊñπÂºè (timeDimension)Ôºå‰∏çÈáçÁΩÆÁ≠õÈÄâËåÉÂõ¥
            const handleDimensionSelect = (val) => {
                setTimeDimension(val);
                setGrouping('date');
                haptic();
            };

            const handleTimeClick = () => { 
                haptic('light'); 
                if (grouping === 'date') { 
                    setIsTimeDimensionSheetOpen(true); 
                } else { 
                    setGrouping('date'); 
                } 
            };

            const list = useMemo(() => { return allTransactions.filter(t => { const rawDate = getRawDateStr(t.date); if (!rawDate) return false; const amount = Math.abs(Number(t.amount || 0)); if (activeFilters.startDate && rawDate < activeFilters.startDate) return false; if (activeFilters.endDate && rawDate > activeFilters.endDate) return false; if (activeFilters.category !== 'all' && t.category !== activeFilters.category) return false; if (activeFilters.minAmount && amount < Number(activeFilters.minAmount)) return false; if (activeFilters.maxAmount && amount > Number(activeFilters.maxAmount)) return false; if (activeFilters.keyword) { const note = (t.note || '').toLowerCase(); const merchant = (t.merchant || '').toLowerCase(); const kw = activeFilters.keyword.toLowerCase(); if (!note.includes(kw) && !merchant.includes(kw)) return false; } return true; }).sort((a,b) => b.date.localeCompare(a.date)); }, [activeFilters, allTransactions]);
            
            const groupedData = useMemo(() => { 
                const groups = {}; 
                
                if (grouping === 'category') {
                    list.forEach(t => { const key = t.category || 'ÂÖ∂‰ªñ'; if (!groups[key]) groups[key] = { label: key, total: 0, items: [] }; groups[key].total += Math.abs(Number(t.amount || 0)); groups[key].items.push(t); });
                    return Object.values(groups).sort((a, b) => b.total - a.total);
                }

                // ÊåâÊó∂Èó¥Áª¥Â∫¶ÂàÜÁªÑ (day, week, month, year)
                list.forEach(t => { 
                    const dateStr = getRawDateStr(t.date); if (!dateStr) return; const dObj = new Date(dateStr); let key = ""; let label = ""; 
                    
                    if (timeDimension === 'day') { key = dateStr; label = format(dObj, 'MMÊúàddÊó•'); } 
                    else if (timeDimension === 'week') { const year = dObj.getFullYear(); const weekNum = getISOWeek(dObj); key = `${year}-W${weekNum}`; label = `Á¨¨${weekNum}Âë®`; } 
                    else if (timeDimension === 'year') { const year = dObj.getFullYear(); key = `${year}`; label = `${year}Âπ¥`; } 
                    else if (timeDimension === 'month') { const y = dObj.getFullYear(); const m = dObj.getMonth() + 1; key = `${y}-${m}`; label = `${m}Êúà`; } 
                    
                    if (!groups[key]) { groups[key] = { label, total: 0, items: [] }; } 
                    groups[key].total += Math.abs(Number(t.amount || 0)); groups[key].items.push(t); 
                }); 
                return Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).map(([k,v]) => v); 
            }, [list, timeDimension, grouping]);

            const currentTotal = useMemo(() => list.reduce((sum, t) => sum + Math.abs(Number(t.amount || 0)), 0), [list]);
            
            const displayTitle = useMemo(() => { 
                if (grouping === 'category') return `${activeFilters.category === 'all' ? 'ÂÖ®ÈÉ®ÂàÜÁ±ª' : activeFilters.category}ÊîØÂá∫`;
                // ÊòæÁ§∫ÂΩìÂâçÁ≠õÈÄâÁöÑÊó∂Èó¥ËåÉÂõ¥ÊèêÁ§∫ÔºåËÄåÈùûÂàÜÁªÑÊñπÂºè
                if (type === 'today') return "‰ªäÂ§©";
                if (type === 'week') return "Êú¨Âë®";
                if (type === 'month') return "Êú¨Êúà";
                if (type === 'year') return "Êú¨Âπ¥";
                return "Á≠õÈÄâÁªìÊûú";
            }, [activeFilters, type, grouping]);
            
            const finalTitle = title || displayTitle;

            const getTimeLabel = () => { 
                switch(timeDimension) { 
                    case 'year': return 'ÊåâÂπ¥'; 
                    case 'month': return 'ÊåâÊúà'; 
                    case 'week': return 'ÊåâÂë®'; 
                    default: return 'ÊåâÊó•'; 
                } 
            };

            return (
                <div className="page-container page-enter-active pb-safe flex flex-col z-[100] bg-[#09090B] no-scrollbar shadow-2xl" style={swipeBack.style} {...swipeBack.bind}>
                    {/* ÂÜÖÂÆπÊªöÂä®Â±Ç */}
                    <div className="absolute inset-0 overflow-y-auto no-scrollbar pb-32"> 
                        <div className="relative h-[200px] w-full overflow-hidden shrink-0 transition-all duration-700 ease-out transform" style={{ opacity: isLoading ? 0.9 : 1, transform: isLoading ? 'scale(1.02)' : 'scale(1)' }}>
                            <img src={headerImage} className="absolute inset-0 w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-gradient-to-b from-black/70 via-black/40 to-[#09090B]"></div>
                            
                            {/* ‰∏ä‰º†ÊåâÈíÆ */}
                            <label className="absolute bottom-4 right-4 z-30 p-2 bg-black/30 backdrop-blur-md rounded-full text-white/70 hover:text-white transition-colors cursor-pointer active:scale-90">
                                <Camera size={18} />
                                <input type="file" accept="image/*" className="hidden" onChange={onUpload} />
                            </label>

                            <div className="absolute top-0 left-0 right-0 pt-safe px-4 h-[60px] flex items-center justify-between z-20">
                                <button onClick={swipeBack.triggerClose} className="p-2 -ml-2 text-white flex items-center gap-1 active:opacity-60 transition-opacity">
                                    <ArrowLeft size={24} /> <span className="text-[17px] font-medium tracking-wide truncate max-w-[200px] text-white/90">{finalTitle}</span>
                                </button>
                                <button onClick={() => {}} className="p-2 text-white/90 active:opacity-60"><Plus size={26} /></button>
                            </div>
                            <div className="absolute bottom-10 left-6 z-20 animate-slide-up" style={{ animationDelay: '0.1s' }}>
                                <div className="text-[12px] text-white/70 font-medium mb-1 tracking-widest uppercase">ÊÄªÊîØÂá∫</div>
                                <div className="text-[48px] font-bold text-white font-mono tracking-tighter leading-none -ml-1">-{formatMoney(currentTotal)}</div>
                            </div>
                        </div>
                        
                        <div className="flex-1 relative z-30 -mt-6">
                            <div className="bg-[#121212] rounded-t-[32px] min-h-full border-t border-[#2C2C2E] shadow-[0_-10px_40px_rgba(0,0,0,0.8)] backdrop-blur-xl">
                                <div className="flex justify-between items-center mb-4 pt-5 px-6">
                                    <span className="text-[13px] text-art-textSub font-medium tracking-wide">{list.length === allTransactions.length ? "ÂÖ®ÈÉ®ÊòéÁªÜ" : "Á≠õÈÄâÁªìÊûú"}</span>
                                    <button onClick={() => { setIsFilterSheetOpen(true); haptic(); }} className="text-[13px] text-art-accent flex items-center gap-1 active:opacity-60 font-medium bg-art-accent/10 px-3 py-1.5 rounded-full">{list.length === allTransactions.length ? "Á≠õÈÄâ" : "Êü•ÁúãÂÖ®ÈÉ®"} <ChevronRight size={12}/></button>
                                </div>
                                {isLoading ? <div className="px-4"><Skeleton /></div> : (
                                    <div className="pb-8">
                                        {groupedData.length === 0 ? (
                                            <div className="text-center py-20 text-art-textSub opacity-50 flex flex-col items-center animate-fade-in"><div className="text-4xl mb-3">üçÉ</div><div className="text-[15px]">ÊöÇÊó†ËÆ∞ÂΩï</div></div>
                                        ) : (
                                            groupedData.map((group, idx) => (
                                                <TransactionGroup 
                                                    key={idx} 
                                                    label={group.label} 
                                                    total={group.total} 
                                                    transactions={group.items} 
                                                    // Âè™ÊúâÂú® timeDimension ‰∏∫ 'day' Êó∂ÔºåÊâç‰ΩøÁî® groupByDay (Â±ïÁ§∫Êó•ÊúüÊòéÁªÜ)
                                                    groupByDay={timeDimension !== 'day'} 
                                                    groupType={grouping}
                                                    onViewEditor={onViewEditor} 
                                                />
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* üåü 2. Â∫ïÈÉ®Âõ∫ÂÆöÂàáÊç¢Ê†è (ÂÖ®Èù¢Â±èÈÄöÊ†èËÆæËÆ°) */}
                    <div className="absolute bottom-0 left-0 right-0 z-[60] bg-[#1C1C1E] border-t border-white/5 pb-safe">
                        <div className="flex h-[50px]">
                            <button 
                                onClick={handleTimeClick}
                                className={`flex-1 flex items-center justify-center text-[15px] font-medium transition-colors duration-200 gap-1 border-r border-white/5 ${grouping === 'date' ? 'text-white bg-white/5' : 'text-art-textSub'}`}
                            >
                                {grouping === 'date' ? getTimeLabel() : 'Êó∂Èó¥'}
                                {grouping === 'date' && <ChevronDown size={14} className="ml-1 opacity-50"/>} 
                            </button>
                            <button 
                                onClick={() => { setGrouping('category'); haptic('light'); }}
                                className={`flex-1 flex items-center justify-center text-[15px] font-medium transition-colors duration-200 ${grouping === 'category' ? 'text-white bg-white/5' : 'text-art-textSub'}`}
                            >
                                ÂàÜÁ±ª
                            </button>
                        </div>
                    </div>

                    <TimeDimensionSheet isOpen={isTimeDimensionSheetOpen} onClose={() => setIsTimeDimensionSheetOpen(false)} selected={timeDimension} onSelect={handleDimensionSelect} />
                    <FilterSheet isOpen={isFilterSheetOpen} onClose={() => setIsFilterSheetOpen(false)} dateRange={activeFilters.startDate ? `${activeFilters.startDate} Ëá≥ ${activeFilters.endDate || '‰ªä'}` : 'ÂÖ®ÈÉ®Êó∂Èó¥'} onModify={handleSheetAction} />
                    <FilterSidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} currentFilters={activeFilters} onApply={setActiveFilters} />
                </div>
            );
        };

        const EditorPage = ({ transaction, onClose, onSave, onDelete }) => {
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isDateSheetOpen, setIsDateSheetOpen] = useState(false);
            const [isTimeSheetOpen, setIsTimeSheetOpen] = useState(false);
            const [isCategorySheetOpen, setIsCategorySheetOpen] = useState(false); 
            const [shakeError, setShakeError] = useState(false); 
            const swipeBack = useSwipeBack(onClose);

            useEffect(() => { const timer = setTimeout(() => setIsLoading(false), 300); return () => clearTimeout(timer); }, []);
            const getInitialTime = () => { if (transaction) return getRawTimeStr(transaction.date); return getBeijingTime(); };
            const [form, setForm] = useState({ amount: transaction ? Math.abs(transaction.amount) : '', merchant: transaction ? transaction.merchant : '', category: transaction ? transaction.category : 'È§êÈ•Æ', date: transaction ? getRawDateStr(transaction.date) : new Date().toISOString().split('T')[0], time: getInitialTime(), note: transaction ? (transaction.note || '') : '' });
            const [loading, setLoading] = useState(false);
            const handleSave = async () => { if (!form.amount) { setShakeError(true); haptic('error'); setTimeout(() => setShakeError(false), 500); return; } setLoading(true); const isoDateTime = `${form.date}T${form.time}:00.000Z`; await onSave({ ...form, date: isoDateTime }, transaction?.id); setLoading(false); };
            const handleConfirmDelete = () => { onDelete(transaction.id); };
            const currentCategoryColor = getCategoryColor(form.category);

            return (
                <div className="page-container page-enter-active flex flex-col z-[100] shadow-2xl bg-black" style={swipeBack.style} {...swipeBack.bind}>
                    <ConfirmDialog isOpen={showDeleteConfirm} onCancel={() => setShowDeleteConfirm(false)} onConfirm={handleConfirmDelete} title="Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü" message="Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºåÊï∞ÊçÆÂ∞ÜË¢´Ê∞∏‰πÖÁßªÈô§„ÄÇ" />
                    <CustomDatePickerSheet isOpen={isDateSheetOpen} onClose={() => setIsDateSheetOpen(false)} currentDateStr={form.date} onSelect={(val) => setForm({...form, date: val})} />
                    <CustomTimePickerSheet isOpen={isTimeSheetOpen} onClose={() => setIsTimeSheetOpen(false)} currentTimeStr={form.time} onSelect={(val) => setForm({...form, time: val})} />
                    <CategoryPickerSheet isOpen={isCategorySheetOpen} onClose={() => setIsCategorySheetOpen(false)} selected={form.category} onSelect={(val) => { setForm({...form, category: val}); haptic('light'); }} />

                    {/* üåü ÊÅ¢Â§çÈ°∂ÈÉ®È´òÁ∫ßÂÖâÊïà */}
                    <div className="relative w-full overflow-hidden shrink-0 transition-all duration-500 ease-out" style={{ height: '340px', opacity: isLoading ? 0.5 : 1 }}>
                        <div className={`absolute inset-0 bg-gradient-to-b ${currentCategoryColor.gradient} via-black/80 to-[#09090B] opacity-40`}></div>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 mix-blend-overlay"></div>
                        
                        <div className="absolute top-0 left-0 right-0 pt-safe px-4 h-[60px] flex items-center justify-between z-20">
                            <button onClick={swipeBack.triggerClose} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 backdrop-blur-md active:bg-white/10 transition-colors text-white"><ArrowLeft size={20} /></button>
                            
                            {/* üåü ‰ºòÂåñÂè≥‰∏äËßíÊåâÈíÆÔºöÁôΩËâ≤ËÉ∂ÂõäÊ†∑Âºè */}
                            <button 
                                onClick={handleSave} 
                                className="px-4 py-1.5 rounded-full bg-white text-black font-bold text-[13px] active:scale-95 transition-transform flex items-center gap-1.5 shadow-lg border border-white/20"
                            >
                                {loading && <Loader2 size={12} className="animate-spin" />}
                                {transaction ? 'Êõ¥Êñ∞' : 'ÂÆåÊàê'}
                            </button>
                        </div>

                        {/* ÂõæÊ†á‰∏éÈáëÈ¢ùÂ±Ö‰∏≠ */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center pt-12 z-10 animate-bounce-in pointer-events-none"> 
                            {/* ÂàÜÁ±ªÂõæÊ†á */}
                            <div onClick={() => setIsCategorySheetOpen(true)} className={`w-16 h-16 rounded-full flex items-center justify-center mb-8 shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)] ${currentCategoryColor.bg} ${currentCategoryColor.text} border border-white/10 backdrop-blur-xl pointer-events-auto active:scale-90 transition-transform cursor-pointer`}>
                                {React.cloneElement(getCategoryIcon(form.category), { size: 32, strokeWidth: 1.5 })}
                            </div>
                            
                            {/* ÈáëÈ¢ùËæìÂÖ• */}
                            <div className={`flex items-baseline justify-center w-full px-8 relative pointer-events-auto ${shakeError ? 'animate-shake text-red-500' : ''}`}> 
                                <span className={`text-[32px] font-light absolute left-8 top-2 transition-colors ${shakeError ? 'text-red-500/50' : 'text-white/40'}`}>¬•</span>
                                <input 
                                    type="number" 
                                    value={form.amount} 
                                    onChange={(e) => setForm({...form, amount: e.target.value})} 
                                    placeholder="0.00" 
                                    className={`w-full bg-transparent text-[56px] font-bold placeholder-white/10 font-mono text-center outline-none caret-art-accent tracking-tighter transition-colors ${shakeError ? 'text-red-500' : 'text-white'}`} 
                                    autoFocus={!transaction} 
                                />
                            </div>
                        </div>
                    </div>
                    
                    {/* üî• ‰øÆÂ§çÔºöÊîπ‰∏∫ overflow-hidden Á¶ÅÊ≠¢ÊªëÂä®ÔºåÂõ∫ÂÆöÊòæÁ§∫ */}
                    <div className="flex-1 -mt-8 relative z-30 animate-slide-up-stagger overflow-hidden">
                        <div className="bg-[#121212] rounded-t-[32px] h-full border-t border-[#2C2C2E] p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] backdrop-blur-xl">
                            
                            <div className="mb-4">
                                <h4 className="text-[11px] text-white/30 font-bold mb-3 ml-1 uppercase tracking-widest flex items-center gap-2"><PenLine size={10} /> Details</h4>
                                <div className="bg-[#1C1C1E] rounded-[24px] border border-white/5 overflow-hidden">
                                    
                                    {/* ÂàÜÁ±ª */}
                                    <div className="flex items-center justify-between px-5 py-3.5 border-b border-white/5 active:bg-white/5 transition-colors cursor-pointer" onClick={() => setIsCategorySheetOpen(true)}>
                                        <div className="flex items-center gap-4">
                                            <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/50"><Tag size={16} /></div>
                                            <span className="text-[15px] text-art-textSub">ÂàÜÁ±ª</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[17px] text-white font-medium">{form.category}</span>
                                            <ChevronRight size={16} className="text-white/30" />
                                        </div>
                                    </div>

                                    {/* Êó•Êúü */}
                                    <div className="flex items-center justify-between px-5 py-3.5 border-b border-white/5 active:bg-white/5 transition-colors cursor-pointer" onClick={() => setIsDateSheetOpen(true)}>
                                        <div className="flex items-center gap-4">
                                            <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/50"><CalendarDays size={16} /></div>
                                            <span className="text-[15px] text-art-textSub">Êó•Êúü</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[17px] text-white font-medium">{form.date}</span>
                                            <ChevronRight size={16} className="text-white/30" />
                                        </div>
                                    </div>

                                    {/* Êó∂Èó¥ */}
                                    <div className="flex items-center justify-between px-5 py-3.5 border-b border-white/5 active:bg-white/5 transition-colors cursor-pointer" onClick={() => setIsTimeSheetOpen(true)}>
                                        <div className="flex items-center gap-4">
                                            <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/50"><Clock size={16} /></div>
                                            <span className="text-[15px] text-art-textSub">Êó∂Èó¥</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[17px] text-white font-medium">{form.time}</span>
                                            <ChevronRight size={16} className="text-white/30" />
                                        </div>
                                    </div>

                                    {/* ÂïÜÊà∑ */}
                                    <div className="flex items-center px-5 py-3.5 border-b border-white/5 group transition-colors hover:bg-white/5">
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-4 text-white/50"><ShoppingBag size={16} /></div>
                                        <div className="flex-1">
                                            <div className="text-[11px] text-white/40 mb-0.5">ÂïÜÊà∑</div>
                                            <input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} placeholder="ËæìÂÖ•ÂïÜÊà∑ÂêçÁß∞ÔºàÂèØÈÄâÔºâ" className="w-full bg-transparent text-[15px] text-white focus:outline-none placeholder-white/20 font-medium" />
                                        </div>
                                    </div>

                                    {/* Â§áÊ≥® */}
                                    <div className="flex items-start px-5 py-3.5 group transition-colors hover:bg-white/5">
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-4 text-white/50 mt-0.5"><MessageCircle size={16} /></div>
                                        <div className="flex-1">
                                            <div className="text-[11px] text-white/40 mb-0.5">Â§áÊ≥®</div>
                                            <textarea rows="2" value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} placeholder="Ê∑ªÂä†Â§áÊ≥®..." className="w-full bg-transparent text-[15px] text-white focus:outline-none placeholder-white/20 font-medium resize-none" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Âà†Èô§ÊåâÈíÆ */}
                            {transaction && (
                                <div className="pt-2 flex justify-center">
                                    <button onClick={() => setShowDeleteConfirm(true)} className="text-[#FF453A] text-[13px] font-medium active:opacity-60 transition-opacity flex items-center gap-2 py-2 px-4 rounded-full hover:bg-white/5">
                                        <Trash2 size={14} /> Âà†Èô§ËÆ∞ÂΩï
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SplashScreen = ({ onFinish }) => {
            const [isFading, setIsFading] = useState(false);
            useEffect(() => { const timer1 = setTimeout(() => setIsFading(true), 2800); const timer2 = setTimeout(onFinish, 3300); return () => { clearTimeout(timer1); clearTimeout(timer2); }; }, [onFinish]);
            return (
                <div className={`fixed inset-0 z-[9999] bg-[#000000] flex flex-col items-center justify-center transition-all duration-700 ease-out overflow-hidden ${isFading ? 'opacity-0 scale-110 blur-sm' : 'opacity-100 scale-100'}`}>
                    <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-blue-600/20 rounded-full blur-[120px] animate-pulse-slow"></div>
                    <div className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-art-cyan/10 rounded-full blur-[120px] animate-pulse-slow" style={{animationDelay: '1.5s'}}></div>
                    <div className="relative z-10 flex flex-col items-center">
                        <div className="relative mb-10 animate-bounce-in">
                            <div className="absolute inset-0 bg-gradient-to-tr from-art-cyan to-blue-600 rounded-[36px] blur-2xl opacity-40"></div>
                            <div className="w-32 h-32 bg-[#121212]/40 backdrop-blur-2xl rounded-[36px] border border-white/10 flex items-center justify-center shadow-2xl relative z-10 ring-1 ring-white/5 group">
                                <Wallet size={56} className="text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] transition-transform duration-700 group-hover:scale-110" strokeWidth={1.2} />
                                <div className="absolute inset-0 rounded-[36px] bg-gradient-to-tr from-white/10 to-transparent opacity-50"></div>
                            </div>
                        </div>
                        <div className="text-center space-y-4">
                            <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-white/50 tracking-wider animate-slide-up" style={{animationDelay: '0.2s'}}>AI ÈöèÊâãËÆ∞</h1>
                            <div className="h-[1px] w-12 bg-gradient-to-r from-transparent via-white/30 to-transparent mx-auto animate-scale-x" style={{animationDelay: '0.4s'}}></div>
                            <p className="text-art-textSub text-[10px] tracking-[0.4em] uppercase font-medium animate-slide-up pl-1" style={{animationDelay: '0.5s'}}>Intelligent Finance</p>
                        </div>
                    </div>
                    <div className="absolute bottom-16 flex flex-col items-center gap-4 animate-fade-in" style={{animationDelay: '0.8s'}}>
                        <div className="w-32 h-[2px] bg-white/5 rounded-full overflow-hidden relative"><div className="absolute inset-0 bg-gradient-to-r from-transparent via-art-cyan to-transparent w-1/2 h-full rounded-full animate-shimmer"></div></div>
                        <p className="text-[9px] text-white/20 font-mono tracking-widest">VERSION 1.3.0</p>
                    </div>
                </div>
            );
        };

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [toast, setToast] = useState(null);
            const [view, setView] = useState({ name: 'main' }); 
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, id: null });
            const [pullY, setPullY] = useState(0);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [headerImage, setHeaderImage] = useState(() => {
                return localStorage.getItem('custom_header_image') || "https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop";
            });
            const startY = useRef(0);
            const scrollContainerRef = useRef(null);

            const showToast = (msg, type = 'success') => { setToast({ message: msg, type }); setTimeout(() => setToast(null), 2000); };
            useEffect(() => { fetchTransactions(); const sub = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, fetchTransactions).subscribe(); return () => supabase.removeChannel(sub); }, [currentDate]);
            const fetchTransactions = async () => { if (!isRefreshing) setLoading(true); try { const start = startOfYear(currentDate); const end = endOfYear(currentDate); const { data, error } = await supabase.from('transactions').select('*').gte('date', start.toISOString()).lte('date', end.toISOString()).order('date', { ascending: false }); if (!error) setTransactions(data || []); } catch(e) { console.error("Fetch error:", e); } setLoading(false); };
            const handleTouchStart = (e) => { if (scrollContainerRef.current && scrollContainerRef.current.scrollTop === 0) { startY.current = e.touches[0].clientY; } else { startY.current = -1; } };
            const handleTouchMove = (e) => { if (startY.current === -1) return; const delta = e.touches[0].clientY - startY.current; if (delta > 0) setPullY(delta * 0.4); };
            const handleTouchEnd = async () => { if (startY.current === -1) return; if (pullY > 60) { setIsRefreshing(true); setPullY(60); haptic(); await fetchTransactions(); haptic(); setIsRefreshing(false); setPullY(0); } else setPullY(0); };
            const handleEditorSave = async (data, id) => { setLoading(true); try { const payload = { amount: parseFloat(data.amount), merchant: data.merchant || (data.category), category: data.category, date: data.date, note: data.note }; if (id) { const { error } = await supabase.from('transactions').update(payload).eq('id', id); if (error) throw error; showToast("Â∑≤Êõ¥Êñ∞"); } else { const { error } = await supabase.from('transactions').insert([payload]); if (error) throw error; showToast("ËÆ∞Ë¥¶ÊàêÂäü"); } setView({ name: 'main' }); fetchTransactions(); } catch (error) { console.error("Save failed:", error); showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï", 'error'); } finally { setLoading(false); } };
            const performDelete = async (id) => { await supabase.from('transactions').delete().eq('id', id); showToast("Â∑≤Âà†Èô§"); setTransactions(p => p.filter(t => t.id !== id)); if (view.name === 'editor' && view.transaction?.id === id) { setView({ name: 'main' }); } };
            const executeDelete = async () => { if (!confirmDialog.id) return; await performDelete(confirmDialog.id); setConfirmDialog({ isOpen: false, id: null }); };
            
            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Limit file size to prevent localStorage quota exceeded (e.g., 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showToast("ÂõæÁâáËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é2MBÁöÑÂõæÁâá", 'error');
                    return;
                }

                const uploadingToast = setTimeout(() => showToast("Ê≠£Âú®Â§ÑÁêÜ...", 'success'), 100);

                try {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        
                        // Update State & Storage
                        setHeaderImage(base64String);
                        try {
                            localStorage.setItem('custom_header_image', base64String);
                            showToast("Â∞ÅÈù¢Êõ¥Êñ∞ÊàêÂäü");
                        } catch (e) {
                            console.error("Local storage error:", e);
                            showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåÂõæÁâáÂèØËÉΩËøáÂ§ß", 'error');
                        }
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Upload failed:', error);
                    showToast("‰∏ä‰º†Â§±Ë¥•", 'error');
                } finally {
                    clearTimeout(uploadingToast);
                }
            };

            const stats = useMemo(() => { const now = new Date(); const todayStr = format(now, 'yyyy-MM-dd'); const startOfWeekStr = format(startOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd'); const endOfWeekStr = format(endOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd'); const currentMonthStr = format(now, 'yyyy-MM'); const currentYearStr = format(now, 'yyyy'); const sum = (list) => list.reduce((acc, t) => acc + Math.abs(Number(t.amount || 0)), 0); const todayTrans = transactions.filter(t => getRawDateStr(t.date) === todayStr); const weekTrans = transactions.filter(t => { const d = getRawDateStr(t.date); return d >= startOfWeekStr && d <= endOfWeekStr; }); const monthTrans = transactions.filter(t => getRawDateStr(t.date).startsWith(currentMonthStr)); const yearTrans = transactions.filter(t => getRawDateStr(t.date).startsWith(currentYearStr)); return { monthTotal: sum(monthTrans), todayTotal: sum(todayTrans), weekTotal: sum(weekTrans), yearTotal: sum(yearTrans) }; }, [transactions]);
            const groupedByMonth = useMemo(() => { const groups = {}; transactions.forEach(t => { const dateStr = getRawDateStr(t.date); if (!dateStr) return; const [y, m, d] = dateStr.split('-'); const monthKey = `${y}-${m}`; if (!groups[monthKey]) { groups[monthKey] = { year: y, month: m, totalExpense: 0, days: {} }; } groups[monthKey].totalExpense += Math.abs(Number(t.amount || 0)); if (!groups[monthKey].days[dateStr]) { groups[monthKey].days[dateStr] = []; } groups[monthKey].days[dateStr].push(t); }); return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).map(([key, data]) => ({ key, ...data, daysSorted: Object.entries(data.days).sort((a, b) => b[0].localeCompare(a[0])) })); }, [transactions]);
            const handleCategoryClick = (category) => { setView({ name: 'period', title: `Êú¨Êúà¬∑${category}`, type: 'month', total: 0, initialCategory: category }); };

            if (showSplash) return <SplashScreen onFinish={() => setShowSplash(false)} />;

            return (
                <div className="h-full w-full bg-art-bg text-art-textMain font-sans relative overflow-hidden" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <Toast message={toast?.message} type={toast?.type} />
                    <ConfirmDialog isOpen={confirmDialog.isOpen} onCancel={() => setConfirmDialog({ isOpen: false, id: null })} onConfirm={executeDelete} title="Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü" message="Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºåÊï∞ÊçÆÂ∞ÜË¢´Ê∞∏‰πÖÁßªÈô§„ÄÇ" />
                    
                    {/* ‰∏ãÊãâÂà∑Êñ∞ÊåáÁ§∫Âô® */}
                    <div className="absolute top-[60px] left-0 w-full flex justify-center pointer-events-none z-[100] transition-opacity duration-300" style={{ transform: `translateY(${pullY * 0.5}px)`, opacity: pullY > 20 ? 1 : 0 }}>
                        <div className="bg-[#2C2C2E] p-2.5 rounded-full shadow-lg border border-white/10"><Loader2 className={`text-white ${isRefreshing ? 'animate-spin' : ''}`} size={20} style={{ transform: `rotate(${pullY * 2}deg)` }} /></div>
                    </div>

                    {/* üî• Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏ªÁïåÈù¢ÂÆπÂô®‰∏çÂÜçÁº©ÊîæÔºå‰øùÊåÅÂÖ®Â±è‰∏îÈùôÊÄÅ */}
                    <div className="h-full w-full overflow-hidden bg-art-bg">
                        <main ref={scrollContainerRef} className="h-full w-full overflow-y-auto no-scrollbar pb-safe transition-transform duration-300 ease-out" style={{ transform: `translateY(${pullY}px)` }}>
                            {activeTab === 'home' && (
                                <div className="animate-fade-in">
                                    <div className="pt-safe px-5 h-[20px] mb-2"></div>
                                    <div className="mx-4 h-[140px] rounded-[32px] relative overflow-hidden shadow-2xl mb-6 group">
                                        <img src={headerImage} className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" />
                                        <div className="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/80"></div>
                                        <div className="absolute top-6 left-6 z-10">
                                            <div className="text-[14px] text-white/70 font-medium mb-1">Êú¨ÊúàÊî∂ÊîØÁªüËÆ°</div>
                                            <div className="text-[12px] text-white/50">ÊÄªÊîØÂá∫</div>
                                            <div className="text-[42px] font-bold text-white font-mono tracking-tighter leading-none -ml-1">{formatMoney(stats.monthTotal)}</div>
                                        </div>
                                        
                                        {/* ‰∏ªÈ°µÈ°∂ÈÉ®ÂõæÁâá‰∏ä‰º†ÊåâÈíÆ */}
                                        <label className="absolute bottom-4 right-4 z-30 p-2 bg-black/30 backdrop-blur-md rounded-full text-white/70 hover:text-white transition-colors cursor-pointer active:scale-90">
                                            <Camera size={16} />
                                            <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                        </label>
                                    </div>

                                    <div className="mx-4 space-y-3 mb-6">
                                        <div onClick={() => setView({ name: 'period', title: `‰ªäÂ§© ${format(new Date(), 'MÊúàdÊó•')}`, type: 'today', total: stats.todayTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                            <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-green-500 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.5)]"></div><div><div className="text-[15px] font-bold text-white">‰ªäÂ§©</div><div className="text-[12px] text-art-textSub">{new Date().getMonth()+1}Êúà{new Date().getDate()}Êó•</div></div></div>
                                            <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.todayTotal)}</div></div>
                                        </div>

                                        <div onClick={() => { const start = startOfWeek(new Date(), { weekStartsOn: 1 }); const end = endOfWeek(new Date(), { weekStartsOn: 1 }); setView({ name: 'period', title: `Êú¨Âë® ${format(start, 'M.d')}-${format(end, 'M.d')}`, type: 'week', total: stats.weekTotal }); }} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                            <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div><div><div className="text-[15px] font-bold text-white">Êú¨Âë®</div><div className="text-[12px] text-art-textSub">{format(startOfWeek(new Date(), { weekStartsOn: 1 }), 'MMÊúàddÊó•')} - {format(endOfWeek(new Date(), { weekStartsOn: 1 }), 'MMÊúàddÊó•')}</div></div></div>
                                            <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.weekTotal)}</div></div>
                                        </div>

                                        <div onClick={() => setView({ name: 'period', title: `Êú¨Âπ¥ ${new Date().getFullYear()}`, type: 'year', total: stats.yearTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                            <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-yellow-500 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div><div><div className="text-[15px] font-bold text-white">Êú¨Âπ¥</div><div className="text-[12px] text-art-textSub">{new Date().getFullYear()}Âπ¥</div></div></div>
                                            <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.yearTotal)}</div></div>
                                        </div>
                                    </div>

                                    <MonthlyStats transactions={transactions} currentDate={currentDate} onCategoryClick={handleCategoryClick} />
                                </div>
                            )}
                            {activeTab === 'flow' && (
                                <div className="pb-24 animate-fade-in">
                                    {/* ‰ºòÂåñÂêéÁöÑÈ°∂ÈÉ®ÂõæÁâáÂå∫ÂüüÔºöÊó†Â∫ïÈÉ®ËæπË∑ù */}
                                    <div className="relative h-[140px] w-full overflow-hidden shrink-0">
                                        <img src={headerImage} className="absolute inset-0 w-full h-full object-cover" />
                                        <div className="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-[#000000]"></div>
                                        
                                        <label className="absolute bottom-4 right-4 z-30 p-2 bg-black/30 backdrop-blur-md rounded-full text-white/70 hover:text-white transition-colors cursor-pointer active:scale-90">
                                            <Camera size={16} />
                                            <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                        </label>

                                        <div className="absolute top-0 left-0 right-0 h-full flex flex-col justify-end p-6 pb-4 z-10 pt-safe">
                                            <div className="text-[18px] font-bold text-white mb-3">Ë¥¶ÂçïÊµÅÊ∞¥</div>
                                            <div className="text-[12px] text-white/60 mb-0.5">ÊÄªÊîØÂá∫</div>
                                            <div className="text-[40px] font-bold text-white font-mono tracking-tighter leading-none -ml-1">-{formatMoney(transactions.reduce((acc, t) => acc + Math.abs(Number(t.amount)), 0))}</div>
                                        </div>
                                    </div>

                                    {/* ‰ºòÂåñÂêéÁöÑÂàóË°®ÔºöÊó†ÂÜÖËæπË∑ùÔºåÁ¥ßÂáëÊéíÂàó */}
                                    <div className="w-full">
                                        {groupedByMonth.map((monthGroup) => (<MonthGroup key={monthGroup.key} year={monthGroup.year} month={monthGroup.month} totalExpense={monthGroup.totalExpense} days={monthGroup.daysSorted} onViewEditor={(t) => setView({ name: 'editor', transaction: t })} />))}
                                        {transactions.length === 0 && (<div className="flex flex-col items-center justify-center pt-20 opacity-40"><div className="text-4xl mb-3">üçÉ</div><p className="text-art-textSub">ÊöÇÊó†ÊµÅÊ∞¥ËÆ∞ÂΩï</p></div>)}
                                    </div>
                                </div>
                            )}
                        </main>
                        <nav className="fixed bottom-0 w-full bg-[#121212]/95 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 z-40">
                            <div className="grid grid-cols-3 h-[50px] relative text-[10px] font-medium text-art-textSub">
                                <button onClick={() => setActiveTab('flow')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='flow' ? 'text-white' : ''}`}><FileText size={22} strokeWidth={activeTab==='flow'?2.5:2} /> ÊµÅÊ∞¥</button>
                                <div className="flex flex-col items-center justify-end pb-1 opacity-50" onClick={() => { setView({ name: 'editor', transaction: null }); haptic('light'); }}><span>ËÆ∞‰∏ÄÁ¨î</span></div>
                                <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='home' ? 'text-white' : ''}`}><Layers size={22} strokeWidth={activeTab==='home'?2.5:2} /> Êä•Ë°®</button>
                            </div>
                        </nav>
                        <div className="fixed bottom-[30px] left-1/2 -translate-x-1/2 z-50">
                            <button onClick={() => { setView({ name: 'editor', transaction: null }); haptic('light'); }} className="w-[56px] h-[56px] bg-[#E9E9EB] rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(255,255,255,0.2)] active:scale-90 transition-transform text-black border-4 border-[#121212]"><Plus size={28} strokeWidth={2.5} /></button>
                        </div>
                    </div>

                    {/* üî• Ê†∏ÂøÉ‰øÆÊîπÔºöOverlays (Ë¶ÜÁõñÂ±Ç) Áã¨Á´ãÊ∏≤ÊüìÂú®ÊúÄÂ§ñÂ±ÇÔºåÂΩ¢ÊàêÂ±ÇÁ∫ßÁªìÊûÑ */}
                    {view.name === 'editor' && (
                        <EditorPage transaction={view.transaction} onClose={()=>setView({name:'main'})} onSave={handleEditorSave} onDelete={performDelete} />
                    )}
                    {view.name === 'period' && (
                        <PeriodPage 
                            title={view.title} 
                            type={view.type} 
                            total={view.total} 
                            allTransactions={transactions} 
                            onClose={()=>setView({name:'main'})} 
                            initialCategory={view.initialCategory} 
                            onViewEditor={(t) => setView({ name: 'editor', transaction: t })} 
                            headerImage={headerImage}
                            onUpload={handleImageUpload}
                        />
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
