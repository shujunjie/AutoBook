<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>AI ÈöèÊâãËÆ∞</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        art: {
                            bg: '#000000',      // Á∫ØÈªëËÉåÊôØ
                            card: '#1C1C1E',    // ÊûÅÊ∑±ÁÅ∞Âç°Áâá (iOS System Gray 6)
                            cardLight: '#2C2C2E', // Á®ç‰∫Æ (iOS System Gray 5)
                            accent: '#4ADE80',  // ÁªøËâ≤/ÈùíËâ≤ÁÇπÁºÄ
                            cyan: '#2DD4BF',    // Âõæ2‰∏≠ÁöÑÈùíËâ≤
                            blue: '#40C4FF',    // ‰ªøÂõæ1ÁöÑÈáëÈ¢ùËìù
                            textMain: '#FFFFFF',
                            textSub: '#8E8E93',
                            border: '#2C2C2E',
                        }
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-out-right': 'slideOutRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'fade-out': 'fadeOut 0.5s ease-in forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up-stagger': 'slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        slideOutRight: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0', visibility: 'hidden' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(0)' },
                            '100%': { transform: 'translateY(100%)' },
                        },
                        slideUpFade: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>

    <style>
        /* ÂÖ®Â±ÄÈöêËóèÊªöÂä®Êù°ÈÄªËæë */
        html, body, #root {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            background-color: #000000;
        }

        .no-scrollbar {
            -ms-overflow-style: none;  
            scrollbar-width: none; 
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none; 
        }

        .ios-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        body {
            color: #FFFFFF;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 44px); }
        input:focus, textarea:focus { outline: none; }
        
        .page-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            overflow-x: hidden; 
            background-color: #000000;
            z-index: 50;
            -webkit-overflow-scrolling: touch;
        }
        .page-enter { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .glass-nav {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { 
            Home, PieChart, Plus, X, Loader2, Save, Trash2, 
            CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Search, 
            Utensils, Car, ShoppingBag, Gamepad2, Home as HomeIcon, 
            HeartPulse, Banknote, FileText, TrendingUp, Calendar, 
            LayoutGrid, ArrowLeft, Video, MessageCircle, Wallet, ChevronDown, Layers,
            Users, Settings, Clock, Filter, Check, Trophy, Sparkles, Tag, PenLine, CalendarDays
        } from 'lucide-react';
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, isSameDay, format, parseISO, getDaysInMonth, getISOWeek, addMonths, subMonths, setMonth, setYear } from 'date-fns';

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatMoney = (amount) => Math.abs(Number(amount)).toFixed(2);
        
        const haptic = (type = 'light') => {
            if (window.navigator && window.navigator.vibrate) {
                if (type === 'light') window.navigator.vibrate(10);
                else window.navigator.vibrate(20);
            }
        };

        const getCategoryIcon = (category) => {
            const size = 18;
            switch (category) {
                case 'È§êÈ•Æ': return <Utensils size={size} />;
                case '‰∫§ÈÄö': return <Car size={size} />;
                case 'Ë¥≠Áâ©': return <ShoppingBag size={size} />;
                case 'Â®±‰πê': return <Gamepad2 size={size} />;
                case 'Â±Ö‰Ωè': return <HomeIcon size={size} />;
                case 'ÂåªÁñó': return <HeartPulse size={size} />;
                case 'Â∑•ËµÑ': return <Banknote size={size} />;
                default: return <FileText size={size} />;
            }
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case 'È§êÈ•Æ': return { bg: 'bg-[#FF453A]/20', text: 'text-[#FF453A]', gradient: 'from-[#FF453A]/80 to-[#FF453A]/10' }; 
                case '‰∫§ÈÄö': return { bg: 'bg-[#0A84FF]/20', text: 'text-[#0A84FF]', gradient: 'from-[#0A84FF]/80 to-[#0A84FF]/10' }; 
                case 'Ë¥≠Áâ©': return { bg: 'bg-[#FFD60A]/20', text: 'text-[#FFD60A]', gradient: 'from-[#FFD60A]/80 to-[#FFD60A]/10' }; 
                case 'Â®±‰πê': return { bg: 'bg-[#BF5AF2]/20', text: 'text-[#BF5AF2]', gradient: 'from-[#BF5AF2]/80 to-[#BF5AF2]/10' }; 
                case 'Â±Ö‰Ωè': return { bg: 'bg-[#64D2FF]/20', text: 'text-[#64D2FF]', gradient: 'from-[#64D2FF]/80 to-[#64D2FF]/10' }; 
                case 'ÂåªÁñó': return { bg: 'bg-[#FF375F]/20', text: 'text-[#FF375F]', gradient: 'from-[#FF375F]/80 to-[#FF375F]/10' }; 
                case 'Â∑•ËµÑ': return { bg: 'bg-[#30D158]/20', text: 'text-[#30D158]', gradient: 'from-[#30D158]/80 to-[#30D158]/10' }; 
                default: return { bg: 'bg-[#8E8E93]/20', text: 'text-[#8E8E93]', gradient: 'from-[#8E8E93]/80 to-[#8E8E93]/10' };    
            }
        };

        const categoriesList = ['È§êÈ•Æ', '‰∫§ÈÄö', 'Ë¥≠Áâ©', 'Â®±‰πê', 'Â±Ö‰Ωè', 'ÂåªÁñó', 'Â∑•ËµÑ', 'ÂÖ∂‰ªñ'];

        // --- Shared Helpers ---
        const getRawDateStr = (isoString) => {
            if (!isoString) return '';
            try {
                return isoString.split('T')[0];
            } catch (e) {
                return ''; 
            }
        };

        const getRawTimeStr = (isoString) => {
            if (!isoString) return '00:00';
            try {
                return isoString.split('T')[1].substring(0, 5);
            } catch (e) {
                return '00:00';
            }
        };

        const Toast = ({ message }) => {
            if (!message) return null;
            return (
                <div className="fixed top-safe left-1/2 -translate-x-1/2 z-[200] mt-4 animate-fade-in pointer-events-none">
                    <div className="flex items-center gap-2 px-4 py-2.5 rounded-full bg-[#333] shadow-xl border border-white/10">
                        <CheckCircle size={16} className="text-[#30D158]" />
                        <span className="text-[13px] font-medium text-white">{message}</span>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, onCancel, onConfirm, title = "Á°ÆËÆ§", message = "Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[999] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity animate-fade-in" onClick={onCancel}></div>
                    <div className="relative bg-[#1C1C1E] rounded-2xl w-full max-w-[280px] overflow-hidden shadow-2xl animate-fade-in transform transition-all scale-100">
                        <div className="p-6 text-center">
                            <h3 className="text-white font-bold text-[17px] mb-2">{title}</h3>
                            <p className="text-white/60 text-[13px] leading-relaxed">{message}</p>
                        </div>
                        <div className="grid grid-cols-2 border-t border-white/10">
                            <button 
                                onClick={onCancel} 
                                className="py-3.5 text-[17px] text-white/90 font-medium active:bg-white/10 border-r border-white/10 transition-colors"
                            >
                                ÂèñÊ∂à
                            </button>
                            <button 
                                onClick={onConfirm} 
                                className="py-3.5 text-[17px] text-[#FF453A] font-bold active:bg-white/10 transition-colors"
                            >
                                Âà†Èô§
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // üÜï Ëá™ÂÆö‰πâÊó•ÂéÜÈÄâÊã©Âô® (Bottom Sheet)
        const CustomDatePickerSheet = ({ isOpen, onClose, currentDateStr, onSelect }) => {
            if (!isOpen) return null;
            
            // State for calendar navigation
            const [viewDate, setViewDate] = useState(() => {
                return currentDateStr ? new Date(currentDateStr) : new Date();
            });

            // Effect to reset viewDate when modal opens
            useEffect(() => {
                if (isOpen) {
                    setViewDate(currentDateStr ? new Date(currentDateStr) : new Date());
                }
            }, [isOpen, currentDateStr]);

            const daysInMonth = getDaysInMonth(viewDate);
            const startDay = startOfMonth(viewDate).getDay(); // 0 is Sunday
            // Adjust so Monday is 0 if needed, but let's stick to Sunday = 0 for standard calc
            // If we want Monday start: (startDay + 6) % 7
            
            const weeks = [];
            let day = 1;
            let currentWeek = [];

            // Empty slots for previous month
            for (let i = 0; i < startDay; i++) {
                currentWeek.push(null);
            }

            while (day <= daysInMonth) {
                currentWeek.push(day);
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                day++;
            }
            if (currentWeek.length > 0) {
                while (currentWeek.length < 7) currentWeek.push(null);
                weeks.push(currentWeek);
            }

            const handleDayClick = (d) => {
                if (!d) return;
                const newDate = new Date(viewDate);
                newDate.setDate(d);
                onSelect(format(newDate, 'yyyy-MM-dd'));
                onClose();
            };

            const changeMonth = (delta) => {
                setViewDate(prev => {
                    const newD = new Date(prev);
                    newD.setMonth(newD.getMonth() + delta);
                    return newD;
                });
                haptic('light');
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©Êó•Êúü</h3>
                            <button onClick={onClose} className="p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button>
                        </div>

                        {/* Month Nav */}
                        <div className="flex items-center justify-between mb-4 bg-[#2C2C2E] rounded-xl p-2">
                            <button onClick={() => changeMonth(-1)} className="p-2 text-white/70 active:text-white"><ChevronLeft size={20} /></button>
                            <span className="text-[15px] font-bold text-white font-mono">{format(viewDate, 'yyyyÂπ¥ MMÊúà')}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 text-white/70 active:text-white"><ChevronRight size={20} /></button>
                        </div>

                        {/* Week Headers */}
                        <div className="grid grid-cols-7 mb-2 text-center">
                            {['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'].map(d => (
                                <div key={d} className="text-[12px] text-art-textSub py-2">{d}</div>
                            ))}
                        </div>

                        {/* Days Grid */}
                        <div className="space-y-1">
                            {weeks.map((week, wIdx) => (
                                <div key={wIdx} className="grid grid-cols-7 text-center">
                                    {week.map((d, dIdx) => {
                                        if (!d) return <div key={dIdx} />;
                                        
                                        // Check if this day matches selected date
                                        const isSelected = currentDateStr && 
                                            format(new Date(currentDateStr), 'yyyy-MM') === format(viewDate, 'yyyy-MM') && 
                                            parseInt(currentDateStr.split('-')[2]) === d;
                                        
                                        // Check if today
                                        const isToday = isSameDay(new Date(viewDate.getFullYear(), viewDate.getMonth(), d), new Date());

                                        return (
                                            <div key={dIdx} className="flex items-center justify-center py-1">
                                                <button 
                                                    onClick={() => handleDayClick(d)}
                                                    className={`w-9 h-9 rounded-full text-[14px] font-medium flex items-center justify-center transition-all active:scale-90
                                                        ${isSelected ? 'bg-white text-black font-bold shadow-lg' : isToday ? 'text-art-accent border border-art-accent/50' : 'text-white hover:bg-white/10'}
                                                    `}
                                                >
                                                    {d}
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // üÜï Ëá™ÂÆö‰πâÊó∂Èó¥ÈÄâÊã©Âô® (Bottom Sheet)
        const CustomTimePickerSheet = ({ isOpen, onClose, currentTimeStr, onSelect }) => {
            if (!isOpen) return null;

            const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
            const minutes = Array.from({ length: 60 }, (_, i) => String(i).padStart(2, '0'));

            const [selectedHour, setSelectedHour] = useState(currentTimeStr ? currentTimeStr.split(':')[0] : '00');
            const [selectedMinute, setSelectedMinute] = useState(currentTimeStr ? currentTimeStr.split(':')[1] : '00');

            useEffect(() => {
                if (isOpen && currentTimeStr) {
                    setSelectedHour(currentTimeStr.split(':')[0]);
                    setSelectedMinute(currentTimeStr.split(':')[1]);
                }
            }, [isOpen, currentTimeStr]);

            const handleConfirm = () => {
                onSelect(`${selectedHour}:${selectedMinute}`);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] pb-safe animate-slide-up border-t border-white/10 shadow-2xl flex flex-col h-[320px]">
                        <div className="flex justify-between items-center p-4 border-b border-white/10">
                            <button onClick={onClose} className="text-art-textSub text-[15px]">ÂèñÊ∂à</button>
                            <h3 className="text-[17px] font-bold text-white">ÈÄâÊã©Êó∂Èó¥</h3>
                            <button onClick={handleConfirm} className="text-art-accent font-bold text-[15px]">Á°ÆÂÆö</button>
                        </div>

                        <div className="flex-1 flex relative overflow-hidden">
                            {/* Selection Highlight */}
                            <div className="absolute top-1/2 left-0 right-0 h-[40px] -mt-[20px] bg-white/10 pointer-events-none z-0"></div>

                            {/* Hours */}
                            <div className="flex-1 overflow-y-auto no-scrollbar py-[120px] text-center snap-y snap-mandatory relative z-10">
                                {hours.map(h => (
                                    <div 
                                        key={h} 
                                        onClick={() => { setSelectedHour(h); haptic('light'); }}
                                        className={`h-[40px] flex items-center justify-center snap-center transition-all ${h === selectedHour ? 'text-white font-bold text-[20px]' : 'text-white/30 text-[16px]'}`}
                                    >
                                        {h}
                                    </div>
                                ))}
                            </div>

                            {/* Separator */}
                            <div className="flex items-center justify-center text-white/30 font-bold">:</div>

                            {/* Minutes */}
                            <div className="flex-1 overflow-y-auto no-scrollbar py-[120px] text-center snap-y snap-mandatory relative z-10">
                                {minutes.map(m => (
                                    <div 
                                        key={m} 
                                        onClick={() => { setSelectedMinute(m); haptic('light'); }}
                                        className={`h-[40px] flex items-center justify-center snap-center transition-all ${m === selectedMinute ? 'text-white font-bold text-[20px]' : 'text-white/30 text-[16px]'}`}
                                    >
                                        {m}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Skeleton = () => (
            <div className="animate-pulse space-y-5 px-1 mt-2">
                {[1, 2, 3, 4, 5, 6].map(i => (
                    <div key={i} className="flex items-center justify-between py-2">
                        <div className="flex items-center gap-4 w-full">
                            <div className="w-10 h-10 rounded-full bg-white/5"></div>
                            <div className="space-y-2 flex-1">
                                <div className="h-4 w-1/3 bg-white/5 rounded"></div>
                                <div className="h-3 w-1/4 bg-white/5 rounded"></div>
                            </div>
                            <div className="h-5 w-16 bg-white/5 rounded"></div>
                        </div>
                    </div>
                ))}
            </div>
        );

        // --- Components ---
        
        const SplashScreen = ({ onFinish }) => {
            const [isFading, setIsFading] = useState(false);

            useEffect(() => {
                const timer1 = setTimeout(() => setIsFading(true), 2200);
                const timer2 = setTimeout(onFinish, 2700);
                return () => { clearTimeout(timer1); clearTimeout(timer2); };
            }, [onFinish]);

            return (
                <div className={`fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-between pb-safe pt-safe transition-opacity duration-500 ${isFading ? 'opacity-0' : 'opacity-100'}`}>
                    <div className="flex-1 flex flex-col items-center justify-center">
                        <div className="relative mb-6">
                            <div className="absolute inset-0 bg-art-cyan blur-2xl opacity-20 animate-pulse-slow"></div>
                            <div className="w-24 h-24 bg-[#1C1C1E] rounded-[28px] border border-white/10 flex items-center justify-center shadow-2xl relative z-10">
                                <Wallet size={48} className="text-white" strokeWidth={1.5} />
                            </div>
                        </div>
                        <h1 className="text-2xl font-bold text-white tracking-wide mb-2">AI ÈöèÊâãËÆ∞</h1>
                        <p className="text-art-textSub text-sm tracking-widest uppercase opacity-60">Smart Finance</p>
                    </div>
                    
                    <div className="mb-12 flex flex-col items-center gap-4">
                        <Loader2 className="animate-spin text-art-textSub" size={20} />
                        <p className="text-[10px] text-[#333] font-mono">VERSION 1.1.0</p>
                    </div>
                </div>
            );
        };

        const MonthlyStats = ({ transactions, currentDate, onCategoryClick }) => {
            // ... (MonthlyStats Code Remains Unchanged)
            const [selectedIndex, setSelectedIndex] = useState(null); 
            const chartRef = useRef(null);

            const { chartData, categoryData, totalMonthExpense, totalCount } = useMemo(() => {
                const daysInM = endOfMonth(currentDate).getDate();
                const monthStr = format(currentDate, 'yyyy-MM');

                const monthTrans = transactions.filter(t => {
                    const dStr = getRawDateStr(t.date);
                    return dStr.startsWith(monthStr);
                });

                const totalMonthExpense = monthTrans.reduce((sum, t) => sum + Math.abs(Number(t.amount || 0)), 0);

                const data = new Array(daysInM).fill(0).map((_, i) => ({
                    day: i + 1,
                    amount: 0,
                    dateStr: format(new Date(currentDate.getFullYear(), currentDate.getMonth(), i + 1), 'MM.dd')
                }));

                monthTrans.forEach(t => {
                    const dateStr = getRawDateStr(t.date);
                    if (dateStr) {
                        const d = new Date(dateStr).getDate(); 
                        if (data[d-1]) data[d-1].amount += Math.abs(Number(t.amount || 0));
                    }
                });

                const catStats = {};
                monthTrans.forEach(t => {
                    const amt = Math.abs(Number(t.amount || 0));
                    const cat = t.category || 'ÂÖ∂‰ªñ';
                    if (!catStats[cat]) catStats[cat] = { count: 0, amount: 0 };
                    catStats[cat].count += 1;
                    catStats[cat].amount += amt;
                });

                const categories = Object.entries(catStats)
                    .map(([name, val]) => ({ name, ...val, percent: totalMonthExpense ? (val.amount / totalMonthExpense) * 100 : 0 }))
                    .sort((a, b) => b.amount - a.amount);

                return { chartData: data, categoryData: categories, totalMonthExpense, totalCount: monthTrans.length };
            }, [transactions, currentDate]);

            useEffect(() => {
                const today = new Date();
                if (isSameDay(today, currentDate) || (today.getMonth() === currentDate.getMonth() && today.getFullYear() === currentDate.getFullYear())) {
                    setSelectedIndex(today.getDate() - 1);
                } else {
                    setSelectedIndex(0);
                }
            }, [currentDate]);

            const handleTouch = (e) => {
                if (!chartRef.current) return;
                const touch = e.touches[0];
                const rect = chartRef.current.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const width = rect.width;
                const totalBars = chartData.length;
                let newIndex = Math.floor((x / width) * totalBars);
                if (newIndex < 0) newIndex = 0;
                if (newIndex >= totalBars) newIndex = totalBars - 1;
                if (newIndex !== selectedIndex) {
                    setSelectedIndex(newIndex);
                    haptic('light');
                }
            };

            const maxAmount = Math.max(...chartData.map(d => d.amount), 10); 
            const yAxisMax = Math.ceil(maxAmount / 10) * 10;
            const yAxisMid = yAxisMax / 2;
            const selectedData = chartData[selectedIndex] || { amount: 0, day: 1 };

            const getPoints = () => {
                return chartData.map((d, i) => {
                    const x = (i / (chartData.length - 1)) * 100;
                    const y = 100 - (d.amount / yAxisMax) * 80; 
                    return `${x},${y}`;
                }).join(' ');
            };

            const getTooltipStyle = () => {
                if (selectedIndex === 0) return { left: '0%' };
                if (selectedIndex === chartData.length - 1) return { right: '0%', left: 'auto' };
                return { left: `${(selectedIndex / (chartData.length - 1)) * 100}%`, transform: 'translateX(-50%)' };
            };
            
            const getTooltipClass = () => {
                 if (selectedIndex === 0) return "origin-bottom-left";
                 if (selectedIndex === chartData.length - 1) return "origin-bottom-right";
                 return "origin-bottom";
            };

            return (
                <div className="mx-4 mb-24 bg-[#1C1C1E] rounded-[24px] p-5 border border-white/5 shadow-2xl relative overflow-visible">
                    <div className="text-[15px] font-bold text-white/90 mb-8">Êú¨ÊúàÊØèÊó•ÊîØÂá∫ÁªüËÆ°</div>

                    <div 
                        ref={chartRef}
                        className="h-[180px] w-full relative mb-6 select-none touch-none"
                        onTouchStart={handleTouch}
                        onTouchMove={handleTouch}
                    >
                        {selectedIndex !== null && (
                            <div 
                                className={`absolute -top-8 z-30 transition-all duration-75 pointer-events-none ${getTooltipClass()}`}
                                style={getTooltipStyle()}
                            >
                                <div className="bg-[#121212] px-2.5 py-1.5 rounded-lg border border-white/10 flex items-center gap-1.5 shadow-xl whitespace-nowrap">
                                    <div className="w-2 h-2 rounded-full bg-art-cyan"></div>
                                    <span className="text-[12px] font-medium text-white">ÊîØÂá∫ {formatMoney(selectedData.amount)}</span>
                                    <div className={`absolute bottom-[-4px] w-2 h-2 bg-[#121212] border-b border-r border-white/10 rotate-45 ${selectedIndex === 0 ? 'left-3' : selectedIndex === chartData.length - 1 ? 'right-3' : 'left-1/2 -translate-x-1/2'}`}></div>
                                </div>
                            </div>
                        )}

                        <div className="absolute inset-0 flex flex-col justify-between pointer-events-none">
                            <div className="relative w-full border-t border-dashed border-white/10"><span className="absolute -left-0 -top-2.5 text-[10px] text-art-textSub">{yAxisMax}</span></div>
                            <div className="relative w-full border-t border-dashed border-white/10"><span className="absolute -left-0 -top-2.5 text-[10px] text-art-textSub">{yAxisMid}</span></div>
                            <div className="relative w-full border-t border-white/10"><span className="absolute -left-0 -top-2.5 text-[10px] text-art-textSub">0</span></div>
                        </div>

                        <div className="absolute inset-0 left-0 right-0 top-3 bottom-0 z-10 px-[2px] pointer-events-none">
                             <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                                <defs>
                                    <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="0%" stopColor="#2DD4BF" stopOpacity="0.3" />
                                        <stop offset="100%" stopColor="#2DD4BF" stopOpacity="0" />
                                    </linearGradient>
                                </defs>
                                <path d={`M 0,100 L ${getPoints().split(' ').map(p => `L ${p.replace(',', ' ')}`).join(' ')} L 100,100 Z`} fill="url(#chartGradient)" />
                                <polyline points={getPoints()} fill="none" stroke="#2DD4BF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />
                            </svg>
                        </div>

                        {selectedIndex !== null && (
                            <div 
                                className="absolute top-3 bottom-0 w-[1.5px] bg-[#2DD4BF] z-0 transition-all duration-75 pointer-events-none"
                                style={{ left: `${(selectedIndex / (chartData.length - 1)) * 100}%` }}
                            >
                                <div className="absolute -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#1C1C1E] border-[2.5px] border-[#2DD4BF] rounded-full shadow-[0_0_0_2px_rgba(45,212,191,0.2)]" style={{ top: `${100 - (selectedData.amount / yAxisMax) * 80}%` }}></div>
                            </div>
                        )}

                        <div className="absolute top-0 left-0 w-full h-full z-20 flex items-end pointer-events-none">
                             {chartData.map((d, i) => {
                                 const showLabel = i === 0 || i === chartData.length - 1 || (i + 1) % 5 === 0;
                                 const isSelected = selectedIndex === i;
                                 const justifyClass = i === 0 ? 'justify-start' : (i === chartData.length - 1 ? 'justify-end' : 'justify-center');
                                 const originClass = i === 0 ? 'origin-bottom-left' : (i === chartData.length - 1 ? 'origin-bottom-right' : 'origin-bottom');

                                 return (
                                    <div key={i} className={`flex-1 h-full flex items-end ${justifyClass} pb-[-20px]`}>
                                        <div className="absolute inset-0 bg-transparent"></div>
                                        {(showLabel || isSelected) && (
                                            <div className={`text-[9px] mb-[-24px] px-0.5 py-0.5 rounded-md transition-all duration-200 whitespace-nowrap ${originClass} ${isSelected ? 'bg-black text-white font-bold z-30 shadow-lg scale-110 px-1.5' : 'text-art-textSub'}`}>{d.dateStr}</div>
                                        )}
                                    </div>
                                   );
                             })}
                        </div>
                    </div>

                    <div className="flex justify-between items-center mb-4 pt-6 border-t border-white/5">
                        <div className="text-[14px] font-bold text-white/90">Êú¨ÊúàÂàÜÁ±ªÊîØÂá∫</div>
                        <div className="text-[11px] text-art-textSub">
                            ËÆ∞Ë¥¶Á¨îÊï∞ <span className="text-white font-mono">{totalCount}</span> <span className="mx-2"></span> ÊÄªÊîØÂá∫ <span className="text-art-cyan font-mono">{formatMoney(totalMonthExpense)}</span>
                        </div>
                    </div>

                    <div className="space-y-6">
                        {categoryData.length === 0 ? (
                            <div className="text-center text-art-textSub text-[12px] py-4">ÊöÇÊó†ÂàÜÁ±ªÊï∞ÊçÆ</div>
                        ) : (
                            categoryData.map((cat, idx) => (
                                <div key={cat.name} className="group active:opacity-60 transition-opacity cursor-pointer" onClick={() => onCategoryClick(cat.name)}>
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-3">
                                            <div className="text-[12px] font-bold text-art-textSub w-4 text-center font-mono">{idx + 1}</div>
                                            <div className="flex items-center gap-2">
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${getCategoryColor(cat.name).bg} ${getCategoryColor(cat.name).text}`}>
                                                    {React.cloneElement(getCategoryIcon(cat.name), { size: 12 })}
                                                </div>
                                                <span className="text-[13px] text-white font-medium">{cat.name}</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-[11px] text-white font-mono">
                                                {cat.percent.toFixed(2)}% <span className="text-art-textSub mx-1">‚Ä¢</span> {formatMoney(cat.amount)}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3 pl-9">
                                        <div className="flex-1 h-1.5 bg-[#2C2C2E] rounded-full overflow-hidden">
                                            <div className="h-full bg-art-cyan rounded-full" style={{ width: `${cat.percent}%` }}></div>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const FilterSidebar = ({ isOpen, onClose, currentFilters, onApply }) => {
            // ... (FilterSidebar Code Remains Unchanged)
            const [localFilters, setLocalFilters] = useState(currentFilters);
            useEffect(() => { if (isOpen) setLocalFilters(currentFilters); }, [isOpen, currentFilters]);
            const handleApply = () => { onApply(localFilters); onClose(); };

            return (
                <>
                    <div className={`fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] transition-opacity duration-300 ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={onClose} />
                    <div className={`fixed inset-y-0 right-0 w-[85%] max-w-[320px] bg-[#1C1C1E] z-[230] transform transition-transform duration-300 ease-out shadow-2xl flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="flex items-center justify-between p-4 border-b border-white/10 pt-safe">
                            <button onClick={onClose} className="text-art-textSub">ÂèñÊ∂à</button>
                            <h3 className="text-[17px] font-bold text-white">Á≠õÈÄâ</h3>
                            <button onClick={handleApply} className="text-art-accent font-bold">ÂÆåÊàê</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            <div>
                                <div className="text-[13px] text-art-textSub mb-2 ml-1">Êó∂Èó¥ËåÉÂõ¥</div>
                                <div className="bg-[#2C2C2E] rounded-xl p-3 flex items-center justify-between gap-2">
                                    <input type="date" className="bg-transparent text-white text-[14px] outline-none w-full text-center" value={localFilters.startDate || ''} onChange={(e) => setLocalFilters({...localFilters, startDate: e.target.value})} />
                                    <span className="text-art-textSub">-</span>
                                    <input type="date" className="bg-transparent text-white text-[14px] outline-none w-full text-center" value={localFilters.endDate || ''} onChange={(e) => setLocalFilters({...localFilters, endDate: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <div className="text-[13px] text-art-textSub mb-2 ml-1">ÂàÜÁ±ª</div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setLocalFilters({...localFilters, category: 'all'})} className={`px-3 py-1.5 rounded-lg text-[13px] border ${localFilters.category === 'all' ? 'bg-white text-black border-white' : 'bg-[#2C2C2E] text-white border-transparent'}`}>ÂÖ®ÈÉ®</button>
                                    {categoriesList.map(cat => (
                                        <button key={cat} onClick={() => setLocalFilters({...localFilters, category: cat})} className={`px-3 py-1.5 rounded-lg text-[13px] border ${localFilters.category === cat ? 'bg-art-accent text-black border-art-accent' : 'bg-[#2C2C2E] text-white border-transparent'}`}>{cat}</button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <div className="text-[13px] text-art-textSub mb-2 ml-1">ÈáëÈ¢ùÂå∫Èó¥</div>
                                <div className="flex items-center gap-3">
                                    <div className="bg-[#2C2C2E] rounded-xl flex-1 px-3 py-2.5">
                                        <input type="number" placeholder="ÊúÄ‰Ωé" className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.minAmount || ''} onChange={(e) => setLocalFilters({...localFilters, minAmount: e.target.value})} />
                                    </div>
                                    <div className="w-2 h-[1px] bg-art-textSub"></div>
                                    <div className="bg-[#2C2C2E] rounded-xl flex-1 px-3 py-2.5">
                                        <input type="number" placeholder="ÊúÄÈ´ò" className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.maxAmount || ''} onChange={(e) => setLocalFilters({...localFilters, maxAmount: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="text-[13px] text-art-textSub mb-2 ml-1">Â§áÊ≥®ÂÖ≥ÈîÆËØç</div>
                                <div className="bg-[#2C2C2E] rounded-xl px-3 py-2.5 flex items-center">
                                    <Search size={16} className="text-art-textSub mr-2" />
                                    <input type="text" placeholder="ÊêúÁ¥¢Â§áÊ≥®..." className="bg-transparent w-full text-white text-[14px] outline-none placeholder-white/20" value={localFilters.keyword || ''} onChange={(e) => setLocalFilters({...localFilters, keyword: e.target.value})} />
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const FilterSheet = ({ isOpen, onClose, dateRange, onModify }) => {
            // ... (FilterSheet Code Remains Unchanged)
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[200] flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10 shadow-2xl">
                        <div className="flex justify-center items-center mb-8 relative">
                            <h3 className="text-[17px] font-bold text-white">Á≠õÈÄâÊù°‰ª∂</h3>
                            <button onClick={onClose} className="absolute right-0 p-1 text-art-textSub active:opacity-60 bg-art-cardLight rounded-full"><X size={18} /></button>
                        </div>
                        <div className="flex items-center gap-3 mb-10 pl-1">
                            <div className="text-white"><Clock size={20} /></div>
                            <span className="text-[15px] font-medium text-white/90">ÂΩìÂâçËåÉÂõ¥</span>
                            <span className="text-[15px] text-white/90 font-mono ml-auto tracking-wide">{dateRange}</span>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => { onClose(); onModify('viewAll'); }} className="flex-1 py-3.5 bg-white text-black rounded-full font-bold text-[15px] active:scale-95 transition-transform shadow-lg">Êü•ÁúãÂÖ®ÈÉ®ÊµÅÊ∞¥</button>
                            <button onClick={() => { onClose(); onModify('openSidebar'); }} className="flex-1 py-3.5 bg-[#FF9F0A] text-white rounded-full font-bold text-[15px] active:scale-95 transition-transform shadow-lg">‰øÆÊîπÁ≠õÈÄâÊù°‰ª∂</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TransactionGroup = ({ label, total, transactions, groupByDay, onViewEditor }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const daysMap = useMemo(() => {
                if (!groupByDay) return null;
                const groups = {};
                transactions.forEach(t => {
                    const dateStr = getRawDateStr(t.date);
                    if (!dateStr) return;
                    if (!groups[dateStr]) groups[dateStr] = [];
                    groups[dateStr].push(t);
                });
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions, groupByDay]);

            return (
                <div className="mb-6 animate-slide-up-stagger" style={{ animationDelay: '0.1s' }}>
                    <div className="flex justify-between items-center py-4 px-4 bg-[#1C1C1E] rounded-[24px] transition-colors cursor-pointer mb-2" onClick={() => { setIsExpanded(!isExpanded); haptic('light'); }}>
                        <div className="flex flex-col"><span className="text-[18px] font-bold text-white">{label}</span></div>
                        <div className="flex items-center gap-3">
                            <div className="text-right">
                                <div className="text-[11px] text-art-textSub opacity-60 mb-0.5">ÊÄªÊîØÂá∫</div>
                                <div className="text-[14px] text-white font-medium">{formatMoney(total)}</div>
                            </div>
                            <div className={`transition-transform duration-200 text-art-textSub ${isExpanded ? 'rotate-180' : ''}`}><ChevronDown size={18} /></div>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="px-1">
                            {groupByDay && daysMap && daysMap.map(([dateStr, items]) => {
                                const dObj = new Date(dateStr);
                                const weekDay = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'][dObj.getDay()];
                                return (
                                    <div key={dateStr} className="mb-6 animate-fade-in">
                                        <div className="flex justify-between items-end px-2 mb-2 text-art-textSub"><div className="text-[13px] font-medium">{format(dObj, 'MMÊúàddÊó•')} {weekDay}</div></div>
                                        <div className="space-y-0">{items.map(t => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}</div>
                                    </div>
                                );
                            })}
                            {!groupByDay && (
                                <div className="space-y-0 mt-2 animate-fade-in">{transactions.map(t => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const TransactionItem = ({ t, onClick }) => (
            // ... (TransactionItem Code Remains Unchanged)
            <div onClick={onClick} className="flex items-center justify-between py-4 px-2 active:bg-white/5 rounded-xl transition-colors cursor-pointer">
                <div className="flex items-center gap-4 overflow-hidden">
                    <div className={`w-9 h-9 rounded-full flex items-center justify-center shrink-0 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text}`}>
                        {React.cloneElement(getCategoryIcon(t.category), { size: 18 })}
                    </div>
                    <div className="flex flex-col min-w-0">
                        <div className="text-[15px] text-white font-bold truncate mb-1">{t.merchant || t.category}</div>
                        <div className="text-[12px] text-[#666] font-normal truncate flex items-center gap-1.5"><span>{getRawTimeStr(t.date)}</span><span>¬∑</span><span>{t.note || t.category}</span></div>
                    </div>
                </div>
                <div className="text-[17px] text-art-blue font-bold shrink-0 ml-3 font-mono tracking-tight">{formatMoney(t.amount)}</div>
            </div>
        );

        const PeriodPage = ({ title, type, total, allTransactions, onClose, initialCategory, onViewEditor }) => {
            // ... (PeriodPage Code Remains Unchanged - already updated in previous turn)
            const [isFilterSheetOpen, setIsFilterSheetOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            
            useEffect(() => {
                const timer = setTimeout(() => setIsLoading(false), 500); 
                return () => clearTimeout(timer);
            }, []);

            const getInitialFilters = () => {
                const now = new Date();
                let startDate = '', endDate = '';
                let cat = initialCategory || 'all'; 
                
                if (type === 'today') {
                    startDate = endDate = format(now, 'yyyy-MM-dd');
                } else if (type === 'week') {
                    startDate = format(startOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd');
                    endDate = format(endOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd');
                } else if (type === 'year') {
                    startDate = format(startOfYear(now), 'yyyy-MM-dd');
                    endDate = format(endOfYear(now), 'yyyy-MM-dd');
                } else if (type === 'month') {
                    startDate = format(startOfMonth(now), 'yyyy-MM-dd');
                    endDate = format(endOfMonth(now), 'yyyy-MM-dd');
                }

                return { startDate, endDate, category: cat, minAmount: '', maxAmount: '', keyword: '' };
            };

            const [activeFilters, setActiveFilters] = useState(getInitialFilters());

            const handleSheetAction = (action) => {
                if (action === 'viewAll') {
                    setActiveFilters({ startDate: '', endDate: '', category: 'all', minAmount: '', maxAmount: '', keyword: '' });
                    haptic();
                } else if (action === 'openSidebar') {
                    setIsSidebarOpen(true);
                    haptic();
                }
            };

            const list = useMemo(() => {
                return allTransactions.filter(t => {
                    const rawDate = getRawDateStr(t.date);
                    if (!rawDate) return false; 
                    const amount = Math.abs(Number(t.amount || 0));
                    if (activeFilters.startDate && rawDate < activeFilters.startDate) return false;
                    if (activeFilters.endDate && rawDate > activeFilters.endDate) return false;
                    if (activeFilters.category !== 'all' && t.category !== activeFilters.category) return false;
                    if (activeFilters.minAmount && amount < Number(activeFilters.minAmount)) return false;
                    if (activeFilters.maxAmount && amount > Number(activeFilters.maxAmount)) return false;
                    if (activeFilters.keyword) {
                        const note = (t.note || '').toLowerCase();
                        const merchant = (t.merchant || '').toLowerCase();
                        const kw = activeFilters.keyword.toLowerCase();
                        if (!note.includes(kw) && !merchant.includes(kw)) return false;
                    }
                    return true;
                }).sort((a,b) => b.date.localeCompare(a.date));
            }, [activeFilters, allTransactions]);

            const groupedData = useMemo(() => {
                const groups = {}; 
                list.forEach(t => {
                    const dateStr = getRawDateStr(t.date);
                    if (!dateStr) return;
                    const dObj = new Date(dateStr);
                    let key = "";
                    let label = "";
                    
                    if (type === 'today') {
                        key = dateStr;
                        label = format(dObj, 'MMÊúàddÊó•');
                    } else if (type === 'week') {
                        const year = dObj.getFullYear();
                        const weekNum = getISOWeek(dObj);
                        key = `${year}-W${weekNum}`;
                        label = `Á¨¨${weekNum}Âë®`;
                    } else if (type === 'year') {
                        const year = dObj.getFullYear();
                        key = `${year}`;
                        label = `${year}Âπ¥`;
                    } else {
                        const y = dObj.getFullYear();
                        const m = dObj.getMonth() + 1;
                        key = `${y}-${m}`;
                        label = `${m}Êúà`;
                    }

                    if (!groups[key]) {
                        groups[key] = { label, total: 0, items: [] };
                    }
                    groups[key].total += Math.abs(Number(t.amount || 0));
                    groups[key].items.push(t);
                });
                return Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).map(([k,v]) => v);
            }, [list, type]);

            const currentTotal = useMemo(() => list.reduce((sum, t) => sum + Math.abs(Number(t.amount || 0)), 0), [list]);

            const displayTitle = useMemo(() => {
                if (!activeFilters.startDate && !activeFilters.endDate) return "ÂÖ®ÈÉ®ÊµÅÊ∞¥";
                if (activeFilters.category !== 'all') return `${activeFilters.category}ÊîØÂá∫`;
                if (activeFilters.startDate === activeFilters.endDate) return activeFilters.startDate;
                return "Á≠õÈÄâÁªìÊûú";
            }, [activeFilters]);

            const finalTitle = (activeFilters.category === 'all' && type !== 'month') ? title : displayTitle;

            return (
                <div className="page-container page-enter pb-safe flex flex-col z-[100] bg-[#000000] no-scrollbar">
                    <div className="relative h-[200px] w-full overflow-hidden shrink-0 transition-all duration-700 ease-out transform" style={{ opacity: isLoading ? 0.9 : 1, transform: isLoading ? 'scale(1.02)' : 'scale(1)' }}>
                        <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-b from-black/70 via-black/40 to-[#000000]"></div>
                        <div className="absolute top-0 left-0 right-0 pt-safe px-4 h-[60px] flex items-center justify-between z-20">
                            <button onClick={onClose} className="p-2 -ml-2 text-white flex items-center gap-1 active:opacity-60 transition-opacity">
                                <ArrowLeft size={24} /> 
                                <span className="text-[17px] font-medium tracking-wide truncate max-w-[200px] text-white/90">{finalTitle}</span>
                            </button>
                            <button onClick={() => {}} className="p-2 text-white/90 active:opacity-60"><Plus size={26} /></button>
                        </div>
                        <div className="absolute bottom-10 left-6 z-20 animate-slide-up" style={{ animationDelay: '0.1s' }}>
                            <div className="text-[12px] text-white/70 font-medium mb-1 tracking-widest uppercase">ÊÄªÊîØÂá∫</div>
                            <div className="text-[48px] font-bold text-white font-mono tracking-tighter leading-none -ml-1">-{formatMoney(currentTotal)}</div>
                        </div>
                    </div>

                    <div className="flex-1 px-4 -mt-6 relative z-30">
                        <div className="bg-[#121212] rounded-t-[32px] min-h-full border-t border-[#2C2C2E] p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] backdrop-blur-xl">
                            <div className="flex justify-between items-center mb-6 px-1 pt-1">
                                <span className="text-[13px] text-art-textSub font-medium tracking-wide">{list.length === allTransactions.length ? "ÂÖ®ÈÉ®ÊòéÁªÜ" : "Á≠õÈÄâÁªìÊûú"}</span>
                                <button onClick={() => { setIsFilterSheetOpen(true); haptic(); }} className="text-[13px] text-art-accent flex items-center gap-1 active:opacity-60 font-medium bg-art-accent/10 px-3 py-1.5 rounded-full">
                                    {list.length === allTransactions.length ? "Á≠õÈÄâ" : "Êü•ÁúãÂÖ®ÈÉ®"} <ChevronRight size={12}/>
                                </button>
                            </div>
                            {isLoading ? <Skeleton /> : (
                                <div className="space-y-6 pb-10">
                                    {groupedData.length === 0 ? (
                                        <div className="text-center py-20 text-art-textSub opacity-50 flex flex-col items-center animate-fade-in"><div className="text-4xl mb-3">üçÉ</div><div className="text-[15px]">ÊöÇÊó†ËÆ∞ÂΩï</div></div>
                                    ) : (
                                        groupedData.map((group, idx) => (
                                            <TransactionGroup key={idx} label={group.label} total={group.total} transactions={group.items} groupByDay={type !== 'today'} onViewEditor={onViewEditor} />
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    <FilterSheet isOpen={isFilterSheetOpen} onClose={() => setIsFilterSheetOpen(false)} dateRange={activeFilters.startDate ? `${activeFilters.startDate} Ëá≥ ${activeFilters.endDate || '‰ªä'}` : 'ÂÖ®ÈÉ®Êó∂Èó¥'} onModify={handleSheetAction} />
                    <FilterSidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} currentFilters={activeFilters} onApply={setActiveFilters} />
                </div>
            );
        };

        const MonthGroup = ({ year, month, totalExpense, days, onViewEditor }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            return (
                <div className="mb-6">
                    <div className="flex justify-between items-center py-4 px-4 bg-[#1C1C1E] rounded-[24px] transition-colors cursor-pointer mb-2 sticky z-10" style={{ top: '0px' }} onClick={() => { setIsExpanded(!isExpanded); haptic('light'); }}>
                        <div className="flex items-baseline gap-1.5"><span className="text-[20px] font-bold text-white">{month}Êúà</span><span className="text-[13px] text-art-textSub">{year}</span></div>
                        <div className="flex items-center gap-3">
                            <div className="text-right"><div className="text-[11px] text-art-textSub opacity-60 mb-0.5">ÊÄªÊîØÂá∫</div><div className="text-[14px] text-white font-medium">{formatMoney(totalExpense)}</div></div>
                            <div className={`transition-transform duration-200 text-art-textSub ${isExpanded ? 'rotate-180' : ''}`}><ChevronDown size={18} /></div>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="animate-fade-in px-1">
                            {days.map(([dateStr, items]) => {
                                const dObj = new Date(dateStr);
                                const weekDay = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'][dObj.getDay()];
                                return (
                                    <div key={dateStr} className="mb-6">
                                        <div className="flex justify-between items-end px-2 mb-2 text-art-textSub"><div className="text-[13px] font-medium">{format(dObj, 'MMÊúàddÊó•')} {weekDay}</div></div>
                                        <div className="space-y-0">{items.map((t) => (<TransactionItem key={t.id} t={t} onClick={() => onViewEditor(t)} />))}</div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // üî•üî•üî• REDESIGNED EDITOR PAGE üî•üî•üî•
        const EditorPage = ({ transaction, onClose, onSave, onDelete }) => {
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isDateSheetOpen, setIsDateSheetOpen] = useState(false);
            const [isTimeSheetOpen, setIsTimeSheetOpen] = useState(false);

            // Simulate entry loading
            useEffect(() => {
                const timer = setTimeout(() => setIsLoading(false), 300);
                return () => clearTimeout(timer);
            }, []);

            const getInitialTime = () => {
                if (transaction) return getRawTimeStr(transaction.date); 
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                return `${h}:${m}`;
            };

            const [form, setForm] = useState({ 
                amount: transaction ? Math.abs(transaction.amount) : '', 
                merchant: transaction ? transaction.merchant : '', 
                category: transaction ? transaction.category : 'È§êÈ•Æ', 
                date: transaction ? getRawDateStr(transaction.date) : new Date().toISOString().split('T')[0], 
                time: getInitialTime(), 
                note: transaction ? (transaction.note || '') : '' 
            });
            const [loading, setLoading] = useState(false);
            
            const handleSave = async () => {
                if (!form.amount) return;
                setLoading(true);
                const isoDateTime = `${form.date}T${form.time}:00.000Z`;
                // Ë∞ÉÁî®Áà∂ÁªÑ‰ª∂‰º†ÈÄíÁöÑ onSaveÔºå‰º†ÈÄíË°®ÂçïÊï∞ÊçÆÂíå ID
                await onSave({ ...form, date: isoDateTime }, transaction?.id);
                setLoading(false);
            };

            const handleConfirmDelete = () => {
                onDelete(transaction.id);
            };

            const currentCategoryColor = getCategoryColor(form.category);

            // Âõ∫ÂÆöÈ°µÈù¢ÁöÑÂÖ≥ÈîÆÔºöfixed inset-0 overflow-hidden
            return (
                <div className="fixed inset-0 z-[100] bg-[#000000] overflow-hidden flex flex-col">
                    <ConfirmDialog isOpen={showDeleteConfirm} onCancel={() => setShowDeleteConfirm(false)} onConfirm={handleConfirmDelete} title="Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü" message="Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºåÊï∞ÊçÆÂ∞ÜË¢´Ê∞∏‰πÖÁßªÈô§„ÄÇ" />
                    <CustomDatePickerSheet isOpen={isDateSheetOpen} onClose={() => setIsDateSheetOpen(false)} currentDateStr={form.date} onSelect={(val) => setForm({...form, date: val})} />
                    <CustomTimePickerSheet isOpen={isTimeSheetOpen} onClose={() => setIsTimeSheetOpen(false)} currentTimeStr={form.time} onSelect={(val) => setForm({...form, time: val})} />

                    {/* ‚ú® Immersive Header Area - Fixed height, no scroll. Reduced height to 240px. */}
                    <div className="relative w-full overflow-hidden shrink-0 transition-all duration-500 ease-out" style={{ height: '240px', opacity: isLoading ? 0.5 : 1 }}>
                        {/* Background Gradient based on Category */}
                        <div className={`absolute inset-0 bg-gradient-to-b ${currentCategoryColor.gradient} via-black/80 to-[#000000] opacity-30`}></div>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 mix-blend-overlay"></div>

                        {/* Top Nav */}
                        <div className="absolute top-0 left-0 right-0 pt-safe px-4 h-[60px] flex items-center justify-between z-20">
                            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 backdrop-blur-md active:bg-white/10 transition-colors text-white">
                                <ArrowLeft size={20} />
                            </button>
                            {/* DETAIL span removed here */}
                            <button onClick={handleSave} className="px-4 h-9 rounded-full bg-white text-black font-bold text-[13px] active:scale-95 transition-transform flex items-center gap-2">
                                {loading && <Loader2 size={12} className="animate-spin" />}
                                {transaction ? '‰øùÂ≠ò' : 'ÂÆåÊàê'}
                            </button>
                        </div>

                        {/* Central Focus Area - Reduced pt */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center pt-6 z-10 animate-bounce-in">
                            {/* Category Icon with Glow */}
                            <div className={`w-16 h-16 rounded-[24px] flex items-center justify-center mb-6 shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)] ${currentCategoryColor.bg} ${currentCategoryColor.text} border border-white/10 backdrop-blur-xl`}>
                                {React.cloneElement(getCategoryIcon(form.category), { size: 32, strokeWidth: 1.5 })}
                            </div>
                            
                            {/* Huge Amount Input */}
                            <div className="flex items-baseline justify-center w-full px-8 relative">
                                <span className="text-[32px] font-light text-white/40 absolute left-8 top-2">¬•</span>
                                <input 
                                    type="number" 
                                    value={form.amount} 
                                    onChange={(e) => setForm({...form, amount: e.target.value})} 
                                    placeholder="0.00" 
                                    className="w-full bg-transparent text-[56px] font-bold text-white placeholder-white/10 font-mono text-center outline-none caret-art-accent tracking-tighter"
                                    autoFocus={!transaction} 
                                />
                            </div>
                            <div className="text-[13px] text-white/40 mt-2 font-medium tracking-wide">{form.category}</div>
                        </div>
                    </div>
                    
                    {/* ‚ú® Content Card Area - Fixed Layout (overflow-hidden) */}
                    <div className="flex-1 px-4 -mt-8 relative z-30 animate-slide-up-stagger overflow-hidden" style={{ animationDelay: '0.1s' }}>
                        <div className="bg-[#121212] rounded-t-[32px] h-full border-t border-[#2C2C2E] p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] backdrop-blur-xl">
                            
                            {/* Section: Category Selector */}
                            <div className="mb-6">
                                <h4 className="text-[11px] text-white/30 font-bold mb-3 ml-1 uppercase tracking-widest flex items-center gap-2"><Tag size={10} /> Change Category</h4>
                                <div className="grid grid-cols-4 gap-3">
                                    {categoriesList.map(cat => {
                                        const color = getCategoryColor(cat);
                                        const isSelected = form.category === cat;
                                        return (
                                            <button key={cat} onClick={() => {setForm({...form, category: cat}); haptic('light');}} className={`flex flex-col items-center justify-center py-2.5 rounded-[20px] transition-all active:scale-90 duration-300 border ${isSelected ? `bg-white text-black shadow-lg scale-105 border-white` : 'bg-[#1C1C1E] border-white/5 hover:bg-white/5'}`}>
                                                <div className={`w-7 h-7 rounded-full flex items-center justify-center mb-1 transition-colors ${isSelected ? 'text-black bg-black/10' : 'text-white/50'}`}>
                                                    {React.cloneElement(getCategoryIcon(cat), { size: 14 })}
                                                </div>
                                                <span className={`text-[10px] font-bold ${isSelected ? 'text-black' : 'text-white/40'}`}>{cat}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Section: Details Form */}
                            <div className="mb-4">
                                <h4 className="text-[11px] text-white/30 font-bold mb-3 ml-1 uppercase tracking-widest flex items-center gap-2"><PenLine size={10} /> Details</h4>
                                <div className="bg-[#1C1C1E] rounded-[24px] border border-white/5 overflow-hidden">
                                    {/* Merchant Row */}
                                    <div className="flex items-center px-5 py-3.5 border-b border-white/5 group transition-colors hover:bg-white/5">
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-4 text-white/50"><ShoppingBag size={16} /></div>
                                        <div className="flex-1">
                                            <div className="text-[11px] text-white/40 mb-0.5">ÂïÜÊà∑</div>
                                            <input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} placeholder="ËæìÂÖ•ÂïÜÊà∑ÂêçÁß∞" className="w-full bg-transparent text-[15px] text-white focus:outline-none placeholder-white/20 font-medium" />
                                        </div>
                                    </div>
                                    
                                    {/* Date & Time Row - REPLACED INPUTS WITH DIVS */}
                                    <div className="flex items-center px-5 py-3.5 border-b border-white/5 group transition-colors hover:bg-white/5">
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-4 text-white/50"><Clock size={16} /></div>
                                        <div className="flex-1 flex gap-4">
                                            <div className="flex-1" onClick={() => setIsDateSheetOpen(true)}>
                                                <div className="text-[11px] text-white/40 mb-0.5">Êó•Êúü</div>
                                                <div className="text-[15px] text-white font-medium">{form.date}</div>
                                            </div>
                                            <div className="w-[1px] bg-white/10 my-1"></div>
                                            <div className="flex-1" onClick={() => setIsTimeSheetOpen(true)}>
                                                <div className="text-[11px] text-white/40 mb-0.5">Êó∂Èó¥</div>
                                                <div className="text-[15px] text-white font-medium">{form.time}</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Note Row */}
                                    <div className="flex items-start px-5 py-3.5 group transition-colors hover:bg-white/5">
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center mr-4 text-white/50 mt-0.5"><MessageCircle size={16} /></div>
                                        <div className="flex-1">
                                            <div className="text-[11px] text-white/40 mb-0.5">Â§áÊ≥®</div>
                                            <textarea rows="2" value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} placeholder="Ê∑ªÂä†Â§áÊ≥®..." className="w-full bg-transparent text-[15px] text-white focus:outline-none placeholder-white/20 font-medium resize-none" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {transaction && (
                                <div className="flex justify-center mt-auto pb-4">
                                    <button onClick={() => setShowDeleteConfirm(true)} className="flex items-center gap-2 text-[#FF453A] font-medium text-[13px] opacity-60 hover:opacity-100 transition-opacity py-2 px-6 active:scale-95">
                                        <Trash2 size={16} /> Âà†Èô§Ê≠§ËÆ∞ÂΩï
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [currentTransaction, setCurrentTransaction] = useState(null); 
            const [toast, setToast] = useState(null);
            
            const [view, setView] = useState({ name: 'main' }); 
            
            // Global confirm dialog state (still used for other potential deletes, but EditorPage uses its own)
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, id: null });
            
            const [pullY, setPullY] = useState(0);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const startY = useRef(0);
            const scrollContainerRef = useRef(null);
            
            const getNowTime = () => {
                const now = new Date();
                return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            };
            const [form, setForm] = useState({ amount: '', merchant: '', category: 'È§êÈ•Æ', date: new Date().toISOString().split('T')[0], time: getNowTime(), note: '' });

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2000); };

            useEffect(() => {
                fetchTransactions();
                const sub = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, fetchTransactions).subscribe();
                return () => supabase.removeChannel(sub);
            }, [currentDate]);

            const fetchTransactions = async () => {
                if (!isRefreshing) setLoading(true);
                try {
                    const start = startOfYear(currentDate);
                    const end = endOfYear(currentDate);
                    const { data, error } = await supabase.from('transactions').select('*').gte('date', start.toISOString()).lte('date', end.toISOString()).order('date', { ascending: false });
                    if (!error) setTransactions(data || []);
                } catch(e) {
                    console.error("Fetch error:", e);
                }
                setLoading(false);
            };

            const handleTouchStart = (e) => { 
                if (scrollContainerRef.current && scrollContainerRef.current.scrollTop === 0) {
                    startY.current = e.touches[0].clientY; 
                } else {
                    startY.current = -1; // disabled
                }
            };

            const handleTouchMove = (e) => {
                if (startY.current === -1) return;
                const delta = e.touches[0].clientY - startY.current;
                if (delta > 0) setPullY(delta * 0.4);
            };

            const handleTouchEnd = async () => {
                if (startY.current === -1) return;
                if (pullY > 60) {
                    setIsRefreshing(true); setPullY(60); haptic();
                    await fetchTransactions(); haptic(); setIsRefreshing(false); setPullY(0);
                } else setPullY(0);
            };

            // ‰∏ìÈó®Â§ÑÁêÜËØ¶ÊÉÖÈ°µÁöÑ‰øùÂ≠òÔºàÊîØÊåÅ‰º†ÂèÇÔºâ
            const handleEditorSave = async (data, id) => {
                setLoading(true);
                const payload = { 
                    amount: parseFloat(data.amount), 
                    merchant: data.merchant || (data.category), 
                    category: data.category, 
                    date: data.date, // Â∑≤ÁªèÊòØ ISO Â≠óÁ¨¶‰∏≤‰∫Ü
                    note: data.note 
                };
                
                if (id) {
                    await supabase.from('transactions').update(payload).eq('id', id);
                    showToast("Â∑≤Êõ¥Êñ∞");
                } else {
                    await supabase.from('transactions').insert([payload]);
                    showToast("ËÆ∞Ë¥¶ÊàêÂäü");
                }
                
                setView({ name: 'main' }); // ‰øùÂ≠òÂêéÂÖ≥Èó≠È°µÈù¢
                setLoading(false);
                fetchTransactions(); // Âà∑Êñ∞ÂàóË°®
            };

            // Âø´Êç∑ËÆ∞Ë¥¶ÁöÑ‰øùÂ≠òÔºà‰ΩøÁî® form Áä∂ÊÄÅÔºâ
            const handleQuickSave = async () => {
                if (!form.amount) return;
                setLoading(true);
                const isoDateTime = `${form.date}T${form.time}:00.000Z`;

                const payload = { amount: parseFloat(form.amount), merchant: form.merchant || (form.category), category: form.category, date: isoDateTime, note: form.note };
                
                await supabase.from('transactions').insert([payload]);
                showToast("ËÆ∞Ë¥¶ÊàêÂäü");
                setIsAddModalOpen(false); 
                setForm({ ...form, amount: '', merchant: '', note: '', time: getNowTime() });
                setLoading(false);
            };

            const handleDeleteClick = (id) => {
                setConfirmDialog({ isOpen: true, id });
            };

            // Logic for direct deletion without opening the global dialog
            const performDelete = async (id) => {
                await supabase.from('transactions').delete().eq('id', id);
                showToast("Â∑≤Âà†Èô§");
                setTransactions(p => p.filter(t => t.id !== id));
                if (view.name === 'editor' && view.transaction?.id === id) {
                    setView({ name: 'main' });
                }
            };

            const executeDelete = async () => {
                if (!confirmDialog.id) return;
                await performDelete(confirmDialog.id);
                setConfirmDialog({ isOpen: false, id: null });
            };

            const stats = useMemo(() => {
                const now = new Date();
                const todayStr = format(now, 'yyyy-MM-dd');
                const startOfWeekStr = format(startOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd');
                const endOfWeekStr = format(endOfWeek(now, { weekStartsOn: 1 }), 'yyyy-MM-dd');
                const currentMonthStr = format(now, 'yyyy-MM');
                const currentYearStr = format(now, 'yyyy');
                
                const sum = (list) => list.reduce((acc, t) => acc + Math.abs(Number(t.amount || 0)), 0);

                const todayTrans = transactions.filter(t => getRawDateStr(t.date) === todayStr);
                
                const weekTrans = transactions.filter(t => {
                    const d = getRawDateStr(t.date);
                    return d >= startOfWeekStr && d <= endOfWeekStr;
                });
                
                const monthTrans = transactions.filter(t => getRawDateStr(t.date).startsWith(currentMonthStr));
                const yearTrans = transactions.filter(t => getRawDateStr(t.date).startsWith(currentYearStr));

                return {
                    monthTotal: sum(monthTrans),
                    todayTotal: sum(todayTrans),
                    weekTotal: sum(weekTrans),
                    yearTotal: sum(yearTrans)
                };
            }, [transactions]);

            const groupedByMonth = useMemo(() => {
                const groups = {}; // Key: 'YYYY-MM'
                transactions.forEach(t => {
                    const dateStr = getRawDateStr(t.date);
                    if (!dateStr) return;
                    const [y, m, d] = dateStr.split('-');
                    const monthKey = `${y}-${m}`;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            year: y,
                            month: m,
                            totalExpense: 0,
                            days: {} // Key: 'YYYY-MM-DD'
                        };
                    }
                    
                    groups[monthKey].totalExpense += Math.abs(Number(t.amount || 0));
                    
                    if (!groups[monthKey].days[dateStr]) {
                        groups[monthKey].days[dateStr] = [];
                    }
                    groups[monthKey].days[dateStr].push(t);
                });
                
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).map(([key, data]) => ({
                    key,
                    ...data,
                    daysSorted: Object.entries(data.days).sort((a, b) => b[0].localeCompare(a[0]))
                }));
            }, [transactions]);

            const handleCategoryClick = (category) => {
                setView({ 
                    name: 'period', 
                    title: `Êú¨Êúà¬∑${category}`, 
                    type: 'month', 
                    total: 0, 
                    initialCategory: category 
                });
            };

            if (showSplash) return <SplashScreen onFinish={() => setShowSplash(false)} />;

            // ‚ö†Ô∏è Pass performDelete to EditorPage and handleEditorSave
            if (view.name === 'editor') return <EditorPage transaction={view.transaction} onClose={()=>setView({name:'main'})} onSave={handleEditorSave} onDelete={performDelete} />;
            // üÜï Pass onViewEditor handler to navigate from PeriodPage to EditorPage
            if (view.name === 'period') return <PeriodPage 
                title={view.title} 
                type={view.type} 
                total={view.total} 
                allTransactions={transactions} 
                onClose={()=>setView({name:'main'})} 
                initialCategory={view.initialCategory} 
                onViewEditor={(t) => setView({ name: 'editor', transaction: t })} 
            />;

            return (
                <div 
                    className="h-full w-full bg-art-bg text-art-textMain font-sans selection:bg-art-accent selection:text-black relative overflow-hidden" 
                    onTouchStart={handleTouchStart} 
                    onTouchMove={handleTouchMove} 
                    onTouchEnd={handleTouchEnd}
                >
                    <Toast message={toast} />
                    
                    <ConfirmDialog 
                        isOpen={confirmDialog.isOpen} 
                        onCancel={() => setConfirmDialog({ isOpen: false, id: null })} 
                        onConfirm={executeDelete} 
                        title="Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü"
                        message="Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºåÊï∞ÊçÆÂ∞ÜË¢´Ê∞∏‰πÖÁßªÈô§„ÄÇ"
                    />
                    
                    {/* Pull to refresh indicator */}
                    <div className="absolute top-[60px] left-0 w-full flex justify-center pointer-events-none z-[100] transition-opacity duration-300" style={{ transform: `translateY(${pullY * 0.5}px)`, opacity: pullY > 20 ? 1 : 0 }}>
                        <div className="bg-[#2C2C2E] p-2.5 rounded-full shadow-lg border border-white/10"><Loader2 className={`text-white ${isRefreshing ? 'animate-spin' : ''}`} size={20} style={{ transform: `rotate(${pullY * 2}deg)` }} /></div>
                    </div>

                    {/* MAIN SCROLL CONTAINER - Hidden Scrollbar Applied Here */}
                    <main 
                        ref={scrollContainerRef}
                        className="h-full w-full overflow-y-auto no-scrollbar pb-safe transition-transform duration-300 ease-out" 
                        style={{ transform: `translateY(${pullY}px)` }}
                    >
                        {activeTab === 'home' && (
                            <div className="animate-fade-in">
                                <div className="pt-safe px-5 h-[20px] mb-2"></div>

                                <div className="mx-4 h-[140px] rounded-[32px] relative overflow-hidden shadow-2xl mb-6 group">
                                    <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700" />
                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/80"></div>
                                    <div className="absolute top-6 left-6 z-10">
                                        <div className="text-[14px] text-white/70 font-medium mb-1">Êú¨ÊúàÊî∂ÊîØÁªüËÆ°</div>
                                        <div className="text-[12px] text-white/50">ÊÄªÊîØÂá∫</div>
                                        <div className="text-[42px] font-bold text-white font-mono tracking-tight -mt-1">{formatMoney(stats.monthTotal)}</div>
                                    </div>
                                </div>

                                <div className="mx-4 space-y-3 mb-6">
                                    <div onClick={() => setView({ name: 'period', title: `‰ªäÂ§© ${format(new Date(), 'MÊúàdÊó•')}`, type: 'today', total: stats.todayTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-green-500 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.5)]"></div><div><div className="text-[15px] font-bold text-white">‰ªäÂ§©</div><div className="text-[12px] text-art-textSub">{new Date().getMonth()+1}Êúà{new Date().getDate()}Êó•</div></div></div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.todayTotal)}</div></div>
                                    </div>

                                    <div onClick={() => {
                                        const start = startOfWeek(new Date(), { weekStartsOn: 1 });
                                        const end = endOfWeek(new Date(), { weekStartsOn: 1 });
                                        setView({ name: 'period', title: `Êú¨Âë® ${format(start, 'M.d')}-${format(end, 'M.d')}`, type: 'week', total: stats.weekTotal });
                                    }} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3">
                                            <div className="w-1.5 h-8 bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                                            <div>
                                                <div className="text-[15px] font-bold text-white">Êú¨Âë®</div>
                                                <div className="text-[12px] text-art-textSub">
                                                    {format(startOfWeek(new Date(), { weekStartsOn: 1 }), 'MMÊúàddÊó•')} - {format(endOfWeek(new Date(), { weekStartsOn: 1 }), 'MMÊúàddÊó•')}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.weekTotal)}</div></div>
                                    </div>

                                    <div onClick={() => setView({ name: 'period', title: `Êú¨Âπ¥ ${new Date().getFullYear()}`, type: 'year', total: stats.yearTotal })} className="bg-art-card p-4 rounded-[20px] flex items-center justify-between border border-white/5 active:bg-white/10 transition-colors cursor-pointer">
                                        <div className="flex items-center gap-3"><div className="w-1.5 h-8 bg-yellow-500 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div><div><div className="text-[15px] font-bold text-white">Êú¨Âπ¥</div><div className="text-[12px] text-art-textSub">{new Date().getFullYear()}Âπ¥</div></div></div>
                                        <div className="text-right"><div className="text-[12px] text-art-textSub">ÊÄªÊîØÂá∫</div><div className="text-[15px] font-mono text-art-accent">{formatMoney(stats.yearTotal)}</div></div>
                                    </div>
                                </div>

                                <MonthlyStats transactions={transactions} currentDate={currentDate} onCategoryClick={handleCategoryClick} />
                            </div>
                        )}

                        {activeTab === 'flow' && (
                            <div className="pb-24 animate-fade-in">
                                <div className="relative h-[140px] w-full overflow-hidden shrink-0 mb-6">
                                    <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2068&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-[#000000]"></div>
                                    
                                    <div className="absolute top-0 left-0 right-0 h-full flex flex-col justify-end p-6 pb-4 z-10 pt-safe">
                                        <div className="text-[18px] font-bold text-white mb-3">Ë¥¶ÂçïÊµÅÊ∞¥</div>
                                        <div className="text-[12px] text-white/60 mb-0.5">ÊÄªÊîØÂá∫</div>
                                        <div className="text-[40px] font-bold text-white font-mono tracking-tighter leading-none -ml-1">
                                            -{formatMoney(transactions.reduce((acc, t) => acc + Math.abs(Number(t.amount)), 0))}
                                        </div>
                                    </div>
                                </div>

                                <div className="px-4 space-y-4">
                                    {groupedByMonth.map((monthGroup) => (
                                        <MonthGroup 
                                            key={monthGroup.key}
                                            year={monthGroup.year}
                                            month={monthGroup.month}
                                            totalExpense={monthGroup.totalExpense}
                                            days={monthGroup.daysSorted}
                                            onViewEditor={(t) => setView({ name: 'editor', transaction: t })}
                                        />
                                    ))}
                                    {transactions.length === 0 && (
                                         <div className="flex flex-col items-center justify-center pt-20 opacity-40">
                                            <div className="text-4xl mb-3">üçÉ</div>
                                            <p className="text-art-textSub">ÊöÇÊó†ÊµÅÊ∞¥ËÆ∞ÂΩï</p>
                                         </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-[30px] left-1/2 -translate-x-1/2 z-50">
                        <button onClick={() => { setIsAddModalOpen(true); haptic('light'); }} className="w-[56px] h-[56px] bg-[#E9E9EB] rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(255,255,255,0.2)] active:scale-90 transition-transform text-black border-4 border-[#121212]"><Plus size={28} strokeWidth={2.5} /></button>
                    </div>

                    <nav className="fixed bottom-0 w-full bg-[#121212]/95 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 z-40">
                        <div className="grid grid-cols-3 h-[50px] relative text-[10px] font-medium text-art-textSub">
                            <button onClick={() => setActiveTab('flow')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='flow' ? 'text-white' : ''}`}><FileText size={22} strokeWidth={activeTab==='flow'?2.5:2} /> ÊµÅÊ∞¥</button>
                            <div className="flex flex-col items-center justify-end pb-1 opacity-50"><span>ËÆ∞‰∏ÄÁ¨î</span></div>
                            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center justify-center gap-1 ${activeTab==='home' ? 'text-white' : ''}`}><Layers size={22} strokeWidth={activeTab==='home'?2.5:2} /> Êä•Ë°®</button>
                        </div>
                    </nav>

                    {isAddModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end justify-center">
                             <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsAddModalOpen(false)}></div>
                             <div className="relative w-full bg-[#1C1C1E] rounded-t-[24px] p-6 pb-safe animate-slide-up border-t border-white/10">
                                <h3 className="text-white text-lg font-bold mb-4">ËÆ∞‰∏ÄÁ¨î</h3>
                                <div className="space-y-4">
                                    <div className="bg-[#2C2C2E] p-4 rounded-2xl flex items-center"><span className="text-2xl mr-3 text-white/50">¬•</span><input autoFocus type="number" className="bg-transparent text-3xl font-bold text-white w-full outline-none" placeholder="0.00" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} /></div>
                                    <div className="grid grid-cols-4 gap-3">
                                        {categoriesList.map(c => (
                                            <button key={c} onClick={() => setForm({...form, category: c})} className={`py-2 rounded-xl text-xs ${form.category === c ? 'bg-white text-black' : 'bg-[#2C2C2E] text-gray-400'}`}>{c}</button>
                                        ))}
                                    </div>
                                    <button onClick={() => handleQuickSave()} className="w-full py-4 bg-white text-black rounded-2xl font-bold mt-2 flex items-center justify-center gap-2">{loading && <Loader2 className="animate-spin" />} Á°ÆËÆ§</button>
                                </div>
                             </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
