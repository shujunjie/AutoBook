<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AIÈöèÊâãËÆ∞">
    <meta name="theme-color" content="#F2F2F7">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>AI ÈöèÊâãËÆ∞</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        brand: {
                            bg: 'var(--bg-base)',
                            card: 'var(--bg-card)',
                            accent: '#2E5CFF',
                            text: 'var(--text-primary)',
                            subtext: 'var(--text-secondary)',
                            border: 'var(--border-color)',
                            input: 'var(--bg-input)',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>

    <style>
        :root {
            --bg-base: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-input: #E5E5EA;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: rgba(0, 0, 0, 0.08);
            --glass-nav: rgba(255, 255, 255, 0.85);
            --glass-tab: rgba(255, 255, 255, 0.92);
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        .dark {
            --bg-base: #000000;
            --bg-card: #1C1C1E;
            --bg-input: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-nav: rgba(28, 28, 30, 0.85);
            --glass-tab: rgba(28, 28, 30, 0.92);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        ::-webkit-scrollbar { display: none; }
        
        html, body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100%; width: 100%;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 44px); }
        input:focus, textarea:focus { outline: none; }
        .glass-nav { background: var(--glass-nav); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); }
        .glass-card { background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .glass-tab { background: var(--glass-tab); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid var(--border-color); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { 
            Home, PieChart, Plus, X, Loader2, Save, Trash2, 
            CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Search, 
            Utensils, Car, ShoppingBag, Gamepad2, Home as HomeIcon, 
            HeartPulse, Banknote, FileText, TrendingUp, Calendar, Moon, Sun,
            ChevronDown
        } from 'lucide-react';
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, isSameDay, getDaysInMonth, startOfDay } from 'date-fns';

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatMoney = (amount) => Math.abs(Number(amount)).toFixed(2);
        
        const haptic = (type = 'light') => {
            if (window.navigator && window.navigator.vibrate) {
                if (type === 'light') window.navigator.vibrate(10);
                if (type === 'medium') window.navigator.vibrate(20);
                if (type === 'success') window.navigator.vibrate([10, 30, 10]);
                if (type === 'error') window.navigator.vibrate([30, 50, 30]);
            }
        };

        const getCategoryIcon = (category) => {
            const size = 18;
            switch (category) {
                case 'È§êÈ•Æ': return <Utensils size={size} />;
                case '‰∫§ÈÄö': return <Car size={size} />;
                case 'Ë¥≠Áâ©': return <ShoppingBag size={size} />;
                case 'Â®±‰πê': return <Gamepad2 size={size} />;
                case 'Â±Ö‰Ωè': return <HomeIcon size={size} />;
                case 'ÂåªÁñó': return <HeartPulse size={size} />;
                case 'Â∑•ËµÑ': return <Banknote size={size} />;
                default: return <FileText size={size} />;
            }
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case 'È§êÈ•Æ': return { bg: 'bg-orange-500/10 dark:bg-orange-500/20', text: 'text-orange-500 dark:text-orange-400', hex: '#fb923c' }; 
                case '‰∫§ÈÄö': return { bg: 'bg-blue-500/10 dark:bg-blue-500/20', text: 'text-blue-500 dark:text-blue-400', hex: '#60a5fa' }; 
                case 'Ë¥≠Áâ©': return { bg: 'bg-pink-500/10 dark:bg-pink-500/20', text: 'text-pink-500 dark:text-pink-400', hex: '#f472b6' }; 
                case 'Â®±‰πê': return { bg: 'bg-purple-500/10 dark:bg-purple-500/20', text: 'text-purple-500 dark:text-purple-400', hex: '#c084fc' }; 
                case 'Â±Ö‰Ωè': return { bg: 'bg-teal-500/10 dark:bg-teal-500/20', text: 'text-teal-600 dark:text-teal-400', hex: '#2dd4bf' }; 
                case 'ÂåªÁñó': return { bg: 'bg-red-500/10 dark:bg-red-500/20', text: 'text-red-500 dark:text-red-400', hex: '#f87171' }; 
                case 'Â∑•ËµÑ': return { bg: 'bg-green-500/10 dark:bg-green-500/20', text: 'text-green-600 dark:text-green-400', hex: '#4ade80' }; 
                default: return { bg: 'bg-gray-200 dark:bg-zinc-700/40', text: 'text-gray-500 dark:text-zinc-400', hex: '#a1a1aa' };    
            }
        };

        const getDateRange = (date, viewMode) => {
            const d = new Date(date);
            switch (viewMode) {
                case 'day': return { start: new Date(d.setHours(0,0,0,0)), end: new Date(d.setHours(23,59,59,999)), label: `${d.getMonth()+1}Êúà${d.getDate()}Êó•` };
                case 'week': { const s = startOfWeek(d, { weekStartsOn: 1 }); const e = endOfWeek(d, { weekStartsOn: 1 }); return { start: s, end: e, label: `${s.getMonth()+1}.${s.getDate()}-${e.getMonth()+1}.${e.getDate()}` }; }
                case 'month': { const s = startOfMonth(d); const e = endOfMonth(d); return { start: s, end: e, label: `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà` }; }
                case 'year': { const s = startOfYear(d); const e = endOfYear(d); return { start: s, end: e, label: `${d.getFullYear()}Âπ¥` }; }
                default: return { start: d, end: d, label: '' };
            }
        };

        // --- üé° Wheel Picker Component (Optical Center Fixed) ---
        const WheelPicker = ({ items, value, onChange, label }) => {
            const scrollerRef = useRef(null);
            const isScrolling = useRef(false);
            const itemHeight = 40; // Changed to 40px to match new calc

            useEffect(() => {
                if (scrollerRef.current && items.length > 0) {
                    const index = items.indexOf(value);
                    if (index > -1) {
                        const setPos = () => {
                            if(scrollerRef.current) scrollerRef.current.scrollTop = index * itemHeight;
                        };
                        setTimeout(setPos, 10);
                        setTimeout(setPos, 100);
                    }
                }
            }, [value]); 

            const handleScroll = (e) => {
                clearTimeout(scrollerRef.current.scrollTimeout);
                scrollerRef.current.scrollTimeout = setTimeout(() => {
                    const index = Math.round(e.target.scrollTop / itemHeight);
                    if (index >= 0 && index < items.length) {
                        const selectedItem = items[index];
                        if (selectedItem !== value) {
                            onChange(selectedItem);
                        }
                    }
                }, 100);
            };

            return (
                <div className="h-[200px] relative flex-1 overflow-hidden group">
                    <div 
                        ref={scrollerRef}
                        className="h-full overflow-y-auto snap-y snap-mandatory no-scrollbar py-[80px]"
                        style={{ touchAction: 'pan-y', overscrollBehaviorY: 'contain' }}
                        onScroll={handleScroll}
                    >
                        {items.map((item) => (
                            <div 
                                key={item} 
                                className={`h-[40px] flex items-center justify-center snap-center text-[17px] transition-all duration-200 
                                    ${item === value ? 'font-semibold text-brand-text scale-110' : 'text-brand-subtext/60 scale-95'}`}
                            >
                                {/* Added pt-1 for optical centering */}
                                <span className="pt-1 leading-none">{item}{label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- üìÖ Date Picker Modal (Refined: Natural Gray Bar & Optical Center) ---
        const DatePickerModal = ({ onClose, currentDate, onDateSelect }) => {
            const today = new Date();
            const maxYear = today.getFullYear();
            const maxMonth = today.getMonth() + 1; 

            const [y, setY] = useState(currentDate.getFullYear());
            const [m, setM] = useState(currentDate.getMonth() + 1);

            const years = Array.from({length: 11}, (_, i) => maxYear - i).reverse();
            const monthLimit = (y === maxYear) ? maxMonth : 12;
            const months = Array.from({length: monthLimit}, (_, i) => i + 1);

            useEffect(() => {
                if (!months.includes(m)) setM(months[months.length - 1]);
            }, [y, m, months]);

            const handleConfirm = () => {
                const newDate = new Date(y, m - 1, 1);
                onDateSelect(newDate);
                onClose();
            };

            const stopPropagation = (e) => e.stopPropagation();

            return (
                <div 
                    className="fixed inset-0 z-[70] flex items-end justify-center"
                    onTouchStart={stopPropagation}
                    onTouchMove={stopPropagation}
                    onTouchEnd={stopPropagation}
                >
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full sm:max-w-md bg-brand-card rounded-t-[28px] shadow-2xl overflow-hidden flex flex-col animate-slide-up border-t border-brand-border sm:m-4 pb-safe">
                        
                        {/* Header */}
                        <div className="flex justify-between items-center px-6 pt-5 pb-2">
                            <button onClick={onClose} className="text-[15px] text-brand-subtext hover:text-brand-text transition-colors">ÂèñÊ∂à</button>
                            <h3 className="text-[17px] font-bold text-brand-text">ÈÄâÊã©Êúà‰ªΩ</h3>
                            <button onClick={handleConfirm} className="text-[15px] font-bold text-brand-accent">Á°ÆÂÆö</button>
                        </div>
                        
                        <div className="relative px-6 pb-6 pt-2">
                            {/* üî• Visual Highlight Bar (Height 34px, rounded-lg) */}
                            <div className="absolute top-1/2 left-4 right-4 h-[34px] -translate-y-1/2 bg-gray-200/80 dark:bg-white/10 rounded-lg pointer-events-none z-0"></div>
                            
                            <div className="flex relative z-10 w-full overflow-hidden">
                                <WheelPicker 
                                    items={years} 
                                    value={y} 
                                    onChange={(val) => { setY(val); haptic('light'); }} 
                                    label="Âπ¥" 
                                />
                                <WheelPicker 
                                    items={months} 
                                    value={m} 
                                    onChange={(val) => { setM(val); haptic('light'); }} 
                                    label="Êúà" 
                                />
                            </div>

                            <div className="absolute top-0 left-0 right-0 h-[80px] bg-gradient-to-b from-brand-card to-transparent pointer-events-none z-20"></div>
                            <div className="absolute bottom-0 left-0 right-0 h-[80px] bg-gradient-to-t from-brand-card to-transparent pointer-events-none z-20"></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type }) => {
            if (!message) return null;
            return (
                <div className="fixed top-safe left-1/2 -translate-x-1/2 z-[100] mt-4 animate-fade-in pointer-events-none">
                    <div className={`flex items-center gap-3 px-5 py-3 rounded-full shadow-xl backdrop-blur-xl border border-white/10
                        ${type === 'error' ? 'bg-red-100 text-red-600 dark:bg-red-500/20 dark:text-red-400' : 'bg-white text-black dark:bg-zinc-800 dark:text-white'}`}>
                        {type === 'error' ? <AlertCircle size={18} /> : <CheckCircle size={18} className="text-brand-accent" />}
                        <span className="text-[13px] font-medium">{message}</span>
                    </div>
                </div>
            );
        };

        // --- Charts ---
        const InteractiveLineChart = ({ data, totalExpense }) => { /* ... Keep Same ... */ 
            const [focusedIndex, setFocusedIndex] = useState(null);
            const containerRef = useRef(null);

            const handleTouch = (e) => {
                const rect = containerRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const x = clientX - rect.left;
                const width = rect.width;
                if (data.length > 1) {
                    const index = Math.round((x / width) * (data.length - 1));
                    const clampedIndex = Math.max(0, Math.min(data.length - 1, index));
                    if (clampedIndex !== focusedIndex) { setFocusedIndex(clampedIndex); haptic('light'); }
                }
            };
            const handleLeave = () => setFocusedIndex(null);
            const maxVal = Math.max(...data.map(d => d.value), 10); 
            const points = data.map((d, i) => {
                const x = data.length > 1 ? (i / (data.length - 1)) * 100 : 50; 
                const y = 100 - (d.value / maxVal) * 80; 
                return { x, y, ...d };
            });
            let pathData = '';
            if (data.length > 1) {
                pathData = points.reduce((acc, p, i, a) => {
                    if (i === 0) return `M ${p.x},${p.y}`;
                    const prev = a[i - 1]; const cp1x = prev.x + (p.x - prev.x) / 2; const cp1y = prev.y; const cp2x = p.x - (p.x - prev.x) / 2; const cp2y = p.y;
                    return `${acc} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p.x},${p.y}`;
                }, '');
            } else if (data.length === 1) { pathData = `M 0,${points[0].y} L 100,${points[0].y}`; }
            const areaPath = `${pathData} L 100,120 L 0,120 Z`;
            const displayAmount = focusedIndex !== null ? data[focusedIndex].value : totalExpense;
            let displayLabel = 'Êú¨ÊúàÊÄªÊîØÂá∫';
            if (focusedIndex !== null) { const d = data[focusedIndex]; displayLabel = `${d.date.getDate()}Êó•`; }

            return (
                <div className="glass-card rounded-[28px] p-6 select-none relative overflow-hidden group transition-colors duration-300">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-brand-accent/5 rounded-full blur-3xl pointer-events-none"></div>
                    <div className="mb-6 flex flex-col items-center h-[50px] justify-center relative z-10">
                        <span className="text-[12px] text-brand-subtext font-medium tracking-wide uppercase mb-1">{displayLabel}</span>
                        <span className="text-[34px] font-bold text-brand-text font-mono tracking-tight">¬•{formatMoney(displayAmount)}</span>
                    </div>
                    <div ref={containerRef} className="relative h-[160px] w-full touch-none cursor-crosshair active:cursor-grabbing z-10"
                        onTouchStart={handleTouch} onTouchMove={handleTouch} onTouchEnd={handleLeave} onMouseMove={handleTouch} onMouseLeave={handleLeave}>
                        <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                            <defs>
                                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#2E5CFF" stopOpacity="0.5" /><stop offset="100%" stopColor="#2E5CFF" stopOpacity="0" /></linearGradient>
                            </defs>
                            <line x1="0" y1="20" x2="100" y2="20" stroke="currentColor" strokeOpacity="0.1" strokeWidth="0.5" strokeDasharray="4 4" className="text-brand-text" />
                            <line x1="0" y1="100" x2="100" y2="100" stroke="currentColor" strokeOpacity="0.1" strokeWidth="0.5" className="text-brand-text" />
                            <path d={areaPath} fill="url(#chartGradient)" />
                            <path d={pathData} fill="none" stroke="#2E5CFF" strokeWidth="2.5" strokeLinecap="round" vectorEffect="non-scaling-stroke" />
                            {focusedIndex !== null && (<g><line x1={points[focusedIndex].x} y1="0" x2={points[focusedIndex].x} y2="100" stroke="currentColor" strokeOpacity="0.5" strokeWidth="1" vectorEffect="non-scaling-stroke" strokeDasharray="2 2" className="text-brand-text" /><circle cx={points[focusedIndex].x} cy={points[focusedIndex].y} r="6" fill="#2E5CFF" stroke="#FFFFFF" strokeWidth="3" vectorEffect="non-scaling-stroke" /></g>)}
                        </svg>
                        <div className="absolute top-full left-0 w-full flex justify-between text-[10px] text-brand-subtext mt-3 font-medium"><span>1Êó•</span><span>{data.length}Êó•</span></div>
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, children, title, showClose = true }) => { /* ... Keep Same ... */
             if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/30 dark:bg-black/60 backdrop-blur-md transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full sm:max-w-md bg-brand-card rounded-t-[32px] sm:rounded-[32px] shadow-2xl overflow-hidden flex flex-col max-h-[92vh] animate-slide-up border border-brand-border sm:m-4 pb-safe transition-colors duration-300">
                        <div className="flex justify-between items-center px-6 pt-6 pb-2">
                            <h3 className="text-[20px] font-bold text-brand-text tracking-tight">{title}</h3>
                            {showClose && (
                                <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-brand-input rounded-full text-brand-subtext hover:text-brand-text transition-colors">
                                    <X size={18} />
                                </button>
                            )}
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
         };

        // --- Main App ---

        function App() {
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const [homeViewMode, setHomeViewMode] = useState('month'); 
            const [pieViewMode, setPieViewMode] = useState('month'); 
            
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false); // Date Picker State
            
            const [currentTransaction, setCurrentTransaction] = useState(null); 
            
            const [toast, setToast] = useState({ message: '', type: '' });
            const [searchQuery, setSearchQuery] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            
            const [pullY, setPullY] = useState(0);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const startY = useRef(0);
            
            const [form, setForm] = useState({ amount: '', merchant: '', category: 'È§êÈ•Æ', date: new Date().toISOString().split('T')[0], note: '' });
            const searchInputRef = useRef(null);

            const categories = ['È§êÈ•Æ', '‰∫§ÈÄö', 'Ë¥≠Áâ©', 'Â®±‰πê', 'Â±Ö‰Ωè', 'ÂåªÁñó', 'Â∑•ËµÑ', 'ÂÖ∂‰ªñ'];

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#F2F2F7');
                }
            }, [isDarkMode]);

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                haptic(type === 'error' ? 'error' : 'success');
                setTimeout(() => setToast({ message: '', type: '' }), 2500);
            };

            useEffect(() => {
                fetchTransactions();
                const sub = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, fetchTransactions).subscribe();
                return () => supabase.removeChannel(sub);
            }, [currentDate, pieViewMode, activeTab, homeViewMode]);

            const fetchTransactions = async () => {
                if (!isRefreshing) setLoading(true);
                const monthRange = getDateRange(currentDate, 'month');
                const statsRange = getDateRange(currentDate, pieViewMode);
                const start = new Date(Math.min(monthRange.start, statsRange.start));
                const end = new Date(Math.max(monthRange.end, statsRange.end));
                const { data, error } = await supabase.from('transactions').select('*').gte('date', start.toISOString()).lte('date', end.toISOString()).order('date', { ascending: false });
                if (!error) setTransactions(data || []);
                setLoading(false);
            };

            // Touch Handlers
            const handleTouchStart = (e) => { if (window.scrollY === 0) startY.current = e.touches[0].clientY; };
            const handleTouchMove = (e) => {
                const y = e.touches[0].clientY;
                const delta = y - startY.current;
                if (window.scrollY === 0 && delta > 0) setPullY(delta * 0.4);
            };
            const handleTouchEnd = async () => {
                if (pullY > 60) {
                    setIsRefreshing(true); setPullY(60); haptic('medium');
                    await fetchTransactions(); haptic('success');
                    setTimeout(() => { setIsRefreshing(false); setPullY(0); }, 500);
                } else setPullY(0);
            };

            const handleDateSelect = (date) => {
                setCurrentDate(date);
                haptic('success');
            };

            const handleOpenEdit = (t) => {
                setCurrentTransaction(t);
                setForm({ amount: Math.abs(t.amount), merchant: t.merchant, category: t.category, date: t.date.split('T')[0], note: t.note || '' });
                setIsEditModalOpen(true); haptic('light');
            };

            const handleSave = async (isEdit = false) => {
                if (!form.amount) return showToast("ËØ∑ËæìÂÖ•ÈáëÈ¢ù", 'error');
                setLoading(true);
                const payload = { amount: parseFloat(form.amount), merchant: form.merchant || (form.category), category: form.category, date: new Date(form.date).toISOString(), note: form.note };
                if (isEdit) await supabase.from('transactions').update(payload).eq('id', currentTransaction.id);
                else await supabase.from('transactions').insert([payload]);
                showToast(isEdit ? "‰øÆÊîπÊàêÂäü" : "ËÆ∞Ë¥¶ÊàêÂäü");
                setIsAddModalOpen(false); setIsEditModalOpen(false);
                if (!isEdit) setForm({ ...form, amount: '', note: '', merchant: '' });
                setLoading(false);
            };

            const handleDelete = async () => {
                if (!confirm("Á°ÆÂÆöÂà†Èô§Ôºü")) return;
                await supabase.from('transactions').delete().eq('id', currentTransaction.id);
                showToast("Â∑≤Âà†Èô§");
                setTransactions(prev => prev.filter(t => t.id !== currentTransaction.id));
                setIsEditModalOpen(false);
            };

            const totalExpense = useMemo(() => {
                const range = getDateRange(currentDate, 'month');
                return transactions.filter(t => new Date(t.date) >= range.start && new Date(t.date) <= range.end)
                    .reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);
            }, [transactions, currentDate]);

            // üî• CHANGED: Always calculate TODAY's expense (Real Today)
            const todayExpense = useMemo(() => {
                const todayStr = new Date().toDateString();
                return transactions
                    .filter(t => new Date(t.date).toDateString() === todayStr)
                    .reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);
            }, [transactions]);

            const lineChartData = useMemo(() => {
                if (activeTab !== 'stats') return [];
                const range = getDateRange(currentDate, 'month');
                const daysInMonth = range.end.getDate();
                const points = [];
                for(let i=1; i<=daysInMonth; i++) {
                    let val = 0;
                    transactions.forEach(t => {
                        const d = new Date(t.date);
                        if(d >= range.start && d <= range.end && d.getDate() === i) val += Math.abs(Number(t.amount));
                    });
                    points.push({ label: `${i}`, value: val, date: new Date(currentDate.getFullYear(), currentDate.getMonth(), i) });
                }
                return points;
            }, [transactions, currentDate, activeTab]);

            const categoryStats = useMemo(() => {
                const stats = {};
                let sum = 0;
                const range = getDateRange(currentDate, pieViewMode);
                const filtered = transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
                filtered.forEach(t => {
                    const val = Math.abs(Number(t.amount));
                    if (!stats[t.category]) stats[t.category] = 0;
                    stats[t.category] += val;
                    sum += val;
                });
                return {
                    data: Object.entries(stats).map(([name, value]) => ({ name, value, displayValue: formatMoney(value), percent: sum !== 0 ? ((value / sum) * 100).toFixed(1) : "0.0" })).sort((a, b) => b.value - a.value),
                    total: sum
                };
            }, [transactions, currentDate, pieViewMode]);

            const pieGradient = useMemo(() => {
                if (categoryStats.data.length === 0) return 'conic-gradient(var(--bg-input) 0% 100%)';
                let gradient = 'conic-gradient(';
                let currentPercent = 0;
                categoryStats.data.forEach((item) => {
                    const color = getCategoryColor(item.name).hex;
                    const nextPercent = currentPercent + parseFloat(item.percent);
                    gradient += `${color} ${currentPercent}% ${nextPercent}%, `;
                    currentPercent = nextPercent;
                });
                return gradient.slice(0, -2) + ')';
            }, [categoryStats, isDarkMode]);

            const filteredTransactions = useMemo(() => {
                // Home list always follows Month logic (as user requested: card is today, list is month)
                const range = getDateRange(currentDate, 'month');
                let list = transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
                if (searchQuery) list = list.filter(t => t.merchant?.includes(searchQuery) || t.note?.includes(searchQuery) || t.category.includes(searchQuery));
                return list;
            }, [transactions, searchQuery, currentDate, activeTab]);

            const groupedTransactions = useMemo(() => {
                const groups = {};
                filteredTransactions.forEach(t => {
                    const date = new Date(t.date);
                    const today = new Date();
                    let header = `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
                    if (date.toDateString() === today.toDateString()) header = "‰ªäÂ§©";
                    else if (date.toDateString() === new Date(today.setDate(today.getDate()-1)).toDateString()) header = "Êò®Â§©";
                    const weekDay = ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'][date.getDay()];
                    if (header !== "‰ªäÂ§©" && header !== "Êò®Â§©") header += ` ¬∑ ${weekDay}`;
                    if (!groups[header]) groups[header] = { total: 0, items: [] };
                    groups[header].items.push(t);
                    groups[header].total += Math.abs(Number(t.amount));
                });
                return groups;
            }, [filteredTransactions]);

            const headerLabel = useMemo(() => {
                return `${currentDate.getFullYear()}Âπ¥ ${currentDate.getMonth() + 1}Êúà`;
            }, [currentDate]);

            return (
                <div className="min-h-full" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <Toast message={toast.message} type={toast.type} />
                    
                    {/* Only render modal if open to force re-mount and state sync */}
                    {isDatePickerOpen && (
                        <DatePickerModal 
                            isOpen={isDatePickerOpen}
                            onClose={() => setIsDatePickerOpen(false)} 
                            currentDate={currentDate} 
                            onDateSelect={handleDateSelect} 
                        />
                    )}

                    <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-[-1] opacity-0 dark:opacity-100 transition-opacity duration-500">
                        <div className="absolute top-[-10%] left-[-10%] w-[300px] h-[300px] bg-brand-accent/10 rounded-full blur-[100px] animate-blob"></div>
                        <div className="absolute top-[20%] right-[-10%] w-[250px] h-[250px] bg-purple-600/10 rounded-full blur-[80px] animate-blob" style={{animationDelay: '2s'}}></div>
                    </div>

                    <div className="fixed top-[120px] left-0 w-full flex justify-center pointer-events-none z-[100] transition-opacity duration-300" style={{ transform: `translateY(${pullY * 0.5}px)`, opacity: pullY > 20 ? 1 : 0 }}>
                        <div className="bg-brand-card p-3 rounded-full backdrop-blur-md shadow-2xl border border-brand-border">
                            <Loader2 className={`text-brand-accent ${isRefreshing ? 'animate-spin' : ''}`} size={24} style={{ transform: `rotate(${pullY * 2}deg)` }} />
                        </div>
                    </div>

                    <header className="fixed top-0 w-full glass-nav z-40 pt-safe transition-all duration-300">
                        <div className="flex justify-between items-center px-5 h-[52px] max-w-md mx-auto">
                            {showSearch ? (
                                <div className="flex items-center w-full animate-fade-in">
                                    <div className="flex-1 bg-brand-input rounded-xl flex items-center px-3 py-2 mr-3 transition-all">
                                        <Search size={16} className="text-brand-subtext mr-2" />
                                        <input ref={searchInputRef} autoFocus type="text" placeholder="ÊêúÁ¥¢..." className="bg-transparent border-none text-[14px] text-brand-text placeholder-gray-400 w-full p-0" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                        {searchQuery && <button onClick={() => setSearchQuery('')} className="bg-gray-400/20 rounded-full p-0.5"><X size={12} className="text-brand-subtext" /></button>}
                                    </div>
                                    <button onClick={() => { setShowSearch(false); setSearchQuery(''); }} className="text-brand-accent text-[15px]">ÂèñÊ∂à</button>
                                </div>
                            ) : (
                                <>
                                    {/* Spacer for Centering */}
                                    <div className="w-[32px]"></div>
                                    
                                    <div className="flex flex-col items-center">
                                        {/* Removed "Ë¥¶Âçï" span */}
                                        <div className="flex items-center gap-1 cursor-pointer bg-brand-input/50 px-3 py-0.5 rounded-lg active:scale-95 transition-all" onClick={() => { setIsDatePickerOpen(true); haptic('light'); }}> 
                                            <h2 className="text-[17px] font-bold text-brand-text tracking-tight">{headerLabel}</h2>
                                            <ChevronDown size={14} className="text-brand-subtext" />
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-brand-subtext hover:text-brand-text transition-colors active:scale-90">
                                            {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                                        </button>
                                        {activeTab === 'home' && <button onClick={() => setShowSearch(true)} className="p-2 text-brand-accent hover:opacity-70 transition-opacity active:scale-90"><Search size={22} /></button>}
                                    </div>
                                </>
                            )}
                        </div>
                    </header>
                    
                    {/* Content (Main, Modals) */}
                    <main className="pt-safe mt-[68px] px-4 max-w-md mx-auto space-y-6 transition-transform duration-300 ease-out" style={{ transform: `translateY(${pullY}px)` }}>
                        {activeTab === 'home' && (
                            <div className="animate-fade-in">
                                {!showSearch && (
                                    <div className="relative overflow-hidden rounded-[32px] bg-white dark:bg-gradient-to-br dark:from-[#1c1c1e] dark:to-[#121212] border border-brand-border p-6 mb-6 shadow-xl shadow-gray-200/50 dark:shadow-none group transition-all duration-300">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-brand-accent/10 rounded-full blur-3xl pointer-events-none group-hover:bg-brand-accent/20 transition-all duration-700 opacity-0 dark:opacity-100"></div>
                                        <div className="relative z-10">
                                            <p className="text-brand-subtext text-[13px] font-medium uppercase tracking-wide mb-1">
                                                ‰ªäÊó•ÊîØÂá∫
                                            </p>
                                            <h2 className="text-[40px] font-bold text-brand-text tracking-tight flex items-baseline mb-4 font-mono">
                                                <span className="text-[24px] mr-1 text-brand-subtext font-normal">¬•</span>
                                                {formatMoney(todayExpense)}
                                            </h2>
                                            <div className="flex justify-between items-center text-[12px] font-medium text-brand-subtext pt-4 border-t border-brand-border">
                                                <span>Êú¨ÊúàÁ¥ØËÆ° ¬•{formatMoney(totalExpense)}</span>
                                                <span>Êó•Âùá ¬•{Math.round(totalExpense / Math.max(1, new Date().getDate()))}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => { setIsAddModalOpen(true); haptic('light'); }} className="absolute right-6 top-6 w-12 h-12 bg-brand-accent text-white rounded-full flex items-center justify-center shadow-lg shadow-brand-accent/30 active:scale-90 transition-transform">
                                            <Plus size={24} />
                                        </button>
                                    </div>
                                )}
                                <div className="space-y-4 pb-safe mb-24">
                                    {loading && !isRefreshing ? (
                                        <div className="flex justify-center py-12"><Loader2 className="animate-spin text-brand-subtext" /></div>
                                    ) : Object.keys(groupedTransactions).length === 0 ? (
                                        <div className="text-center py-20 opacity-50 flex flex-col items-center">
                                            <div className="w-16 h-16 bg-brand-input rounded-full flex items-center justify-center mb-4"><FileText size={24} className="text-brand-subtext" /></div>
                                            <p className="text-[14px] text-brand-subtext">ÊöÇÊó†ËÆ∞ÂΩï</p>
                                        </div>
                                    ) : (
                                        Object.entries(groupedTransactions).map(([header, group]) => (
                                            <div key={header}>
                                                <div className="flex justify-between items-baseline px-4 mb-2">
                                                    <h3 className="text-[13px] font-semibold text-brand-subtext uppercase tracking-wide">{header}</h3>
                                                    <span className="text-[12px] text-brand-subtext font-mono">¬•{formatMoney(group.total)}</span>
                                                </div>
                                                <div className="glass-card rounded-[24px] overflow-hidden">
                                                    {group.items.map((t, idx) => {
                                                        const color = getCategoryColor(t.category);
                                                        const isLast = idx === group.items.length - 1;
                                                        return (
                                                            <div key={t.id} className="relative group">
                                                                <button onClick={() => handleOpenEdit(t)} className="w-full flex items-center px-5 py-4 hover:bg-black/5 dark:hover:bg-white/5 active:opacity-70 transition-colors text-left">
                                                                    <div className={`w-10 h-10 rounded-2xl flex items-center justify-center mr-4 ${color.bg} ${color.text} shadow-sm`}>
                                                                        {getCategoryIcon(t.category)}
                                                                    </div>
                                                                    <div className="flex-1 min-w-0 mr-3">
                                                                        <p className="text-[16px] font-medium text-brand-text truncate mb-0.5">{t.merchant || t.category}</p>
                                                                        <p className="text-[13px] text-brand-subtext truncate">{t.note || t.category}</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <p className="text-[16px] font-bold text-brand-text font-mono">{formatMoney(t.amount)}</p>
                                                                    </div>
                                                                </button>
                                                                {!isLast && <div className="absolute bottom-0 left-[76px] right-0 h-[1px] bg-brand-border"></div>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                        {/* Stats Tab remains same */}
                        {activeTab === 'stats' && (
                           <div className="animate-fade-in space-y-6 pb-safe mb-24">
                             <div className="glass-card rounded-[32px] p-2">
                                <div className="flex items-center justify-between mb-2 px-5 pt-4">
                                    <h3 className="text-[13px] font-semibold text-brand-subtext uppercase tracking-wide flex items-center gap-2">
                                        <TrendingUp size={14} className="text-brand-accent" /> Ë∂ãÂäø
                                    </h3>
                                </div>
                                <div className="px-1 pb-1">
                                    <InteractiveLineChart data={lineChartData} totalExpense={totalExpense} />
                                </div>
                             </div>
                             <div className="glass-card rounded-[32px] p-6 flex flex-col items-center">
                                <div className="flex bg-brand-input p-1 rounded-xl w-full mb-8 max-w-[280px] border border-brand-border shadow-inner">
                                    {['day', 'week', 'month', 'year'].map(mode => (
                                        <button key={mode} onClick={() => { setPieViewMode(mode); haptic('light'); }} className={`flex-1 py-1.5 text-[12px] font-medium rounded-lg transition-all duration-300 ${pieViewMode === mode ? 'bg-white dark:bg-zinc-700 text-brand-text shadow-sm' : 'text-brand-subtext hover:text-brand-text'}`}>
                                            {{day:'Êó•', week:'Âë®', month:'Êúà', year:'Âπ¥'}[mode]}
                                        </button>
                                    ))}
                                </div>
                                <div className="w-56 h-56 rounded-full relative flex items-center justify-center mb-8 shadow-lg ring-1 ring-brand-border" style={{ background: pieGradient }}>
                                    <div className="w-44 h-44 bg-brand-card rounded-full flex flex-col items-center justify-center shadow-inner z-10 transition-colors duration-300">
                                        <span className="text-brand-subtext text-[11px] font-semibold uppercase tracking-wider mb-1">
                                            {pieViewMode === 'day' ? '‰ªäÊó•' : pieViewMode === 'week' ? 'Êú¨Âë®' : pieViewMode === 'year' ? '‰ªäÂπ¥' : 'Êú¨Êúà'}
                                        </span>
                                        <span className="text-brand-text text-[28px] font-bold font-mono tracking-tight">¬•{Math.round(categoryStats.total)}</span>
                                    </div>
                                </div>
                                <div className="w-full space-y-3">
                                    {categoryStats.data.map((cat, idx) => {
                                        const color = getCategoryColor(cat.name);
                                        return (
                                            <div key={cat.name} className="flex items-center gap-4 p-3 rounded-2xl hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                                                <div className={`w-10 h-10 rounded-2xl flex items-center justify-center ${color.bg} ${color.text} ring-1 ring-white/5`}>
                                                    {getCategoryIcon(cat.name)}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-center text-[14px] mb-2">
                                                        <span className="font-medium text-brand-text">{cat.name}</span>
                                                        <div className="flex items-baseline gap-2">
                                                            <span className="font-bold text-brand-text font-mono">¬•{cat.displayValue}</span>
                                                            <span className="text-[12px] text-brand-subtext w-10 text-right font-mono">{cat.percent}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="h-1.5 bg-brand-input rounded-full overflow-hidden w-full border border-brand-border">
                                                        <div className={`h-full rounded-full transition-all duration-1000 ease-out`} style={{ width: `${cat.percent}%`, backgroundColor: color.hex }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {categoryStats.data.length === 0 && <div className="text-center text-brand-subtext text-sm py-4">ÊöÇÊó†Êï∞ÊçÆ</div>}
                                </div>
                             </div>
                           </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 w-full glass-tab z-50 pb-safe pt-2">
                        <div className="grid grid-cols-2 h-[50px] relative">
                            <button onClick={() => {setActiveTab('home'); haptic('light');}} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab==='home' ? 'text-brand-accent' : 'text-brand-subtext hover:text-brand-text'}`}>
                                <Home size={22} strokeWidth={activeTab==='home' ? 3 : 2} className="transition-all" />
                                <span className="text-[10px] font-medium">ÊòéÁªÜ</span>
                            </button>
                            <button onClick={() => {setActiveTab('stats'); haptic('light');}} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab==='stats' ? 'text-brand-accent' : 'text-brand-subtext hover:text-brand-text'}`}>
                                <PieChart size={22} strokeWidth={activeTab==='stats' ? 3 : 2} className="transition-all" />
                                <span className="text-[10px] font-medium">ÂàÜÊûê</span>
                            </button>
                        </div>
                    </nav>

                    <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="ËÆ∞‰∏ÄÁ¨î">
                        <div className="space-y-6">
                            <div>
                                <label className="text-[11px] font-bold text-brand-subtext uppercase tracking-wide ml-1">ÈáëÈ¢ù</label>
                                <div className="bg-brand-input rounded-[20px] px-5 py-4 flex items-center mt-2 border border-brand-border focus-within:ring-2 focus-within:ring-brand-accent/20 transition-all shadow-inner">
                                    <span className="text-[24px] text-brand-subtext mr-2 font-light">¬•</span>
                                    <input type="number" value={form.amount} onChange={(e) => setForm({...form, amount: e.target.value})} placeholder="0.00" className="w-full bg-transparent text-[32px] font-bold text-brand-text placeholder-gray-400 h-[40px] font-mono" autoFocus />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[11px] font-bold text-brand-subtext uppercase tracking-wide ml-1">ÂïÜÊà∑</label><input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} placeholder="ÈÄâÂ°´" className="w-full mt-2 bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text placeholder-gray-400 border border-brand-border focus:border-brand-accent focus:outline-none transition-all" /></div>
                                <div><label className="text-[11px] font-bold text-brand-subtext uppercase tracking-wide ml-1">Êó•Êúü</label><input type="date" value={form.date} onChange={(e) => setForm({...form, date: e.target.value})} className="w-full mt-2 bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text border border-brand-border focus:border-brand-accent focus:outline-none transition-all" /></div>
                            </div>
                            <div>
                                <label className="text-[11px] font-bold text-brand-subtext uppercase tracking-wide ml-1">ÂàÜÁ±ª</label>
                                <div className="grid grid-cols-4 gap-3 mt-2">
                                    {categories.map(cat => {
                                        const color = getCategoryColor(cat);
                                        const isSelected = form.category === cat;
                                        return (
                                            <button key={cat} onClick={() => {setForm({...form, category: cat}); haptic('light');}} className={`flex flex-col items-center justify-center py-3 rounded-[18px] transition-all active:scale-95 duration-200 border ${isSelected ? `bg-brand-text text-brand-card shadow-lg` : 'bg-brand-input border-brand-border hover:opacity-80'}`}>
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center mb-1.5 ${isSelected ? 'text-brand-accent bg-brand-card' : color.text}`}>
                                                    {getCategoryIcon(cat)}
                                                </div>
                                                <span className={`text-[11px] font-bold`}>{cat}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            <div><label className="text-[11px] font-bold text-brand-subtext uppercase tracking-wide ml-1">Â§áÊ≥®</label><textarea value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} placeholder="Ê∑ªÂä†Â§áÊ≥®..." rows="2" className="w-full mt-2 bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text placeholder-gray-400 border border-brand-border focus:border-brand-accent focus:outline-none resize-none transition-all"></textarea></div>
                            <button onClick={() => handleSave(false)} disabled={loading} className="w-full bg-brand-accent hover:bg-blue-600 text-white font-bold text-[17px] py-4 rounded-[20px] shadow-lg shadow-brand-accent/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2">
                                {loading ? <Loader2 className="animate-spin" /> : 'ÂÆåÊàêËÆ∞Ë¥¶'}
                            </button>
                        </div>
                    </Modal>

                    <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title="ÁºñËæëËÆ∞ÂΩï">
                        <div className="space-y-6">
                            <div className="bg-brand-input rounded-[20px] px-5 py-4 flex items-center border border-brand-border shadow-inner"><span className="text-[24px] text-brand-subtext mr-2 font-light">¬•</span><input type="number" value={form.amount} onChange={(e) => setForm({...form, amount: e.target.value})} className="w-full bg-transparent text-[32px] font-bold text-brand-text placeholder-gray-400 h-[40px] font-mono" /></div>
                            <div className="grid grid-cols-4 gap-3">
                                {categories.map(cat => {
                                    const color = getCategoryColor(cat);
                                    const isSelected = form.category === cat;
                                    return (
                                        <button key={cat} onClick={() => {setForm({...form, category: cat}); haptic('light');}} className={`flex flex-col items-center justify-center py-2.5 rounded-[16px] transition-all ${isSelected ? `bg-brand-text text-brand-card shadow-md` : 'bg-brand-input border border-brand-border'}`}>
                                            <div className={`w-7 h-7 rounded-full flex items-center justify-center mb-1 ${isSelected ? 'text-brand-accent bg-brand-card' : color.text} scale-90`}>{getCategoryIcon(cat)}</div>
                                            <span className={`text-[10px] font-bold`}>{cat}</span>
                                        </button>
                                    );
                                })}
                            </div>
                            <div className="space-y-3">
                                <input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} className="w-full bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text border border-brand-border focus:outline-none" />
                                <input type="date" value={form.date} onChange={(e) => setForm({...form, date: e.target.value})} className="w-full bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text border border-brand-border focus:outline-none" />
                                <textarea value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} rows="2" className="w-full bg-brand-input rounded-[16px] px-4 py-3.5 text-[15px] text-brand-text border border-brand-border focus:outline-none resize-none"></textarea>
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button onClick={handleDelete} className="flex-1 bg-red-100 hover:bg-red-200 dark:bg-red-500/10 dark:hover:bg-red-500/20 text-red-500 font-semibold text-[16px] py-4 rounded-[18px] active:scale-95 transition-all flex items-center justify-center gap-2"><Trash2 size={18} /> Âà†Èô§</button>
                                <button onClick={() => handleSave(true)} className="flex-[2] bg-brand-accent hover:bg-blue-600 text-white font-bold text-[16px] py-4 rounded-[18px] shadow-lg shadow-brand-accent/20 active:scale-95 transition-all">‰øùÂ≠ò‰øÆÊîπ</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
