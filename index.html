<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI随手记">
    <meta name="theme-color" content="#F2F2F7">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>AI 随手记</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        brand: {
                            bg: 'var(--bg-base)',
                            card: 'var(--bg-card)',
                            accent: '#2E5CFF',
                            text: 'var(--text-primary)',
                            subtext: 'var(--text-secondary)',
                            border: 'var(--border-color)',
                            input: 'var(--bg-input)',
                        }
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-out-right': 'slideOutRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        slideOutRight: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>

    <style>
        :root {
            --bg-base: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-input: #E5E5EA;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: rgba(0, 0, 0, 0.08);
            --glass-nav: rgba(255, 255, 255, 0.85);
            --glass-tab: rgba(255, 255, 255, 0.92);
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        .dark {
            --bg-base: #000000;
            --bg-card: #1C1C1E;
            --bg-input: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-nav: rgba(28, 28, 30, 0.85);
            --glass-tab: rgba(28, 28, 30, 0.92);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        ::-webkit-scrollbar { display: none; }
        
        html, body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100%; width: 100%; overflow: hidden;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 44px); }
        input:focus, textarea:focus { outline: none; }
        .glass-nav { background: var(--glass-nav); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); }
        .glass-card { background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .glass-tab { background: var(--glass-tab); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid var(--border-color); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .page-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            background-color: var(--bg-base);
            z-index: 50;
            -webkit-overflow-scrolling: touch;
        }
        .page-enter { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .ios-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { 
            Home, PieChart, Plus, X, Loader2, Save, Trash2, 
            CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Search, 
            Utensils, Car, ShoppingBag, Gamepad2, Home as HomeIcon, 
            HeartPulse, Banknote, FileText, TrendingUp, Calendar, Moon, Sun,
            ChevronDown, LayoutGrid, ArrowLeft, Video, MessageCircle, Wallet 
        } from 'lucide-react';
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, isSameDay, getDaysInMonth, startOfDay } from 'date-fns';

        const SUPABASE_URL = 'https://lsggbiatbucdhhrgftra.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZ2diaWF0YnVjZGhocmdmdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTA0NzIsImV4cCI6MjA3OTQ2NjQ3Mn0.GcAkpXZAETeSBSXoptYYmrlquwab0EapH7E8b5HCN7w';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const formatMoney = (amount) => Math.abs(Number(amount)).toFixed(2);
        
        const haptic = (type = 'light') => {
            if (window.navigator && window.navigator.vibrate) {
                if (type === 'light') window.navigator.vibrate(10);
                else window.navigator.vibrate(20);
            }
        };

        const PLATFORMS = [
            { id: 'jd', name: '京东', keywords: ['京东', 'JD'], color: 'from-red-500 to-red-600', logo: 'https://logo.clearbit.com/jd.com', icon: ShoppingBag },
            { id: 'meituan', name: '美团', keywords: ['美团'], color: 'from-yellow-400 to-yellow-500', logo: 'https://logo.clearbit.com/meituan.com', icon: Utensils },
            { id: 'eleme', name: '饿了么', keywords: ['饿了么'], color: 'from-blue-400 to-blue-500', logo: 'https://logo.clearbit.com/ele.me', icon: Utensils }, 
            { id: 'douyin', name: '抖音', keywords: ['抖音', '字节'], color: 'from-zinc-900 to-black', logo: 'https://logo.clearbit.com/douyin.com', icon: Video },
            { id: 'taobao', name: '淘宝', keywords: ['淘宝', '天猫', 'Taobao', 'Tmall'], color: 'from-orange-500 to-orange-600', logo: 'https://logo.clearbit.com/taobao.com', icon: ShoppingBag },
            { id: 'pdd', name: '拼多多', keywords: ['拼多多'], color: 'from-red-600 to-rose-600', logo: 'https://logo.clearbit.com/pinduoduo.com', icon: ShoppingBag },
            { id: 'wechat', name: '微信', keywords: ['微信'], color: 'from-green-500 to-green-600', logo: 'https://logo.clearbit.com/wechat.com', icon: MessageCircle },
            { id: 'alipay', name: '支付宝', keywords: ['支付宝'], color: 'from-blue-500 to-blue-600', logo: 'https://logo.clearbit.com/alipay.com', icon: Wallet },
        ];

        const getCategoryIcon = (category) => {
            const size = 18;
            switch (category) {
                case '餐饮': return <Utensils size={size} />;
                case '交通': return <Car size={size} />;
                case '购物': return <ShoppingBag size={size} />;
                case '娱乐': return <Gamepad2 size={size} />;
                case '居住': return <HomeIcon size={size} />;
                case '医疗': return <HeartPulse size={size} />;
                case '工资': return <Banknote size={size} />;
                default: return <FileText size={size} />;
            }
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case '餐饮': return { bg: 'bg-orange-500/10 dark:bg-orange-500/20', text: 'text-orange-500 dark:text-orange-400', hex: '#fb923c' }; 
                case '交通': return { bg: 'bg-blue-500/10 dark:bg-blue-500/20', text: 'text-blue-500 dark:text-blue-400', hex: '#60a5fa' }; 
                case '购物': return { bg: 'bg-pink-500/10 dark:bg-pink-500/20', text: 'text-pink-500 dark:text-pink-400', hex: '#f472b6' }; 
                case '娱乐': return { bg: 'bg-purple-500/10 dark:bg-purple-500/20', text: 'text-purple-500 dark:text-purple-400', hex: '#c084fc' }; 
                case '居住': return { bg: 'bg-teal-500/10 dark:bg-teal-500/20', text: 'text-teal-600 dark:text-teal-400', hex: '#2dd4bf' }; 
                case '医疗': return { bg: 'bg-red-500/10 dark:bg-red-500/20', text: 'text-red-500 dark:text-red-400', hex: '#f87171' }; 
                case '工资': return { bg: 'bg-green-500/10 dark:bg-green-500/20', text: 'text-green-600 dark:text-green-400', hex: '#4ade80' }; 
                default: return { bg: 'bg-gray-200 dark:bg-zinc-700/40', text: 'text-gray-500 dark:text-zinc-400', hex: '#a1a1aa' };    
            }
        };

        const getDateRange = (date, viewMode) => {
            const d = new Date(date);
            switch (viewMode) {
                case 'day': return { start: new Date(d.setHours(0,0,0,0)), end: new Date(d.setHours(23,59,59,999)), label: `${d.getMonth()+1}月${d.getDate()}日` };
                case 'week': { const s = startOfWeek(d, { weekStartsOn: 1 }); const e = endOfWeek(d, { weekStartsOn: 1 }); return { start: s, end: e, label: `${s.getMonth()+1}.${s.getDate()}-${e.getMonth()+1}.${e.getDate()}` }; }
                case 'month': { const s = startOfMonth(d); const e = endOfMonth(d); return { start: s, end: e, label: `${d.getFullYear()}年 ${d.getMonth()+1}月` }; }
                case 'year': { const s = startOfYear(d); const e = endOfYear(d); return { start: s, end: e, label: `${d.getFullYear()}年` }; }
                default: return { start: d, end: d, label: '' };
            }
        };

        const BrandLogo = ({ url, fallbackIcon: Icon, name }) => {
            const [error, setError] = useState(false);
            const FallbackIcon = Icon || ShoppingBag; 
            
            if (error || !url) {
                return (
                    <div className="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center border border-white/5">
                        <FallbackIcon size={20} className="text-brand-text" />
                    </div>
                );
            }

            return (
                <div className="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center overflow-hidden border border-white/10">
                    <img src={url} alt={name} className="w-full h-full object-contain" onError={() => setError(true)} />
                </div>
            );
        };

        // --- Pages ---
        const EditorPage = ({ transaction, onClose, onSave, onDelete }) => {
            const [form, setForm] = useState({ 
                amount: transaction ? Math.abs(transaction.amount) : '', 
                merchant: transaction ? transaction.merchant : '', 
                category: transaction ? transaction.category : '餐饮', 
                date: transaction ? transaction.date.split('T')[0] : new Date().toISOString().split('T')[0], 
                note: transaction ? (transaction.note || '') : '' 
            });
            const [loading, setLoading] = useState(false);
            const categories = ['餐饮', '交通', '购物', '娱乐', '居住', '医疗', '工资', '其他'];

            const handleSave = async () => {
                if (!form.amount) return;
                setLoading(true);
                await onSave(form, transaction?.id);
                setLoading(false);
            };

            return (
                <div className="page-container page-enter pb-safe flex flex-col z-[100] bg-brand-bg ios-scroll">
                    <div className="glass-nav pt-safe flex justify-between items-center px-4 h-[44px]">
                        <button onClick={onClose} className="text-brand-subtext text-[15px]">取消</button>
                        <h3 className="font-bold text-[17px] text-brand-text">{transaction ? '编辑' : '记一笔'}</h3>
                        <button onClick={handleSave} className="text-brand-accent font-bold text-[15px]">保存</button>
                    </div>
                    
                    <div className="p-4 flex-1 overflow-y-auto ios-scroll">
                         <div className="bg-brand-card rounded-[20px] px-5 py-4 flex items-center mt-2 border border-brand-border focus-within:ring-2 focus-within:ring-brand-accent/20 transition-all shadow-sm mb-6">
                            <span className="text-[24px] text-brand-subtext mr-2 font-light">¥</span>
                            <input type="number" value={form.amount} onChange={(e) => setForm({...form, amount: e.target.value})} placeholder="0.00" className="w-full bg-transparent text-[32px] font-bold text-brand-text placeholder-gray-400 h-[40px] font-mono" autoFocus={!transaction} />
                        </div>

                        <h4 className="text-[13px] text-brand-subtext font-medium mb-3 ml-1 uppercase">分类</h4>
                        <div className="grid grid-cols-4 gap-3 mb-6">
                            {categories.map(cat => {
                                const color = getCategoryColor(cat);
                                const isSelected = form.category === cat;
                                return (
                                    <button key={cat} onClick={() => {setForm({...form, category: cat}); haptic('light');}} className={`flex flex-col items-center justify-center py-3 rounded-[18px] transition-all active:scale-95 duration-200 border ${isSelected ? `bg-brand-text text-brand-card shadow-lg` : 'bg-brand-input border-brand-border hover:opacity-80'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center mb-1.5 ${isSelected ? 'text-brand-accent bg-brand-card' : color.text}`}>
                                            {getCategoryIcon(cat)}
                                        </div>
                                        <span className={`text-[11px] font-bold ${isSelected ? 'text-brand-card' : 'text-brand-subtext'}`}>{cat}</span>
                                    </button>
                                );
                            })}
                        </div>

                        <h4 className="text-[13px] text-brand-subtext font-medium mb-3 ml-1 uppercase">详情</h4>
                        <div className="bg-brand-card rounded-2xl border border-brand-border overflow-hidden mb-6">
                            <div className="flex items-center px-4 py-3 border-b border-brand-border">
                                <span className="w-16 text-[15px] text-brand-subtext">商户</span>
                                <input type="text" value={form.merchant} onChange={(e) => setForm({...form, merchant: e.target.value})} placeholder="选填" className="flex-1 bg-transparent text-[15px] text-brand-text focus:outline-none" />
                            </div>
                            <div className="flex items-center px-4 py-3 border-b border-brand-border">
                                <span className="w-16 text-[15px] text-brand-subtext">日期</span>
                                <input type="date" value={form.date} onChange={(e) => setForm({...form, date: e.target.value})} className="flex-1 bg-transparent text-[15px] text-brand-text focus:outline-none" />
                            </div>
                            <div className="flex items-center px-4 py-3">
                                <span className="w-16 text-[15px] text-brand-subtext">备注</span>
                                <input type="text" value={form.note} onChange={(e) => setForm({...form, note: e.target.value})} placeholder="选填" className="flex-1 bg-transparent text-[15px] text-brand-text focus:outline-none" />
                            </div>
                        </div>

                        {transaction && (
                            <button onClick={() => onDelete(transaction.id)} className="w-full py-3.5 rounded-xl text-red-500 bg-brand-input font-medium text-[15px] mb-8">
                                删除记录
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const PlatformPage = ({ platform, currentDate, viewMode, allTransactions, onClose }) => {
            const list = useMemo(() => {
                const range = getDateRange(currentDate, viewMode);
                let filtered = allTransactions.filter(t => { 
                    const d = new Date(t.date); 
                    return d >= range.start && d <= range.end; 
                });

                if (platform.isOther) {
                    filtered = filtered.filter(t => !PLATFORMS.some(p => p.keywords.some(k => t.merchant && t.merchant.includes(k))));
                } else {
                    filtered = filtered.filter(t => platform.keywords.some(k => t.merchant && t.merchant.includes(k)));
                }
                return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [platform, currentDate, viewMode, allTransactions]);

            const total = list.reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);

            const grouped = useMemo(() => {
                const g = {};
                list.forEach(t => {
                    const d = new Date(t.date).toLocaleDateString();
                    if(!g[d]) g[d] = [];
                    g[d].push(t);
                });
                return g;
            }, [list]);

            return (
                <div className="page-container page-enter pb-safe flex flex-col z-[100] bg-brand-bg ios-scroll">
                    <div className="glass-nav pt-safe flex items-center px-4 h-[44px] sticky top-0 z-10">
                        <button onClick={onClose} className="p-2 -ml-2 text-brand-text"><ArrowLeft size={22} /></button>
                        <h3 className="font-bold text-[17px] flex-1 text-center pr-8 text-brand-text">{platform.name}账单</h3>
                    </div>

                    <div className="p-4 overflow-y-auto flex-1 ios-scroll">
                        <div className={`p-6 rounded-[24px] bg-gradient-to-br ${platform.color} text-white shadow-lg mb-6 relative overflow-hidden`}>
                            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl pointer-events-none -mr-10 -mt-10"></div>
                            <div className="relative z-10">
                                <div className="text-[13px] opacity-80 mb-1 font-medium">
                                    {viewMode === 'year' ? `${currentDate.getFullYear()}年` : `${currentDate.getMonth()+1}月`}总支出
                                </div>
                                <div className="text-[36px] font-bold font-mono">¥{formatMoney(total)}</div>
                                <div className="text-[12px] opacity-70 mt-2">{list.length} 笔交易</div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {Object.entries(grouped).length === 0 ? (
                                <div className="text-center py-20 text-brand-subtext">暂无记录</div>
                            ) : (
                                Object.entries(grouped).map(([date, items]) => (
                                    <div key={date}>
                                        <div className="text-[13px] text-brand-subtext mb-2 ml-2 font-medium">{date}</div>
                                        <div className="bg-brand-card rounded-2xl overflow-hidden border border-brand-border">
                                            {items.map((t, idx) => (
                                                <div key={t.id} className="flex items-center p-4 border-b border-brand-border last:border-0">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text}`}>
                                                        {getCategoryIcon(t.category)}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between mb-0.5">
                                                            <span className="text-[15px] font-medium text-brand-text">{t.merchant}</span>
                                                            <span className="text-[15px] font-bold font-mono text-brand-text">-{formatMoney(t.amount)}</span>
                                                        </div>
                                                        <div className="text-[12px] text-brand-subtext">{t.note || t.category}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const WheelPicker = ({ items, value, onChange, label }) => {
            const scrollerRef = useRef(null);
            const itemHeight = 40;
            useEffect(() => {
                if (scrollerRef.current && items.length > 0) {
                    const index = items.indexOf(value);
                    if (index > -1) {
                         setTimeout(() => { if(scrollerRef.current) scrollerRef.current.scrollTop = index * itemHeight; }, 10);
                         setTimeout(() => { if(scrollerRef.current) scrollerRef.current.scrollTop = index * itemHeight; }, 100);
                    }
                }
            }, [value]);
            const handleScroll = (e) => {
                clearTimeout(scrollerRef.current.scrollTimeout);
                scrollerRef.current.scrollTimeout = setTimeout(() => {
                    const index = Math.round(e.target.scrollTop / itemHeight);
                    if (index >= 0 && index < items.length && items[index] !== value) onChange(items[index]);
                }, 100);
            };
            return (
                <div className="h-[200px] relative flex-1 overflow-hidden group">
                    <div ref={scrollerRef} className="h-full overflow-y-auto snap-y snap-mandatory no-scrollbar py-[80px]" style={{ touchAction: 'pan-y', overscrollBehaviorY: 'contain' }} onScroll={handleScroll}>
                        {items.map((item) => (
                            <div key={item} className={`h-[40px] flex items-center justify-center snap-center text-[17px] transition-all duration-200 ${item === value ? 'font-semibold text-brand-text scale-110' : 'text-brand-subtext/60 scale-95'}`}>
                                <span className="pt-0.5 translate-y-[2px] leading-none">{item}{label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DatePickerModal = ({ onClose, currentDate, onDateSelect }) => {
            const today = new Date();
            const maxYear = today.getFullYear();
            const maxMonth = today.getMonth() + 1;
            const [y, setY] = useState(currentDate.getFullYear());
            const [m, setM] = useState(currentDate.getMonth() + 1);
            const years = Array.from({length: 11}, (_, i) => maxYear - i).reverse();
            const monthLimit = (y === maxYear) ? maxMonth : 12;
            const months = Array.from({length: monthLimit}, (_, i) => i + 1);
            useEffect(() => { if (!months.includes(m)) setM(months[months.length - 1]); }, [y, m, months]);
            
            const stopPropagation = (e) => e.stopPropagation();

            return (
                <div className="fixed inset-0 z-[70] flex items-end justify-center" onTouchStart={stopPropagation} onTouchMove={stopPropagation} onTouchEnd={stopPropagation}>
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="relative w-full sm:max-w-md bg-brand-card rounded-t-[28px] shadow-2xl overflow-hidden flex flex-col animate-slide-up border-t border-brand-border sm:m-4 pb-safe">
                        <div className="flex justify-between items-center px-6 pt-5 pb-2"><button onClick={onClose} className="text-[15px] text-brand-subtext hover:text-brand-text transition-colors">取消</button><h3 className="text-[17px] font-bold text-brand-text">选择月份</h3><button onClick={()=>{onDateSelect(new Date(y, m-1, 1)); onClose()}} className="text-[15px] font-bold text-brand-accent">确定</button></div>
                        <div className="relative px-6 pb-6 pt-2">
                            <div className="absolute top-1/2 left-4 right-4 h-[34px] -translate-y-1/2 bg-gray-200/80 dark:bg-white/10 rounded-lg pointer-events-none z-0"></div>
                            <div className="flex relative z-10 w-full overflow-hidden"><WheelPicker items={years} value={y} onChange={setY} label="年" /><WheelPicker items={months} value={m} onChange={setM} label="月" /></div>
                            <div className="absolute top-0 left-0 right-0 h-[80px] bg-gradient-to-b from-brand-card to-transparent pointer-events-none z-20"></div>
                            <div className="absolute bottom-0 left-0 right-0 h-[80px] bg-gradient-to-t from-brand-card to-transparent pointer-events-none z-20"></div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const InteractiveLineChart = ({ data, totalExpense }) => {
            const maxVal = Math.max(...data.map(d => d.value), 10);
            const points = data.map((d, i) => {
                const x = data.length > 1 ? (i / (data.length - 1)) * 100 : 50;
                const y = 100 - (d.value / maxVal) * 80;
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="glass-card rounded-[28px] p-6 select-none relative overflow-hidden group transition-colors duration-300">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-brand-accent/5 rounded-full blur-3xl pointer-events-none"></div>
                    <div className="mb-6 flex flex-col items-center h-[50px] justify-center relative z-10">
                        <span className="text-[12px] text-brand-subtext font-medium tracking-wide uppercase mb-1">本月总支出</span>
                        <span className="text-[34px] font-bold text-brand-text font-mono tracking-tight">¥{formatMoney(totalExpense)}</span>
                    </div>
                    <div className="relative h-[160px] w-full" style={{ touchAction: 'pan-y' }}> {/* Allow vertical scroll */}
                        <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                            <defs><linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#2E5CFF" stopOpacity="0.5" /><stop offset="100%" stopColor="#2E5CFF" stopOpacity="0" /></linearGradient></defs>
                            <path d={`M 0,${100 - (data[0]?.value/maxVal)*80 || 100} L ${points.split(' ').map(p=>`L ${p.replace(',',' ')}`).join(' ')} L 100,100 L 0,100 Z`} fill="url(#chartGradient)" />
                            <polyline points={points} fill="none" stroke="#2E5CFF" strokeWidth="2.5" vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                    </div>
                </div>
            );
        };
        
        const Toast = ({ message, type }) => {
            if (!message) return null;
            return <div className="fixed top-safe left-1/2 -translate-x-1/2 z-[100] mt-4 animate-fade-in pointer-events-none"><div className={`flex items-center gap-3 px-5 py-3 rounded-full shadow-xl backdrop-blur-xl border border-white/10 ${type === 'error' ? 'bg-red-100 text-red-600 dark:bg-red-500/20 dark:text-red-400' : 'bg-white text-black dark:bg-zinc-800 dark:text-white'}`}><CheckCircle size={18} className="text-brand-accent" /><span className="text-[13px] font-medium">{message}</span></div></div>;
        };

        // --- Main App ---

        function App() {
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            const mainScrollRef = useRef(null);
            
            const [view, setView] = useState({ name: 'main' }); // Router State
            
            const [homeViewMode, setHomeViewMode] = useState('month'); 
            const [pieViewMode, setPieViewMode] = useState('month'); 
            
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
            const [toast, setToast] = useState({ message: '', type: '' });
            const [searchQuery, setSearchQuery] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            const [pullY, setPullY] = useState(0);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const startY = useRef(0);
            
            useEffect(() => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) setIsDarkMode(true);
            }, []);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                haptic(type === 'error' ? 'error' : 'success');
                setTimeout(() => setToast({ message: '', type: '' }), 2500);
            };

            useEffect(() => {
                fetchTransactions();
                const sub = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, fetchTransactions).subscribe();
                return () => supabase.removeChannel(sub);
            }, [currentDate, pieViewMode, activeTab]);

            const fetchTransactions = async () => {
                if (!isRefreshing) setLoading(true);
                const monthRange = getDateRange(currentDate, 'month');
                const statsRange = getDateRange(currentDate, pieViewMode);
                const start = new Date(Math.min(monthRange.start, statsRange.start));
                const end = new Date(Math.max(monthRange.end, statsRange.end));
                const { data, error } = await supabase.from('transactions').select('*').gte('date', start.toISOString()).lte('date', end.toISOString()).order('date', { ascending: false });
                if (!error) setTransactions(data || []);
                setLoading(false);
            };

            // Touch Handlers (Updated for Scroll Container)
            const handleTouchStart = (e) => { 
                if (view.name === 'main' && mainScrollRef.current && mainScrollRef.current.scrollTop === 0) {
                    startY.current = e.touches[0].clientY;
                }
            };
            
            const handleTouchMove = (e) => {
                if (view.name !== 'main') return;
                const y = e.touches[0].clientY;
                const delta = y - startY.current;
                // Only allow pull if at very top of scroll container
                if (mainScrollRef.current && mainScrollRef.current.scrollTop === 0 && delta > 0) {
                    setPullY(delta * 0.4);
                }
            };

            const handleTouchEnd = async () => {
                if (pullY > 60) {
                    setIsRefreshing(true); setPullY(60); haptic('medium');
                    await fetchTransactions(); haptic('success');
                    setTimeout(() => { setIsRefreshing(false); setPullY(0); }, 500);
                } else setPullY(0);
            };

            const handleDateSelect = (date) => {
                setCurrentDate(date);
                haptic('success');
            };

            const handleSave = async (data, id) => { /* ... implemented in EditorPage ... */ };
            const handleDelete = async (id) => { /* ... implemented in EditorPage ... */ };

            // Calculations
            const totalExpense = useMemo(() => {
                const range = getDateRange(currentDate, 'month');
                return transactions.filter(t => new Date(t.date) >= range.start && new Date(t.date) <= range.end).reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);
            }, [transactions, currentDate]);

            const todayExpense = useMemo(() => {
                const todayStr = new Date().toDateString();
                return transactions.filter(t => new Date(t.date).toDateString() === todayStr).reduce((sum, t) => sum + Math.abs(Number(t.amount)), 0);
            }, [transactions]);

            const lineChartData = useMemo(() => {
                const range = getDateRange(currentDate, 'month');
                const daysInMonth = range.end.getDate();
                const points = [];
                for(let i=1; i<=daysInMonth; i++) {
                    let val = 0;
                    transactions.forEach(t => { const d = new Date(t.date); if(d >= range.start && d <= range.end && d.getDate() === i) val += Math.abs(Number(t.amount)); });
                    points.push({ label: `${i}`, value: val, date: new Date(currentDate.getFullYear(), currentDate.getMonth(), i) });
                }
                return points;
            }, [transactions, currentDate]);

            const platformStats = useMemo(() => {
                const range = getDateRange(currentDate, pieViewMode);
                const filtered = transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
                const stats = {};
                PLATFORMS.forEach(p => stats[p.name] = { ...p, value: 0 });
                let otherTotal = 0;
                filtered.forEach(t => {
                    const amount = Math.abs(Number(t.amount));
                    let matched = false;
                    for (const p of PLATFORMS) {
                        if (p.keywords.some(k => t.merchant && t.merchant.includes(k))) { stats[p.name].value += amount; matched = true; break; }
                    }
                    if (!matched) otherTotal += amount;
                });
                const sorted = Object.values(stats).filter(p => p.value > 0).sort((a, b) => b.value - a.value);
                if (otherTotal > 0) sorted.push({ id: 'other', name: '其他商户', value: otherTotal, color: 'from-zinc-500 to-zinc-600', isOther: true, icon: LayoutGrid });
                return { data: sorted };
            }, [transactions, currentDate, pieViewMode]);

            const filteredTransactions = useMemo(() => {
                const range = getDateRange(currentDate, 'month');
                let list = transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
                if (searchQuery) list = list.filter(t => t.merchant?.includes(searchQuery) || t.note?.includes(searchQuery));
                return list;
            }, [transactions, searchQuery, currentDate]);

            const groupedTransactions = useMemo(() => {
                const groups = {};
                filteredTransactions.forEach(t => {
                    const date = new Date(t.date);
                    const today = new Date();
                    let header = `${date.getMonth() + 1}月${date.getDate()}日`;
                    if (date.toDateString() === today.toDateString()) header = "今天";
                    if (!groups[header]) groups[header] = { total: 0, items: [] };
                    groups[header].items.push(t);
                    groups[header].total += Math.abs(Number(t.amount));
                });
                return groups;
            }, [filteredTransactions]);

            const headerLabel = useMemo(() => {
                return `${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`;
            }, [currentDate]);

            const categoryStats = useMemo(() => {
                const stats = {};
                let sum = 0;
                const range = getDateRange(currentDate, pieViewMode);
                const filtered = transactions.filter(t => { const d = new Date(t.date); return d >= range.start && d <= range.end; });
                filtered.forEach(t => {
                    const val = Math.abs(Number(t.amount));
                    if (!stats[t.category]) stats[t.category] = 0;
                    stats[t.category] += val;
                    sum += val;
                });
                return {
                    data: Object.entries(stats).map(([name, value]) => ({ name, value, displayValue: formatMoney(value), percent: sum !== 0 ? ((value / sum) * 100).toFixed(1) : "0.0" })).sort((a, b) => b.value - a.value),
                    total: sum
                };
            }, [transactions, currentDate, pieViewMode]);

            const pieGradient = useMemo(() => {
                if (categoryStats.data.length === 0) return 'conic-gradient(var(--bg-input) 0% 100%)';
                let gradient = 'conic-gradient(';
                let currentPercent = 0;
                categoryStats.data.forEach((item) => {
                    const color = getCategoryColor(item.name).hex;
                    const nextPercent = currentPercent + parseFloat(item.percent);
                    gradient += `${color} ${currentPercent}% ${nextPercent}%, `;
                    currentPercent = nextPercent;
                });
                return gradient.slice(0, -2) + ')';
            }, [categoryStats, isDarkMode]);

            // --- Views ---
            if (view.name === 'editor') return <EditorPage transaction={view.transaction} onClose={()=>setView({name:'main'})} onSave={async(d,id)=>{id?await supabase.from('transactions').update(d).eq('id',id):await supabase.from('transactions').insert([d]); await fetchTransactions(); setView({name:'main'});}} onDelete={async(id)=>{await supabase.from('transactions').delete().eq('id',id); await fetchTransactions(); setView({name:'main'});}} />;
            if (view.name === 'platform') return <PlatformPage platform={view.platform} currentDate={currentDate} viewMode={pieViewMode} allTransactions={transactions} onClose={()=>setView({name:'main'})} />;

            return (
                <div className="absolute inset-0 flex flex-col overflow-hidden" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <Toast message={toast.message} type={toast.type} />
                    
                    {isDatePickerOpen && <DatePickerModal onClose={() => setIsDatePickerOpen(false)} currentDate={currentDate} onDateSelect={(d) => { setCurrentDate(d); haptic('success'); }} />}

                    <div className="fixed top-[120px] left-0 w-full flex justify-center pointer-events-none z-[100] transition-opacity duration-300" style={{ transform: `translateY(${pullY * 0.5}px)`, opacity: pullY > 20 ? 1 : 0 }}>
                        <div className="bg-brand-card p-3 rounded-full backdrop-blur-md shadow-2xl border border-brand-border"><Loader2 className={`text-brand-accent ${isRefreshing ? 'animate-spin' : ''}`} size={24} style={{ transform: `rotate(${pullY * 2}deg)` }} /></div>
                    </div>

                    <header className="fixed top-0 w-full glass-nav z-40 pt-safe transition-all duration-300">
                        <div className="flex justify-between items-center px-5 h-[44px] max-w-md mx-auto">
                            {showSearch ? (
                                <div className="flex items-center w-full animate-fade-in">
                                    <div className="flex-1 bg-brand-input rounded-xl flex items-center px-3 py-2 mr-3 transition-all"><Search size={16} className="text-brand-subtext mr-2" /><input autoFocus type="text" placeholder="搜索..." className="bg-transparent border-none text-[14px] text-brand-text placeholder-gray-400 w-full p-0" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                                    <button onClick={() => { setShowSearch(false); setSearchQuery(''); }} className="text-brand-accent text-[15px]">取消</button>
                                </div>
                            ) : (
                                <>
                                    <div className="w-[32px]"></div>
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center gap-1 cursor-pointer bg-brand-input/50 px-3 py-0.5 rounded-lg active:scale-95 transition-all" onClick={() => { setIsDatePickerOpen(true); haptic('light'); }}> 
                                            <h2 className="text-[17px] font-bold text-brand-text tracking-tight">{headerLabel}</h2><ChevronDown size={14} className="text-brand-subtext" />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-brand-subtext hover:text-brand-text transition-colors active:scale-90">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                                        {activeTab === 'home' && <button onClick={() => setShowSearch(true)} className="p-2 text-brand-accent hover:opacity-70 transition-opacity active:scale-90"><Search size={22} /></button>}
                                    </div>
                                </>
                            )}
                        </div>
                    </header>
                    
                    {/* SCROLLABLE MAIN CONTAINER */}
                    <main 
                        ref={mainScrollRef}
                        className="flex-1 overflow-y-auto pt-[50px] pb-24 px-4 no-scrollbar transition-transform duration-300 ease-out ios-scroll" 
                        style={{ transform: `translateY(${pullY}px)` }}
                    >
                        {activeTab === 'home' && (
                            <div className="animate-fade-in max-w-md mx-auto">
                                {!showSearch && (
                                    <div className="relative overflow-hidden rounded-[32px] bg-white dark:bg-gradient-to-br dark:from-[#1c1c1e] dark:to-[#121212] border border-brand-border p-6 mb-6 shadow-xl shadow-gray-200/50 dark:shadow-none group transition-all duration-300">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-brand-accent/10 rounded-full blur-3xl pointer-events-none group-hover:bg-brand-accent/20 transition-all duration-700 opacity-0 dark:opacity-100"></div>
                                        <div className="relative z-10">
                                            <p className="text-brand-subtext text-[13px] font-medium uppercase tracking-wide mb-1">今日支出</p>
                                            <h2 className="text-[40px] font-bold text-brand-text tracking-tight flex items-baseline mb-4 font-mono"><span className="text-[24px] mr-1 text-brand-subtext font-normal">¥</span>{formatMoney(todayExpense)}</h2>
                                            <div className="flex justify-between items-center text-[12px] font-medium text-brand-subtext pt-4 border-t border-brand-border"><span>本月累计 ¥{formatMoney(totalExpense)}</span><span>日均 ¥{Math.round(totalExpense / Math.max(1, new Date().getDate()))}</span></div>
                                        </div>
                                        <button onClick={() => { setView({ name: 'editor', transaction: null }); haptic('light'); }} className="absolute right-6 top-6 w-12 h-12 bg-brand-accent text-white rounded-full flex items-center justify-center shadow-lg shadow-brand-accent/30 active:scale-90 transition-transform"><Plus size={24} /></button>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    {loading && !isRefreshing ? <div className="flex justify-center py-12"><Loader2 className="animate-spin text-brand-subtext" /></div> : 
                                    Object.keys(groupedTransactions).length === 0 ? <div className="text-center py-20 opacity-50 flex flex-col items-center"><div className="w-16 h-16 bg-brand-input rounded-full flex items-center justify-center mb-4"><FileText size={24} className="text-brand-subtext" /></div><p className="text-[14px] text-brand-subtext">暂无记录</p></div> : 
                                    Object.entries(groupedTransactions).map(([header, group]) => (
                                        <div key={header}>
                                            <div className="flex justify-between items-baseline px-4 mb-2"><h3 className="text-[13px] font-semibold text-brand-subtext uppercase tracking-wide">{header}</h3><span className="text-[12px] text-brand-subtext font-mono">¥{formatMoney(group.total)}</span></div>
                                            <div className="glass-card rounded-[24px] overflow-hidden">
                                                {group.items.map((t, idx) => (
                                                    <div key={t.id} className="relative group">
                                                        <button onClick={() => setView({ name: 'editor', transaction: t })} className="w-full flex items-center px-5 py-4 hover:bg-black/5 dark:hover:bg-white/5 active:opacity-70 transition-colors text-left">
                                                            <div className={`w-10 h-10 rounded-2xl flex items-center justify-center mr-4 ${getCategoryColor(t.category).bg} ${getCategoryColor(t.category).text} shadow-sm`}>{getCategoryIcon(t.category)}</div>
                                                            <div className="flex-1 min-w-0 mr-3"><p className="text-[16px] font-medium text-brand-text truncate mb-0.5">{t.merchant || t.category}</p><p className="text-[13px] text-brand-subtext truncate">{t.note || t.category}</p></div>
                                                            <div className="text-right"><p className="text-[16px] font-bold text-brand-text font-mono">{formatMoney(t.amount)}</p></div>
                                                        </button>
                                                        {idx !== group.items.length - 1 && <div className="absolute bottom-0 left-[76px] right-0 h-[1px] bg-brand-border"></div>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeTab === 'stats' && (
                           <div className="animate-fade-in space-y-6 max-w-md mx-auto">
                             <div className="glass-card rounded-[32px] p-2">
                                <div className="flex items-center justify-between mb-2 px-5 pt-4"><h3 className="text-[13px] font-semibold text-brand-subtext uppercase tracking-wide flex items-center gap-2"><TrendingUp size={14} className="text-brand-accent" /> 趋势</h3></div>
                                <div className="px-1 pb-1"><InteractiveLineChart data={lineChartData} totalExpense={totalExpense} /></div>
                             </div>

                             {platformStats.data.length > 0 && (
                                <div className="glass-card rounded-[32px] p-5">
                                    <div className="flex items-center justify-between mb-4 px-1"><h3 className="text-[13px] font-semibold text-brand-subtext uppercase tracking-wide flex items-center gap-2"><ShoppingBag size={14} className="text-brand-accent" /> 品牌消费</h3></div>
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2 ios-scroll">
                                        {platformStats.data.map(p => (
                                            <button key={p.id} onClick={() => setView({ name: 'platform', platform: p })} className={`flex-shrink-0 w-32 p-4 rounded-[24px] bg-gradient-to-br ${p.color} text-white shadow-lg relative overflow-hidden group active:scale-95 transition-transform text-left`}>
                                                <div className="absolute -right-3 -bottom-3 opacity-20 transform rotate-12 scale-150 grayscale"><BrandLogo url={p.logo} fallbackIcon={p.icon} name={p.name} /></div>
                                                <div className="relative z-10">
                                                    <BrandLogo url={p.logo} fallbackIcon={p.icon} name={p.name} />
                                                    <div className="text-[13px] font-medium opacity-90 mt-2 mb-0.5 truncate">{p.name}</div>
                                                    <div className="text-[16px] font-bold font-mono">¥{formatMoney(p.value)}</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                             )}
                             
                             <div className="glass-card rounded-[32px] p-6 flex flex-col items-center">
                                <div className="flex bg-brand-input p-1 rounded-xl w-full mb-8 max-w-[280px] border border-brand-border shadow-inner">
                                    {['day', 'week', 'month', 'year'].map(mode => <button key={mode} onClick={() => { setPieViewMode(mode); haptic('light'); }} className={`flex-1 py-1.5 text-[12px] font-medium rounded-lg transition-all duration-300 ${pieViewMode === mode ? 'bg-white dark:bg-zinc-700 text-brand-text shadow-sm' : 'text-brand-subtext hover:text-brand-text'}`}>{{day:'日', week:'周', month:'月', year:'年'}[mode]}</button>)}
                                </div>
                                <div className="w-56 h-56 rounded-full relative flex items-center justify-center mb-8 shadow-lg ring-1 ring-brand-border" style={{ background: pieGradient }}>
                                    <div className="w-44 h-44 bg-brand-card rounded-full flex flex-col items-center justify-center shadow-inner z-10 transition-colors duration-300">
                                        <span className="text-brand-subtext text-[11px] font-semibold uppercase tracking-wider mb-1">{pieViewMode === 'day' ? '今日' : pieViewMode === 'week' ? '本周' : pieViewMode === 'year' ? '今年' : '本月'}</span>
                                        <span className="text-brand-text text-[28px] font-bold font-mono tracking-tight">¥{Math.round(categoryStats.total)}</span>
                                    </div>
                                </div>
                                <div className="w-full space-y-3">
                                    {categoryStats.data.map((cat, idx) => {
                                        const color = getCategoryColor(cat.name);
                                        return (
                                            <div key={cat.name} className="flex items-center gap-4 p-3 rounded-2xl hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                                                <div className={`w-10 h-10 rounded-2xl flex items-center justify-center ${color.bg} ${color.text} ring-1 ring-white/5`}>{getCategoryIcon(cat.name)}</div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-center text-[14px] mb-2"><span className="font-medium text-brand-text">{cat.name}</span><div className="flex items-baseline gap-2"><span className="font-bold text-brand-text font-mono">¥{cat.displayValue}</span><span className="text-[12px] text-brand-subtext w-10 text-right font-mono">{cat.percent}%</span></div></div>
                                                    <div className="h-1.5 bg-brand-input rounded-full overflow-hidden w-full border border-brand-border"><div className={`h-full rounded-full transition-all duration-1000 ease-out`} style={{ width: `${cat.percent}%`, backgroundColor: color.hex }}></div></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                             </div>
                           </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 w-full glass-tab z-50 pb-safe pt-2">
                        <div className="grid grid-cols-2 h-[50px] relative">
                            <button onClick={() => {setActiveTab('home'); haptic('light');}} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab==='home' ? 'text-brand-accent' : 'text-brand-subtext hover:text-brand-text'}`}><Home size={22} strokeWidth={activeTab==='home' ? 3 : 2} /><span className="text-[10px] font-medium">明细</span></button>
                            <button onClick={() => {setActiveTab('stats'); haptic('light');}} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab==='stats' ? 'text-brand-accent' : 'text-brand-subtext hover:text-brand-text'}`}><PieChart size={22} strokeWidth={activeTab==='stats' ? 3 : 2} /><span className="text-[10px] font-medium">分析</span></button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
